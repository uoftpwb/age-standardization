---
title: "age-standardized-markdown"
output: html_document
date: "2023-10-27"
---

The following code will run the neccesary analysis code  for the Age Standardization of Wellbeing project by Makoto Takahara, Anthony McCanny and Felix Cheung. 

Running this file straight thorugh from beginning to end should succesfully complete all analysis. 

The required file structure for running this code is a parent folder which includes three folders "Data", "Output" and "age-standardization", the latter of which will hold the code including the file you are currently reading. "Data" requires the files that are listed in the Data folder on the Sharepoint for internal users of this code, and the files in the Data file of the replication package for external users.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load required packages
library(dplyr)
library(tidyr)
library(fixest)
library(countrycode)
library(ggalluvial)
library(reshape2)
library(data.table)
library(GGally)
library(maps)
library(viridis)
library(multcomp)

knitr::opts_knit$set(root.dir = dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
```

**Replicating World Happiness Report 2023, Chapter 2**
Our final intention is to replicate the aggregation and visualization methods in Chapter 2 of the World Happiness Report 2023 but with age standardized averages instead of global averages.

In order to accomplish this we need to backwards engineer the exact code required to replicate their process. We do this first to verify the method, and then replicate with age-standardized averages in the next section.


### Reading WHR Data
```{r}
# Set working directory to the parent directory of the current directory this file is in, then load the World Happiness Report data from the CSV file. 
# Add COUNTRY_ISO3 for merging. Kosovo is added manually. 
# Rename Life.Ladder to WHR_score.
WHR_data_across_years <- read.csv("Data/WHR2023Table.csv") %>%  
  mutate(COUNTRY_ISO3 = ifelse(Country.name == "Kosovo", "XKX", countrycode(Country.name, 'country.name', 'iso3c'))) %>% 
  rename(WHR_score = Life.Ladder)
  
# Create a summary of life ladder and raw data for predictors, using weighted mean
# Filter the data for the years 2020 to 2022, group the data by country name, and calculate the weighted mean for each predictor, removing NA values
# Also add COUNTRY_ISO3 for merging. Kosovo is added manually. 
WHR_summary <- WHR_data_across_years %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(WHR_score = weighted.mean(WHR_score, n),
            Log.GDP.per.capita = weighted.mean(Log.GDP.per.capita, n, na.rm = TRUE),
            Social.support = weighted.mean(Social.support, n, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = weighted.mean(Healthy.life.expectancy.at.birth, n, na.rm = TRUE),
            Freedom.to.make.life.choices = weighted.mean(Freedom.to.make.life.choices, n, na.rm = TRUE),
            Generosity = weighted.mean(Generosity, n, na.rm = TRUE),
            Perceptions.of.corruption = weighted.mean(Perceptions.of.corruption, n, na.rm = TRUE)) %>% 
  mutate(WHR_rank = rank(-WHR_score),
         COUNTRY_ISO3 = ifelse(Country.name == "Kosovo", "XKX", countrycode(Country.name, 'country.name', 'iso3c')))
```


### Regression of Life Ladder to 6 predictors

Following the approach of the World Happiness Report 2023 we run a regression of life satisfaction on the six determinants of well-being suggested in the report, introducing fixed effects for year and clustering standard errors by country.

```{r}
# Run a fixed effects regression model using the 'feols' function from the 'fixest' package.
WHR_regression <- feols(
  # The dependent variable is 'WHR_score'.
  WHR_score ~ 
  # The independent variables are six determinants of well-being.
  Log.GDP.per.capita +
  Social.support +
  Healthy.life.expectancy.at.birth +
  Freedom.to.make.life.choices +
  Generosity +
  Perceptions.of.corruption |
  # Introduce fixed effects for 'year'.
  year, 
  # The data source is 'WHR_data_across_years'.
  data = WHR_data_across_years
)

# Display the summary of the regression model, clustering standard errors by country
summary(WHR_regression, cluster = "Country.name")
```


### Creating Dystopia

In the presentation of the WHR2023 data, the contribution to wellbeing from each factor is calculated as the difference from the contribution for the country with the lowest level of that factor (or the highest if the effect is negative). We calculate that value here.

```{r}
# Reading the cleaned Gallup World Poll data "DataForFigure2.1WHR2023.xls" from the "Data" directory
WHR_data_fig <- readxl::read_excel("Data/DataForFigure2.1WHR2023.xls")%>%
  # Renaming the columns to more convenient names
  rename(
    Country.name = `Country name`,
    WHR_score = `Ladder score`,
    Log.GDP.per.capita = `Logged GDP per capita`,
    Social.support = `Social support`,
    Healthy.life.expectancy.at.birth = `Healthy life expectancy`,
    Freedom.to.make.life.choices = `Freedom to make life choices`,
    Generosity = Generosity,
    Perceptions.of.corruption = `Perceptions of corruption`,
    Log.GDP.per.capita.cont = `Explained by: Log GDP per capita`,
    Social.support.cont = `Explained by: Social support`,
    Healthy.life.expectancy.at.birth.cont = `Explained by: Healthy life expectancy`,
    Freedom.to.make.life.choices.cont = `Explained by: Freedom to make life choices`,
    Generosity.cont = `Explained by: Generosity`,
    Perceptions.of.corruption.cont = `Explained by: Perceptions of corruption`
  ) %>%
# Adding a new row named "Dystopia" with minimum values for each column (except for Perceptions.of.corruption, where we take the maximum because the coefficient is negative)
  add_row(
    Country.name = "Dystopia",
    Log.GDP.per.capita = min(.$Log.GDP.per.capita, na.rm = TRUE),
    Social.support = min(.$Social.support, na.rm = TRUE),
    Healthy.life.expectancy.at.birth = min(.$Healthy.life.expectancy.at.birth, na.rm = TRUE),
    Freedom.to.make.life.choices = min(.$Freedom.to.make.life.choices, na.rm = TRUE),
    Generosity = min(.$Generosity, na.rm = TRUE),
    Perceptions.of.corruption = max(.$Perceptions.of.corruption, na.rm = TRUE)
  ) %>% 
  mutate(COUNTRY_ISO3 = ifelse(Country.name == "Kosovo", "XKX", countrycode(Country.name, 'country.name', 'iso3c'))) %>% 
# Impute values for Palestine
  mutate(
    Healthy.life.expectancy.at.birth = ifelse(Country.name == "State of Palestine", 0.292 / coef(WHR_regression)["Healthy.life.expectancy.at.birth"] + min(.$Healthy.life.expectancy.at.birth, na.rm = TRUE), Healthy.life.expectancy.at.birth),
    Healthy.life.expectancy.at.birth.cont = ifelse(Country.name == "State of Palestine", 0.292, Healthy.life.expectancy.at.birth.cont),
    `Dystopia + residual` = ifelse(Country.name == "State of Palestine", 1.614, `Dystopia + residual`)
  )
```

### Check that our calculations for means and contributions match those reported in the summary table by WHR2023

```{r}
# We calculate the contribution to wellbeing from each factor as the difference from the contribution for the country with the lowest level of that factor (or the highest if the effect is negative)
# We then merge this data with the WHR_data_fig data frame
merged_data <- WHR_summary %>%
  mutate(Log.GDP.per.capita.cont = (Log.GDP.per.capita - min(WHR_data_fig$Log.GDP.per.capita, na.rm = TRUE)) * coef(WHR_regression)["Log.GDP.per.capita"],
         Social.support.cont = (Social.support - min(WHR_data_fig$Social.support, na.rm = TRUE)) * coef(WHR_regression)["Social.support"],
         Healthy.life.expectancy.at.birth.cont = (Healthy.life.expectancy.at.birth - min(WHR_data_fig$Healthy.life.expectancy.at.birth, na.rm = TRUE)) * coef(WHR_regression)["Healthy.life.expectancy.at.birth"],
         Freedom.to.make.life.choices.cont = (Freedom.to.make.life.choices - min(WHR_data_fig$Freedom.to.make.life.choices, na.rm = TRUE)) * coef(WHR_regression)["Freedom.to.make.life.choices"],
         Generosity.cont = (Generosity - min(WHR_data_fig$Generosity, na.rm = TRUE)) * coef(WHR_regression)["Generosity"],
         Perceptions.of.corruption.cont = (Perceptions.of.corruption - max(WHR_data_fig$Perceptions.of.corruption, na.rm = TRUE)) * coef(WHR_regression)["Perceptions.of.corruption"]) %>%
  merge(WHR_data_fig, by.x = "Country.name", by.y = "Country.name", all = TRUE)

# We calculate the difference between the WHR reported and the calculated values for each determinant of wellbeing
# We then summarize these differences, calculating the mean and max difference, and the country with the max difference for each determinant
comparison <- merged_data %>% 
  drop_na() %>%
  mutate(Difference.Life.Ladder = WHR_score.x - WHR_score.y,
         Difference.Log.GDP.per.capita = Log.GDP.per.capita.x - Log.GDP.per.capita.y,
         Difference.Social.support = Social.support.x - Social.support.y,
         Difference.Healthy.life.expectancy.at.birth = Healthy.life.expectancy.at.birth.x - Healthy.life.expectancy.at.birth.y,
         Difference.Freedom.to.make.life.choices = Freedom.to.make.life.choices.x - Freedom.to.make.life.choices.y,
         Difference.Generosity = Generosity.x - Generosity.y,
         Difference.Perceptions.of.corruption = Perceptions.of.corruption.x - Perceptions.of.corruption.y,
         Difference.Log.GDP.per.capita.cont = Log.GDP.per.capita.cont.x - Log.GDP.per.capita.cont.y,
         Difference.Social.support.cont = Social.support.cont.x - Social.support.cont.y,
         Difference.Healthy.life.expectancy.at.birth.cont = Healthy.life.expectancy.at.birth.cont.x - Healthy.life.expectancy.at.birth.cont.y,
         Difference.Freedom.to.make.life.choices.cont = Freedom.to.make.life.choices.cont.x - Freedom.to.make.life.choices.cont.y,
         Difference.Generosity.cont = Generosity.cont.x - Generosity.cont.y,
         Difference.Perceptions.of.corruption.cont = Perceptions.of.corruption.cont.x - Perceptions.of.corruption.cont.y) %>%
  summarise(across(starts_with("Difference."), list(mean = ~mean(abs(.x)), max = ~max(abs(.x)), country_with_max_diff = ~Country.name[which.max(abs(.x))])))

# We then format this data for presentation, pivoting the data to a long format, separating the variable names into separate columns, and then pivoting back to a wide format
# We then create a table with the data, adding styling for better readability
library(kableExtra)
comparison %>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Values") %>%
  separate(Variable, into = c("Variable", "Statistic"), sep = "_", extra = "merge") %>%
  mutate(Variable = case_when(
    Variable == "Difference.Life.Ladder" ~ "Life Satisfaction",
    Variable == "Difference.Log.GDP.per.capita" ~ "Log GDP per Capita",
    Variable == "Difference.Social.support" ~ "Social Support",
    Variable == "Difference.Healthy.life.expectancy.at.birth" ~ "Healthy Life Expectancy at Birth",
    Variable == "Difference.Freedom.to.make.life.choices" ~ "Freedom to Make Life Choices",
    Variable == "Difference.Generosity" ~ "Generosity",
    Variable == "Difference.Perceptions.of.corruption" ~ "Perceptions of Corruption",
    Variable == "Difference.Log.GDP.per.capita.cont" ~ "Log GDP per Capita Contribution",
    Variable == "Difference.Social.support.cont" ~ "Social Support Contribution",
    Variable == "Difference.Healthy.life.expectancy.at.birth.cont" ~ "Healthy Life Expectancy at Birth Contribution",
    Variable == "Difference.Freedom.to.make.life.choices.cont" ~ "Freedom to Make Life Choices Contribution",
    Variable == "Difference.Generosity.cont" ~ "Generosity Contribution",
    Variable == "Difference.Perceptions.of.corruption.cont" ~ "Perceptions of Corruption Contribution",
    TRUE ~ Variable
  )) %>%
  pivot_wider(names_from = Statistic, values_from = Values) %>%
  kable(caption = "Comparison of Differences") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

We note that most absolute differences between our calculated mean values across life satisfaction and the six determinants of well-being and the values posted by the WHR are less than 0.001 which can be accounted for by rounding errors from published statistics rounded to the third decimal place. There are some countries where we see differences up to 0.025, which is too large to be accounted for by rounding errors. It is still not a large change, but indicates some difference between methods. We expect that these changes originate from restricting the sample to individuals with no missing values across all variables of interest, including life satisfaction and the questions concerning social support, generosity and freedom of choice. This assertion is supported by the fact that it is in these values where we see the largest discrepancies. 


**Creating an age-standardized life satisfaction Ranking**

Age standardization is a statistical technique used in epidemiology and public health research to compare rates or proportions across different populations that may have different age distributions. The goal is to remove the effect of age as a confounding variable, allowing for a more accurate comparison of health indicators or outcomes between populations.

### Reading Gallup data and establishing age groups

We use the WHO Standard Population to divide our data into 5 categories. 

```{r}
# Load the cleaned Gallup World Poll data
gallup_main <- readRDS("Data/(231101)GWP_cleaned_ageStandardizedWellbeing.rds")

# Create a new column 'Weighted.LS' by multiplying 'WGT' and 'WP16' columns, converting the result to numeric
gallup_main$Weighted.LS <- as.numeric(gallup_main$WGT*gallup_main$WP16)

# Add a new column 'age_group' to the data, categorizing the 'WP1220' column into age groups
gallup_main <- gallup_main %>% 
  mutate(
    age_group = case_when(
      WP1220 > 14 & WP1220 <= 29 ~ "15-29", # Age group 15-29
      WP1220 > 29 & WP1220 <= 44 ~ "30-44", # Age group 30-44
      WP1220 > 44 & WP1220 <= 59 ~ "45-59", # Age group 45-59
      WP1220 > 59 & WP1220 <= 74 ~ "60-74", # Age group 60-74
      WP1220 > 74 ~ "Over 74")) # Age group Over 74
```

### Creating Age-Standardized Life-Satisfaction Ranking

```{r}
# Define the standard population weights for each age group. These weights are used to adjust the data for age standardization.
# Standard population by WHO includes from age 0. Thus, these weights are reweighted to be only from Age 15 or above. Some rounding error means that these add up to 1.000474. This isn't a concern as weighted means will reweight all weights to equal 1 automatically.
standard_population <- c(0.3333784699, 0.2890995261, 0.2161137441, 0.1203791469, 0.04150304671)

# Calculate the weighted mean life satisfaction (WP16) for each country, year, and age group in the Gallup data from 2020 to 2022.
gallup_means <- gallup_main %>%
  group_by(COUNTRY_ISO3, YEAR_WAVE, age_group) %>%
  summarise(WeightedMeanLS = weighted.mean(WP16,WGT, na.rm=TRUE), n=n(), .groups = "drop") %>%
  filter(!(age_group=="NA")) %>%
  # Assign the standard population weights to the corresponding age groups.
  mutate(
    standard_population = case_when(
      age_group == "15-29" ~ standard_population[1], 
      age_group == "30-44" ~ standard_population[2],
      age_group == "45-59" ~ standard_population[3], 
      age_group == "60-74" ~ standard_population[4], 
      age_group == "Over 74" ~ standard_population[5])) 

# Calculate the weighted mean life satisfaction for each country and year, considering all age groups together.
gallup_means <- gallup_means %>%
  bind_rows(
    gallup_means %>%
      group_by(COUNTRY_ISO3, YEAR_WAVE) %>%
      summarise(
        WeightedMeanLS = weighted.mean(WeightedMeanLS, standard_population, na.rm = TRUE),
        n = sum(n),
        age_group = "allPopulation",
        standard_population = 1
      )
  )

# Calculate the weighted mean life satisfaction for each country and age group from 2020 to 2022, considering all years together.
 gallup_across_years <- gallup_means %>%
  filter(YEAR_WAVE %in% 2020:2022) %>%
  group_by(COUNTRY_ISO3, age_group) %>%
  summarise(WeightedMeanLS = weighted.mean(WeightedMeanLS, n, na.rm=T), .groups = "drop") 
```

### Comparing with WHR ranking

We compare our age-standardized methodology with the WHR methodology in terms of rank and scores. 

```{r}
# Create ranking from the life satisfaction scores for the entire population for each country
age_standardized_ranking <-  gallup_across_years %>% 
  filter(age_group == "allPopulation") %>% 
  mutate(AS_score = as.numeric(WeightedMeanLS),
         AS_rank = rank(-AS_score)) %>% 
  dplyr::select(COUNTRY_ISO3, AS_score, AS_rank)
  
# Merge both rankings to compare, then compute differences in score and rank
WHR_AS_comparison <- merge(WHR_summary, age_standardized_ranking, by="COUNTRY_ISO3", all=FALSE) %>%
  mutate(rank_difference = WHR_rank - AS_rank,
         score_difference = WHR_score - AS_score)
```

### Merging Data for Regression Analysis

We merge our age standardized scores to WHR's data across years on the predictors in preparation for regression analysis.

```{r}
AS_data_across_years <- merge(WHR_data_across_years, 
                              gallup_means %>% 
                                filter(age_group == "allPopulation"), 
                              by.x = c("COUNTRY_ISO3", "year"), 
                              by.y = c("COUNTRY_ISO3", "YEAR_WAVE"), 
                              all = FALSE)  %>% 
  dplyr::select(-13:-15) %>% 
  rename(n = n.y)

# Number of rows in WHR_data_across_years and AS_data_across_years is a bit different. I wonder why.
not_in_AS_data <- anti_join(WHR_data_across_years, AS_data_across_years, by = c("COUNTRY_ISO3", "year"))
```

### Age Standardized Regression Analysis

Following the approach of the World Happiness Report 2023 we run a regression of age-standardized life satisfaction on the six determinants of well-being suggested in the report, introducing fixed effects for year and clustering standard errors by country.

```{r}
Standardized_regression <- feols(
  # The dependent variable is 'WeightedMeanLS'.
  WeightedMeanLS ~ 
  # The independent variables are six determinants of well-being.
  Log.GDP.per.capita +
  Social.support +
  Healthy.life.expectancy.at.birth +
  Freedom.to.make.life.choices +
  Generosity +
  Perceptions.of.corruption |
  # Introduce fixed effects for 'year'.
  year, 
  # The data source is 'WHR_data_across_years'.
  data = AS_data_across_years
)

# Display the summary of the regression model, clustering standard errors by country
summary(Standardized_regression, cluster = "Country.name")
```

Calculating Age-standardized scores and its predictors with weighted average of WeightedMeanLS and determinants from 2020 to 2022

```{r}
# Calculate weighted average of life ladder and determinants from 2020 to 2022
AS_summary <- AS_data_across_years %>% filter(year >= 2020, year <= 2022) %>% 
  group_by(Country.name) %>% 
  summarize(AS_score = weighted.mean(WeightedMeanLS, n),
            Log.GDP.per.capita = weighted.mean(Log.GDP.per.capita, n, na.rm = TRUE),
            Social.support = weighted.mean(Social.support, n, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = weighted.mean(Healthy.life.expectancy.at.birth, n, na.rm = TRUE),
            Freedom.to.make.life.choices = weighted.mean(Freedom.to.make.life.choices, n, na.rm = TRUE),
            Generosity = weighted.mean(Generosity, n, na.rm = TRUE),
            Perceptions.of.corruption = weighted.mean(Perceptions.of.corruption, n, na.rm = TRUE)) %>% 
  mutate(WHR_rank = rank(-AS_score),
         COUNTRY_ISO3 = ifelse(Country.name == "Kosovo", "XKX", countrycode(Country.name, 'country.name', 'iso3c')))
```

```{r}
# Summary of age-standardized life satisfaction + raw data for predictors for years of interest (2020-2022)
Standardized_WHR_summary <- merge(WHR_data_fig, age_standardized_ranking, by="COUNTRY_ISO3") %>% 
  mutate(AS_rank = rank(-AS_score)) 
```

Calculate Contributions
```{r}
# Same as WHR. For each predictor, find the distance of the country's value from Dystopia's value (worst value for each predictor). This is necessary to determine how much it contributes to the LS score. This is done by multiplying the distance from Dystopia by the coefficient corresponding to that predictor. 

Standardized_contributions <- Standardized_WHR_summary %>% 
  mutate(Log.GDP.per.capita.cont = (coef(Standardized_regression)["Log.GDP.per.capita"] * Log.GDP.per.capita - min(coef(Standardized_regression)["Log.GDP.per.capita"] * Standardized_WHR_summary$Log.GDP.per.capita, na.rm = TRUE)),
         Social.support.cont = (coef(Standardized_regression)["Social.support"] * Social.support - min(coef(Standardized_regression)["Social.support"] * Standardized_WHR_summary$Social.support, na.rm = TRUE)),
         Healthy.life.expectancy.at.birth.cont = (coef(Standardized_regression)["Healthy.life.expectancy.at.birth"] * Healthy.life.expectancy.at.birth - min(coef(Standardized_regression)["Healthy.life.expectancy.at.birth"] * Standardized_WHR_summary$Healthy.life.expectancy.at.birth, na.rm = TRUE)),
         Freedom.to.make.life.choices.cont = (coef(Standardized_regression)["Freedom.to.make.life.choices"] * Freedom.to.make.life.choices - min(coef(Standardized_regression)["Freedom.to.make.life.choices"] * Standardized_WHR_summary$Freedom.to.make.life.choices, na.rm = TRUE)),
         Generosity.cont = (coef(Standardized_regression)["Generosity"] * Generosity - min(coef(Standardized_regression)["Generosity"] * Standardized_WHR_summary$Generosity, na.rm = TRUE)),
         Perceptions.of.corruption.cont = (coef(Standardized_regression)["Perceptions.of.corruption"] * Perceptions.of.corruption - min(coef(Standardized_regression)["Perceptions.of.corruption"] * Standardized_WHR_summary$Perceptions.of.corruption, na.rm = TRUE)),
         "Dystopia + residual" = AS_score - (Log.GDP.per.capita.cont + Social.support.cont +  Healthy.life.expectancy.at.birth.cont + Freedom.to.make.life.choices.cont + Generosity.cont + Perceptions.of.corruption.cont))
```

**Age-specific Life-satisfaction**
```{r}
# Function to calculate specific contributions for a given age group
calculate_specific_contributions <- function(age_group_data, regression_model) {
  specific_contributions <- age_group_data %>%
    mutate(
      Log.GDP.per.capita.cont = (coef(regression_model)["Log.GDP.per.capita"] * Log.GDP.per.capita - min(coef(regression_model)["Log.GDP.per.capita"] * age_group_data$Log.GDP.per.capita, na.rm = TRUE)),
      Social.support.cont = (coef(regression_model)["Social.support"] * Social.support - min(coef(regression_model)["Social.support"] * age_group_data$Social.support, na.rm = TRUE)),
      Healthy.life.expectancy.at.birth.cont = (coef(regression_model)["Healthy.life.expectancy.at.birth"] * Healthy.life.expectancy.at.birth - min(coef(regression_model)["Healthy.life.expectancy.at.birth"] * age_group_data$Healthy.life.expectancy.at.birth, na.rm = TRUE)) ,
      Freedom.to.make.life.choices.cont = (coef(regression_model)["Freedom.to.make.life.choices"] * Freedom.to.make.life.choices - min(coef(regression_model)["Freedom.to.make.life.choices"] * age_group_data$Freedom.to.make.life.choices, na.rm = TRUE)),
      Generosity.cont = (coef(regression_model)["Generosity"] * Generosity - min(coef(regression_model)["Generosity"] * age_group_data$Generosity, na.rm = TRUE)),
      Perceptions.of.corruption.cont = (coef(regression_model)["Perceptions.of.corruption"] * Perceptions.of.corruption - min(coef(regression_model)["Perceptions.of.corruption"] * age_group_data$Perceptions.of.corruption, na.rm = TRUE)) 
    )
  return(specific_contributions)
}

# List to store specific contributions data frames for each age group
specific_contributions_list <- list()
specific_regression_data_list <- list()

# Iterate over age groups
age_groups <- c("15-29", "30-44", "45-59", "60-74", "Over 74")

for (group in age_groups) {
  age_specific_scores <- gallup_means %>% 
    filter(age_group == group) %>% 
    dplyr::select(COUNTRY_ISO3, year = YEAR_WAVE, AS.LS = WeightedMeanLS)

  # Merge with WHR_data_across_years, remove missing values for regression 
  Specific_regression_data <- merge(WHR_data_across_years, age_specific_scores, by=c("year","COUNTRY_ISO3")) 

  # Perform regression
  Specific_regression <- feols(
    # The dependent variable is 'AS.LS'.
    AS.LS ~ 
    # The independent variables are six determinants of well-being.
    Log.GDP.per.capita +
    Social.support +
    Healthy.life.expectancy.at.birth +
    Freedom.to.make.life.choices +
    Generosity +
    Perceptions.of.corruption |
    # Introduce fixed effects for 'year'.
    year, 
    data = Specific_regression_data)

  # Find age-standardized score for each age-group. No process of weighting by year because we are starting from  
  # Gallup individual data, meaning we end up with the same values through a simple average. 
  age_specific_ranking <- gallup_across_years %>% 
    filter(age_group == group)
  colnames(age_specific_ranking) <- c("COUNTRY_ISO3", "age_group", "AS.LS")
  
  specific_WHR_summary <- merge(WHR_data_fig, age_specific_ranking, by="COUNTRY_ISO3") %>% 
    mutate(AS_rank = rank(-AS.LS)) 

  # Calculate contributions
  specific_contributions <- calculate_specific_contributions(specific_WHR_summary, Specific_regression)
  
  specific_contributions_list[[group]] <- specific_contributions
}

# Now, specific_contributions_list contains specific contributions data frames for each age group
# Access specific contributions for an age group like specific_contributions_list[["15-29"]]

specific_contributions_1 <- specific_contributions_list[["15-29"]]
specific_contributions_2 <- specific_contributions_list[["30-44"]]
specific_contributions_3 <- specific_contributions_list[["45-59"]]
specific_contributions_4 <- specific_contributions_list[["60-74"]]
specific_contributions_5 <- specific_contributions_list[["Over 74"]]
```

**Further Analysis**
Finding countries with significant changes with an absolute score difference larger than 0.2. 
```{r}
significant_difference <- WHR_AS_comparison %>% 
  filter(score_difference >= 0.20 | score_difference <= -0.20)

significant_difference_countries <- significant_difference$COUNTRY_ISO3

sd(WHR_AS_comparison$Life.Ladder)
sd(WHR_AS_comparison$AS_score)
```

Plotting coefficients for contributions
```{r}
# Initialise list to contain data for regression
Specific_regression_data_list <- list()

# Loop through each age group
for (i in seq_along(age_groups)) {
  group <- age_groups[i]
  
  # Loop to create Specific_regression_data
  age_specific_scores <- gallup_means %>% 
    filter(age_group == group) %>% 
    dplyr::select(COUNTRY_ISO3, year = YEAR_WAVE, AS.LS = WeightedMeanLS)
  
  Specific_regression_data <- merge(WHR_data_across_years, age_specific_scores, by=c("year","COUNTRY_ISO3")) 
  
  # Store the Specific_regression_data in the list
  Specific_regression_data_list[[i]] <- Specific_regression_data
  
  # Create the data frame data_i for each age group
  assign(paste0("data", i), Specific_regression_data %>%
             dplyr::select(c(1, 5:10, 16)) %>%
             mutate(age_group = i))
}

big_regression_data <- bind_rows(data1, data2, data3, data4, data5)%>%
  mutate(age_group = as.factor(age_group))

# Standardize columns 2:7 and add them to big_regression_data
stanardized_big_regression_data <- big_regression_data %>%
  dplyr::select(2:7) %>%
  scale() %>%
  as.data.frame() %>%
  setNames(paste0("Standard.", colnames(.))) %>%
  bind_cols(big_regression_data, .)

# Fit model with all age groups
big_model <- feols(
  AS.LS ~ age_group*Standard.Log.GDP.per.capita + age_group*Standard.Social.support + 
               age_group*Standard.Healthy.life.expectancy.at.birth + 
               age_group*Standard.Freedom.to.make.life.choices + age_group*Standard.Generosity +
               age_group*Standard.Perceptions.of.corruption | year, 
  data = stanardized_big_regression_data)

# Create data frame for model summary
big_model_summary <- summary(big_model)$coefficients %>%
  as.data.frame() %>%
  slice(-(1:4)) %>%
  mutate(group = as.factor(c(1, 1, 1, 1, 1, 1, 2, 3, 4, 5, 2, 3, 4, 5,
                             2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5)),
         variables = c("Log.GDP.per.capita", "Social.support", 
                       "Healthy.life.expectancy.at.birth", 
                       "Freedom.to.make.life.choices",
                       "Generosity", "Perceptions.of.corruption",
                       "Log.GDP.per.capita", "Log.GDP.per.capita", 
                       "Log.GDP.per.capita", "Log.GDP.per.capita",
                       "Social.support", "Social.support", 
                       "Social.support", "Social.support",
                       "Healthy.life.expectancy.at.birth", 
                       "Healthy.life.expectancy.at.birth", 
                       "Healthy.life.expectancy.at.birth", 
                       "Healthy.life.expectancy.at.birth", 
                       "Freedom.to.make.life.choices",
                       "Freedom.to.make.life.choices",
                       "Freedom.to.make.life.choices",
                       "Freedom.to.make.life.choices",
                       "Generosity", "Generosity",
                       "Generosity", "Generosity",
                       "Perceptions.of.corruption",
                       "Perceptions.of.corruption",
                       "Perceptions.of.corruption",
                       "Perceptions.of.corruption")) %>%
  rename(Estimate = ".", group = group) 

a <- big_model_summary$Estimate[1:6]
b <- as.numeric(a[1]) + as.numeric(big_model_summary$Estimate[7:10])
c <- as.numeric(a[2]) + as.numeric(big_model_summary$Estimate[11:14])
d <- as.numeric(a[3]) + as.numeric(big_model_summary$Estimate[15:18])
e <- as.numeric(a[4]) + as.numeric(big_model_summary$Estimate[19:22])
f <- as.numeric(a[5]) + as.numeric(big_model_summary$Estimate[23:26])
g <- as.numeric(a[6]) + as.numeric(big_model_summary$Estimate[27:30])
values <- c(a, b, c, d, e, f, g)
big_model_summary$values <- values

AS_coefficients_plot <- ggplot(big_model_summary, 
                               aes(fill=variables, y=values, x=group)) + 
  geom_bar(position="stack", stat="identity")
AS_coefficients_plot
```

Hypothesis Tests to compare coefficients for each predictor between each age group
```{r}
joint_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Log.GDP.per.capita +
                                              age_group2:Standard.Social.support +
                                              age_group2:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group2:Standard.Freedom.to.make.life.choices +                                                                      age_group2:Standard.Generosity -
                                              age_group2:Standard.Perceptions.of.corruption = 0"))

joint_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Log.GDP.per.capita + 
                                              age_group3:Standard.Social.support +
                                              age_group3:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group3:Standard.Freedom.to.make.life.choices + 
                                              age_group3:Standard.Generosity -
                                              age_group3:Standard.Perceptions.of.corruption -
                                              age_group2:Standard.Log.GDP.per.capita - 
                                              age_group2:Standard.Social.support -
                                              age_group2:Standard.Healthy.life.expectancy.at.birth - 
                                              age_group2:Standard.Freedom.to.make.life.choices - 
                                              age_group2:Standard.Generosity +
                                              age_group2:Standard.Perceptions.of.corruption = 0"))

joint_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Log.GDP.per.capita + 
                                              age_group4:Standard.Social.support +
                                              age_group4:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group4:Standard.Freedom.to.make.life.choices + 
                                              age_group4:Standard.Generosity -
                                              age_group4:Standard.Perceptions.of.corruption -
                                              age_group3:Standard.Log.GDP.per.capita - 
                                              age_group3:Standard.Social.support - 
                                              age_group3:Standard.Healthy.life.expectancy.at.birth - 
                                              age_group3:Standard.Freedom.to.make.life.choices - 
                                              age_group3:Standard.Generosity +
                                              age_group3:Standard.Perceptions.of.corruption = 0"))

joint_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita + 
                                              age_group5:Standard.Social.support +
                                              age_group5:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group5:Standard.Freedom.to.make.life.choices +
                                              age_group5:Standard.Generosity -
                                              age_group5:Standard.Perceptions.of.corruption -
                                              age_group4:Standard.Log.GDP.per.capita - 
                                              age_group4:Standard.Social.support -
                                              age_group4:Standard.Healthy.life.expectancy.at.birth - 
                                              age_group4:Standard.Freedom.to.make.life.choices - 
                                              age_group4:Standard.Generosity +
                                              age_group4:Standard.Perceptions.of.corruption = 0"))

joint_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita +
                                              age_group5:Standard.Social.support +
                                              age_group5:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group5:Standard.Freedom.to.make.life.choices +                                                                      age_group5:Standard.Generosity -
                                              age_group5:Standard.Perceptions.of.corruption = 0"))

gdp_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Log.GDP.per.capita -
                                          age_group2:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Log.GDP.per.capita -
                                          age_group3:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita -
                                          age_group4:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita = 0"))

ss_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Social.support = 0"))
ss_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Social.support - age_group2:Standard.Social.support = 0"))
ss_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Social.support - age_group3:Standard.Social.support = 0"))
ss_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Social.support - age_group4:Standard.Social.support = 0"))
ss_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Social.support = 0"))

le_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Healthy.life.expectancy.at.birth -
                                         age_group2:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Healthy.life.expectancy.at.birth -
                                         age_group3:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Healthy.life.expectancy.at.birth -
                                         age_group4:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Healthy.life.expectancy.at.birth = 0"))

fr_hypo_12<- glht(big_model, linfct = c("age_group2:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Freedom.to.make.life.choices -
                                         age_group2:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Freedom.to.make.life.choices -
                                         age_group3:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Freedom.to.make.life.choices -
                                         age_group4:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_15<- glht(big_model, linfct = c("age_group5:Standard.Freedom.to.make.life.choices = 0"))

ge_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Generosity = 0"))
ge_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Generosity - age_group2:Standard.Generosity = 0"))
ge_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Generosity - age_group3:Standard.Generosity = 0"))
ge_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Generosity - age_group4:Standard.Generosity = 0"))
ge_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Generosity = 0"))

co_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Perceptions.of.corruption = 0"))
co_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Perceptions.of.corruption - 
                                         age_group2:Standard.Perceptions.of.corruption = 0"))
co_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Perceptions.of.corruption - 
                                         age_group3:Standard.Perceptions.of.corruption = 0"))
co_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Perceptions.of.corruption - 
                                         age_group4:Standard.Perceptions.of.corruption = 0"))
co_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Perceptions.of.corruption = 0"))
```

Create table of hypothesis test results
```{r}
# List of your hypothesis tests for each group
hypo_tests_list <- list(
  "joint_hypo" = list(joint_hypo_12, joint_hypo_23, joint_hypo_34, joint_hypo_45, joint_hypo_15),
  "gdp_hypo" = list(gdp_hypo_12, gdp_hypo_23, gdp_hypo_34, gdp_hypo_45, gdp_hypo_15),
  "ss_hypo" = list(ss_hypo_12, ss_hypo_23, ss_hypo_34, ss_hypo_45, ss_hypo_15),
  "le_hypo" = list(le_hypo_12, le_hypo_23, le_hypo_34, le_hypo_45, le_hypo_15),
  "fr_hypo" = list(fr_hypo_12, fr_hypo_23, fr_hypo_34, fr_hypo_45, fr_hypo_15),
  "ge_hypo" = list(ge_hypo_12, ge_hypo_23, ge_hypo_34, ge_hypo_45, ge_hypo_15),
  "co_hypo" = list(co_hypo_12, co_hypo_23, co_hypo_34, co_hypo_45, co_hypo_15)
)

# Corresponding row names for matrix
row_names <- c("All", "Log.GDP.per.capita", "Social.support", "Healthy.life.expectancy.at.birth", "Freedom.to.make.life.choices", "Generosity", "Perceptions.of.corruption")

# Corresponding column names for matrix
test_names <- c("compare12", "compare23", "compare34", "compare45", "compare15")

# Initialize matrix
joint_test_matrix <- matrix(nrow = length(row_names), ncol = length(test_names))

# Loop over each group of tests
for (i in 1:length(hypo_tests_list)) {
  # Loop over each test in the current group
  for (j in 1:length(hypo_tests_list[[i]])) {
    # Get the summary of the current test
    summary_obj <- summary(hypo_tests_list[[i]][[j]])
    
    # Extract coefficients and standard errors
    coefficients <- summary_obj$test$coefficients
    standard_errors <- summary_obj$test$sigma
    p_values <- summary_obj$test$pvalues
    
    # Add asterisks based on p-value thresholds
    asterisks <- ifelse(p_values < 0.001, "***", ifelse(p_values < 0.01, "**", ifelse(p_values < 0.05, "*", "")))
    
    # Format the values and add them to the matrix
    joint_test_matrix[i, j] <- paste0(round(coefficients, 5), " (", round(standard_errors, 5), ")", asterisks)
  }
}

# Convert the matrix to a data frame and add column and row names
joint_test_matrix <- data.frame(joint_test_matrix)
colnames(joint_test_matrix) <- test_names
rownames(joint_test_matrix) <- row_names
```

World Map
```{r}
WHR_AS_comparison$COUNTRY_NAME <- countrycode(WHR_AS_comparison$COUNTRY_ISO3, 'iso3c', 'country.name') 
WHR_AS_comparison$COUNTRY_NAME[WHR_AS_comparison$COUNTRY_ISO3 == "XKX"] <- "Kosovo"
WHR_AS_comparison$COUNTRY_NAME[WHR_AS_comparison$COUNTRY_NAME == "United States"] <- "USA"
  
WHR_AS_comparison <- WHR_AS_comparison %>% 
  rename(region = COUNTRY_NAME)

WHR_AS_comparison <- WHR_AS_comparison %>% 
  mutate(bin = cut(score_difference, breaks = seq(-0.5, 0.5, by = 0.1), include.lowest = TRUE))

# Merge the data with the world map
world_map <- map_data("world") %>% filter(!(region%in%c("French Southern and Antarctic Lands","Antarctica"))) 
world_map <- left_join(world_map, WHR_AS_comparison, by = "region")

# Create a choropleth map with discrete bins
ggplot(world_map, aes(x = long, y = lat, group = group, fill = bin)) +
  geom_polygon(color = "black", size = 0.1) +
  scale_fill_manual(values = c("#67001F", "#B2182B", "#D6604D", "#F4A582", "#FDDBC7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"), drop = FALSE) + 
  theme_minimal() +
  ggtitle("World Map for Score Difference from WHR to AS") +
  labs(
    x = "Longitude",    # Change the x-axis label
    y = "Latitude",     # Change the y-axis label
    fill = "Score Difference"  # Change the legend title
  )

```

Variance and Gini
```{r}
library(DescTools)

var(WHR_AS_comparison$WHR_score)
var(WHR_AS_comparison$AS_score)

var.test(WHR_AS_comparison$WHR_score, WHR_AS_comparison$AS_score, alternative = "less")

Gini(WHR_AS_comparison$WHR_score, conf.level = 0.95)
Gini(WHR_AS_comparison$AS_score, conf.level = 0.95)
```

Ranking for 2013
```{r}
age_standardized_ranking_2013 <- gallup_means %>%
  filter(YEAR_WAVE %in% 2010:2012) %>%
  group_by(COUNTRY_ISO3, age_group) %>%
  summarise(WeightedMeanLS = weighted.mean(WeightedMeanLS, n, na.rm=T), .groups = "drop") %>% 
  filter(age_group == "allPopulation") %>% 
  mutate(AS_score = as.numeric(WeightedMeanLS),
         AS_rank = rank(-AS_score)) %>% 
  dplyr::select(COUNTRY_ISO3, AS_score_2013 = AS_score, AS_rank_2013 = AS_rank)

WHR_data_2013 <- read.csv("Data/WHR_Data_2013.csv") %>% 
  dplyr::select(Country, WHR_score_2013 = Ladder) %>% 
  mutate(COUNTRY_ISO3 = ifelse(Country == "Kosovo", "XKX", countrycode(Country, 'country.name', 'iso3c')))

WHR_AS_comparison_2013 <- merge(WHR_data_2013, age_standardized_ranking_2013, by="COUNTRY_ISO3")

comparison_2013_2023 <- merge(WHR_AS_comparison, WHR_AS_comparison_2013, by="COUNTRY_ISO3")

notable_countries <- comparison_2013_2023 %>% 
  filter(WHR_score > WHR_score_2013 & AS_score < AS_score_2013 |
         WHR_score < WHR_score_2013 & AS_score > AS_score_2013) %>% 
  dplyr::select(COUNTRY_ISO3 = COUNTRY_ISO3, Country = region, WHR_2023 = WHR_score, AS_2023 = AS_score, WHR_2013 = WHR_score_2013, AS_2013 = AS_score_2013)

notable_countries <- notable_countries %>% 
  mutate(WHR_diff = WHR_2023 - WHR_2013,
         AS_diff = AS_2023 - AS_2013,
         diff_of_diff = WHR_diff - AS_diff) %>% 
  # removing CYP because it includes both Cyprus and North Cyprus
  filter(COUNTRY_ISO3 != "CYP")
```

Summarizing Changing from WHR to AS
```{r}
mean(abs(WHR_AS_comparison$rank_difference))
mean(abs(WHR_AS_comparison$score_difference))

significant_changes_in_rank <- WHR_AS_comparison %>% 
  filter(abs(rank_difference) >= 10) %>% 
  dplyr::select(COUNTRY_ISO3, region, WHR_score, AS_score, rank_difference, score_difference)
```


Analysis of Age-Specific Rankings
```{r}
# Create empty vectors
rank_diff <- c()
score_diff <- c()

# Create an empty list to store significant changes
significant_changes_list <- list()

# Iterate over the names of the list (i.e., the age groups)
for (group in names(specific_contributions_list)) {
  
  # Get the contributions for the current age group
  contributions <- specific_contributions_list[[group]]
  
  contributions <- contributions %>% 
    mutate(WHR_rank = rank(-WHR_score)) %>% 
    mutate(rank_difference = AS_rank - WHR_rank,
           score_difference = AS.LS - WHR_score)
  
  rd <- mean(abs(contributions$rank_difference))
  rank_diff <- c(rank_diff, rd)
  
  sd <- mean(abs(contributions$score_difference))
  score_diff <- c(score_diff, sd)
  
  significant_changes_in_rank <- contributions %>% 
    filter(abs(rank_difference) >= 10) %>% 
    dplyr::select(COUNTRY_ISO3, Country = Country.name, WHR_score, AS.LS, rank_difference, score_difference)
  
  significant_changes_list[[group]] <- significant_changes_in_rank
}

age_specific_differences <- data.frame(rank_diff, score_diff)
```

Ranking Comparison Table:
```{r}
ranking_comparisons <- WHR_AS_comparison %>% 
  dplyr::select(COUNTRY_ISO3, region, WHR_score, WHR_rank, AS_score, AS_rank)

age_specific_ranking_comparisons <- specific_contributions_1 %>% 
  dplyr::select(COUNTRY_ISO3, AG1_score = AS.LS, AG1_rank = AS_rank) %>%
  left_join(
    specific_contributions_2 %>% dplyr::select(COUNTRY_ISO3, AG2_score = AS.LS, AG2_rank = AS_rank),
    by = "COUNTRY_ISO3"
  ) %>%
  left_join(
    specific_contributions_3 %>% dplyr::select(COUNTRY_ISO3, AG3_score =AS.LS, AG3_rank = AS_rank),
    by = "COUNTRY_ISO3"
  ) %>%
  left_join(
    specific_contributions_4 %>% dplyr::select(COUNTRY_ISO3, AG4_score = AS.LS, AG4_rank = AS_rank),
    by = "COUNTRY_ISO3"
  ) %>%
  left_join(
    specific_contributions_5 %>% dplyr::select(COUNTRY_ISO3, AG5_score = AS.LS, AG5_rank = AS_rank),
    by = "COUNTRY_ISO3"
  ) 

ranking_comparisons <- left_join(ranking_comparisons, age_specific_ranking_comparisons, by = "COUNTRY_ISO3")

# Comparing ranks for top and bottom 10 in original WHR ranking
ranking_comparisons_summary <- ranking_comparisons %>% 
  filter(WHR_rank <= 10 | WHR_rank >= 128)
```

Visualizing Ranking Changes
```{r}
ranking_comparison_wide <- ranking_comparisons %>% 
  dplyr::select(COUNTRY_ISO3, COUNTRYNAME = region, WHR_rank, AS_rank, AG1_rank, AG4_rank)
ranking_comparison_wide <- ranking_comparison_wide[order(ranking_comparison_wide$WHR_rank), ]

WHR_and_AS <- ranking_comparison_wide %>% dplyr::select('WHR_rank', 'AS_rank')
WHR_and_AG1 <- ranking_comparison_wide %>% dplyr::select('WHR_rank', 'AG1_rank')
WHR_and_AG4 <- ranking_comparison_wide %>% dplyr::select('WHR_rank', 'AG4_rank')

WHR_and_AS <- WHR_and_AS %>%
  arrange(`AS_rank`)
WHR_and_AS$AS_rank <- WHR_and_AS$WHR

WHR_and_AG1 <- WHR_and_AG1 %>%
  arrange(`AG1_rank`)
WHR_and_AG1$AG1_rank <- WHR_and_AG1$WHR

WHR_and_AG4 <- WHR_and_AG4 %>%
  arrange(`AG4_rank`)
WHR_and_AG4$AG4_rank <- WHR_and_AG4$WHR

# This is ordered by each ranking, but the value represents the WHR Rank of the country in that spot.
ranking_comparison_visualization_data  <- data.frame(ranking_comparison_wide %>% dplyr::select(WHR_rank),
                                                      WHR_and_AS %>% dplyr::select(AS_rank),
                                                      WHR_and_AG1 %>% dplyr::select(AG1_rank),
                                                      WHR_and_AG4 %>% dplyr::select(AG4_rank),
                                                     ranking_comparison_wide %>% dplyr::select(WHR_rank)) %>% 
  dplyr::select("WHR" = WHR_rank, "Age-Standardized" = AS_rank, "Age Group 1" = AG1_rank, 
         "Age Group 4" = AG4_rank, "WHR2" = WHR_rank.1)


df_long <- reshape2::melt(ranking_comparison_visualization_data, id.vars = "WHR2")

# Create graphpic, red is Guatemala and magenta is Serbia (two countries with biggest change in either direction)
ggplot(df_long, aes(x = variable, y = WHR2, fill = factor(value))) +
  geom_tile() +
  scale_fill_manual(
    values = c(
      viridis(137, direction = -1)[1:42],
      "#FF0000",
      viridis(137, direction = -1)[44],
      "#FF00FF",
      viridis(137, direction = -1)[46:137]
    )
  ) +  # Adjust colors as needed
  labs(title = "Ranking Comparison Visualization", x = "Ranking Type", y = "Ranking") +
  theme_minimal() +
  scale_y_reverse() +
  guides(fill = guide_colourbar(reverse = TRUE, title = "Ranking"))
```

Researching Egypt and Iceland
```{r}
# Egypt has decreasing WHR score but increasing AS score
age_matrix <- gallup_main %>%
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = weighted.mean(WP16, WGT, na.rm=T)) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group)

age_n_matrix <- gallup_main %>%
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = n) %>%
  arrange(YEAR_CALENDAR, age_group)

egypt_n <- age_n_matrix %>% dplyr::select("YEAR_CALENDAR", "age_group", "EGY") %>% 
  filter((YEAR_CALENDAR <= 2012 & YEAR_CALENDAR >= 2010)|(YEAR_CALENDAR <= 2022 & YEAR_CALENDAR >= 2020))

egypt <- age_matrix %>% dplyr::select("YEAR_CALENDAR", "age_group", "EGY") %>% 
  filter((YEAR_CALENDAR <= 2012 & YEAR_CALENDAR >= 2010)|(YEAR_CALENDAR <= 2022 & YEAR_CALENDAR >= 2020))

egypt = merge(egypt, egypt_n, by=c("YEAR_CALENDAR", "age_group"))

egypt <- egypt %>%
  mutate(Year_Group = case_when(
    between(YEAR_CALENDAR, 2010, 2012) ~ "2010-2012",
    between(YEAR_CALENDAR, 2020, 2022) ~ "2020-2022"
  ))

# Calculate the weighted average
egypt <- egypt %>%
  group_by(age_group, Year_Group) %>% 
  summarise(Avg_LS = sum((EGY.x)*(EGY.y), na.rm=T) / sum(EGY.y, na.rm=T)) %>%
  arrange(Year_Group, age_group)

ggplot(egypt, aes(x = age_group, y = Avg_LS, fill = Year_Group)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, color = "black") +
  labs(title = "Average LS by Age Group and Year Group in Egypt", x = "Age Group", y = "Average LS") +
  scale_fill_manual(values = c("2010-2012" = "lightblue", "2020-2022" = "salmon")) +  # Adjust colors as needed
  theme_minimal()
```


```{r}
# Iceland has increasing WHR score but decreasing AS score
iceland <- age_matrix %>% dplyr::select("YEAR_CALENDAR", "age_group", "ISL") %>% 
  filter((YEAR_CALENDAR <= 2012 & YEAR_CALENDAR >= 2010)|(YEAR_CALENDAR <= 2022 & YEAR_CALENDAR >= 2020))

iceland_n <- age_n_matrix %>% dplyr::select("YEAR_CALENDAR", "age_group", "ISL") %>% 
  filter((YEAR_CALENDAR <= 2012 & YEAR_CALENDAR >= 2010)|(YEAR_CALENDAR <= 2022 & YEAR_CALENDAR >= 2020))

iceland = merge(iceland, iceland_n, by=c("YEAR_CALENDAR", "age_group"))

iceland <- iceland %>%
  mutate(Year_Group = case_when(
    between(YEAR_CALENDAR, 2010, 2012) ~ "2010-2012",
    between(YEAR_CALENDAR, 2020, 2022) ~ "2020-2022"
  ))

# Calculate the weighted average
iceland <- iceland %>%
  group_by(age_group, Year_Group) %>%
  summarise(Avg_LS = sum((ISL.x)*(ISL.y), na.rm=T) / sum(ISL.y, na.rm=T)) %>%
  arrange(Year_Group, age_group)

ggplot(iceland, aes(x = age_group, y = Avg_LS, fill = Year_Group)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, color = "black") +
  labs(title = "Average LS by Age Group and Year Group in Iceland", x = "Age Group", y = "Average LS") +
  scale_fill_manual(values = c("2010-2012" = "lightblue", "2020-2022" = "salmon")) +  # Adjust colors as needed
  theme_minimal()
```

```{r}
write.csv(Standardized_contributions, file = "/Users/makototakahara/Downloads/Standardized_contributions.csv", row.names = FALSE)
```

# APPENDIX - DELETED code

### Calculating Venezula's Log GDP per capita

In the presentation of the WHR2023 data, the contribution to wellbeing from each factor is calculated as the difference from the contribution for the country with the lowest level of that factor (or the highest if the effect is negative). There are some missing values in the data that the WHR authors have imputed. Instead of following their exact process for imputation the imputed values can be restored from the 
```{r}
# Venezuela's GDP is missing, so we use all other values to working backwards from WHR. Usually, we could work backwards without this complicated process using the results of the regression. However, this is not possible unless we have Venezuela's GDP as Venezuela's GDP is Dystopia's GDP. 

# Load the World Happiness Report data from an Excel file
WHR_data <- readxl::read_excel("Data/DataForFigure2.1WHR2023.xls")

# Extract the coefficient for Log GDP per capita from the regression model
gdp_estimate <- coef(WHR_regression)["Log.GDP.per.capita"]

# Calculate an estimate for Venezuela's GDP by subtracting the contribution of GDP to happiness from the total happiness score
venezuela_GDP_calc <- WHR_data %>%
  mutate(ven_GDP_est = `Logged GDP per capita` - `Explained by: Log GDP per capita`/gdp_estimate)

# Compute the mean of the estimated GDP values to get a single estimate for Venezuela's GDP
venezuela_GDP <- mean(venezuela_GDP_calc$ven_GDP_est)
```


Impute missing data
```{r}
# We impute the missing data by working backwards through the WHR. A limitation of this is that it might be slightly inaccurate, as the WHR imputes data before regression. 

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(WHR_regression)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

WHR_summary[WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])
```


Construct WHR Ranking
```{r}
# For each predictor, find the distance of the country's value from Dystopia's value. This is necessary to determine how much it contributes to the LS score. This is done by multiplying the distance from Dystopia by the coefficient corresponding to that predictor. 

distance_from_dystopia <- cbind(WHR_summary %>% 
                                  dplyr::select(Country.name) %>% 
                                  filter(Country.name != "Dystopia"),
                                (WHR_summary[1:137, 3:8] - WHR_summary[rep(138, 137), 3:8]))

WHR_ranking <- distance_from_dystopia$Country.name
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[2] * coef(summary(WHR_regression))[1,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[3] * coef(summary(WHR_regression))[2,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[4] * coef(summary(WHR_regression))[3,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[5] * coef(summary(WHR_regression))[4,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[6] * coef(summary(WHR_regression))[5,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[7] * coef(summary(WHR_regression))[6,1])
WHR_ranking$sum <- apply(WHR_ranking[,-1], 1, sum) 

WHR_ranking <- data.frame(cbind(WHR_ranking, WHR_score = WHR_summary[1:137,]$Life.Ladder))
WHR_ranking$residual <- WHR_ranking$WHR_score - WHR_ranking$sum
WHR_ranking$WHR_rank <- rank(-WHR_ranking$WHR_score)

WHR_ranking <- WHR_ranking %>% 
  dplyr::select(!sum)
WHR_ranking <- WHR_ranking[,c(1, 8, 10, 2, 3, 4, 5, 6, 7, 9)]
names(WHR_ranking)[names(WHR_ranking) == 'WHR_ranking'] <- 'COUNTRY_ISO3'

WHR_ranking_summary <- WHR_ranking %>% 
  dplyr::select(COUNTRY_ISO3, WHR_score, WHR_rank)

WHR_ranking_summary$COUNTRY_ISO3 <- countrycode(WHR_ranking_summary$COUNTRY_ISO3, 'country.name', 'iso3c') 

WHR_ranking_summary$COUNTRY_ISO3[WHR_ranking_summary$WHR_rank == 34] <- "XKX"
WHR_ranking_summary$COUNTRY_ISO3[WHR_ranking_summary$WHR_rank == 107] <- "TUR"
```

### OLD AGE STANDARDIZED CALCULATION SECTION

```{r}

gallup_age_2020 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2020) %>%
  dplyr::select(which(colSums(is.na(.)) < nrow(.)))
gallup_age_2020 <- gallup_age_2020[, 2:ncol(gallup_age_2020)]
countries_2020 <- colnames(gallup_age_2020)[2:108]
age_standardized_ranking_2020 <- gallup_age_2020 %>%
  summarise(across(all_of(countries_2020), 
                   list(ASLS = ~ weighted.mean(., standard_population, na.rm=T))))
age_standardized_ranking_2020 <- pivot_longer(age_standardized_ranking_2020, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2020")
age_standardized_ranking_2020$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2020$COUNTRY_ISO3)
n_2020 <- gallup_main %>% 
    filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>%  
  filter(YEAR_CALENDAR == 2020) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2020 = n()) 
age_standardized_ranking_2020 <- merge(age_standardized_ranking_2020, n_2020)

gallup_age_2021 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2021) %>%
  dplyr::select(which(colSums(is.na(.)) < nrow(.)))
gallup_age_2021 <- gallup_age_2021[, 2:ncol(gallup_age_2021)]
countries_2021 <- colnames(gallup_age_2021)[2:121]
age_standardized_ranking_2021 <- gallup_age_2021 %>%
  summarise(across(all_of(countries_2021), 
                   list(ASLS = ~ weighted.mean(., standard_population, na.rm=T))))
age_standardized_ranking_2021 <- pivot_longer(age_standardized_ranking_2021, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2021")
age_standardized_ranking_2021$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2021$COUNTRY_ISO3)
n_2021 <- gallup_main %>% 
    filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>%  
  filter(YEAR_CALENDAR == 2021) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2021 = n()) 
age_standardized_ranking_2021 <- merge(age_standardized_ranking_2021, n_2021)

gallup_age_2022 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2022) %>%
  dplyr::select(which(colSums(is.na(.)) < nrow(.)))
gallup_age_2022 <- gallup_age_2022[, 2:ncol(gallup_age_2022)]
countries_2022 <- colnames(gallup_age_2022)[2:140]
age_standardized_ranking_2022 <- gallup_age_2022 %>%
  summarise(across(all_of(countries_2022), 
                   list(ASLS = ~ weighted.mean(., standard_population, na.rm=T))))
age_standardized_ranking_2022 <- pivot_longer(age_standardized_ranking_2022, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2022")
age_standardized_ranking_2022$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2022$COUNTRY_ISO3)
n_2022 <- gallup_main %>% 
    filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  filter(YEAR_CALENDAR == 2022) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2022 = n()) 
age_standardized_ranking_2022 <- merge(age_standardized_ranking_2022, n_2022)

age_ranking_2020_2021 <- merge(x = age_standardized_ranking_2020, y = age_standardized_ranking_2021, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking <- merge(x = age_ranking_2020_2021, y = age_standardized_ranking_2022, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking[is.na(age_standardized_ranking)] <- 0

age_standardized_ranking <- age_standardized_ranking %>% 
  mutate(AS_score = (AS_score_2020*n_2020 + AS_score_2021*n_2021 + AS_score_2022*n_2022)/(n_2020+n_2021+n_2022)) %>% 
  dplyr::select(COUNTRY_ISO3, AS_score)

# Rename for merging later on
age_standardized_ranking$Country.name <- countrycode(age_standardized_ranking$COUNTRY_ISO3, 'iso3c', 'country.name')
age_standardized_ranking$Country.name[age_standardized_ranking$COUNTRY_ISO3=="XKX"] <- "Kosovo"
age_standardized_ranking$Country.name[age_standardized_ranking$COUNTRY_ISO3=="XNC"] <- "North Cyprus"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Bosnia & Herzegovina"] <- "Bosnia and Herzegovina"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Congo - Kinshasa"] <- "Congo (Kinshasa)"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Congo - Brazzaville"] <- "Congo (Brazzaville)"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Hong Kong SAR China"] <- "Hong Kong S.A.R. of China"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name== "Côte d’Ivoire"] <- "Ivory Coast"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Myanmar (Burma)"] <- "Myanmar"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Taiwan"] <- "Taiwan Province of China"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Turkey"] <- "Turkiye"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Palestinian Territories"] <- "State of Palestine"

# OLD APPROACH: No weighted average between years. 

# gallup_age <- gallup_main %>%
#   filter(YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>%
#   group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>%
#   drop_na(Weighted.LS) %>% 
#   summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
#   pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
# gallup_age[is.na(gallup_age)] = 0
# 
# standard_population <- c(0.3333784699, 0.2890995261, 0.2161137441,
#                               0.1203791469, 0.04150304671)
# 
# countries <- colnames(gallup_age)[2:144]
# age_standardized_ranking <- gallup_age %>%
#   summarise(across(all_of(countries),
#                    list(ASLS = ~ weighted.mean(., standard_population))))
# age_standardized_ranking <- pivot_longer(age_standardized_ranking,
#                                            cols = everything(),
#                                            names_to = "COUNTRY_ISO3",
#                                            values_to = "AS_score")
# age_standardized_ranking$COUNTRY_ISO3 <- gsub(
#   '_ASLS', '', age_standardized_ranking_test$COUNTRY_ISO3)
```


## Old Age-Specific Calculations
Group 1: 15 to 29
```{r}
# Creating WHR_data_across_years equivalent for age group 1 for regression
age_specific_scores_1 <- gallup_means %>% 
  filter(age_group == "15-29") %>% 
  dplyr::select(COUNTRY_ISO3, year = YEAR_WAVE, AS.LS = WeightedMeanLS)

# Merge with WHR_data_across_years, remove missing values for regression 
Specific_regression_data_1 <- merge(WHR_data_across_years, age_specific_scores_1, by=c("year","COUNTRY_ISO3")) 

# Perform regression
Specific_regression_1 <- feols(
  # The dependent variable is 'AS.LS'.
  AS.LS ~ 
  # The independent variables are six determinants of well-being.
  Log.GDP.per.capita +
  Social.support +
  Healthy.life.expectancy.at.birth +
  Freedom.to.make.life.choices +
  Generosity +
  Perceptions.of.corruption |
  # Introduce fixed effects for 'year'.
  year, 
  data = Specific_regression_data_1)

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_specific_ranking_1 <- gallup_across_years %>% 
  filter(age_group == "15-29")
colnames(age_specific_ranking_1) <- c("COUNTRY_ISO3", "age_group", "AS.LS")

specific_WHR_summary_1 <- merge(WHR_data_fig, age_specific_ranking_1, by="COUNTRY_ISO3") %>% 
  mutate(AS_rank = rank(-AS.LS)) 

specific_contributions_1 <- specific_WHR_summary_1 %>% 
  mutate(Log.GDP.per.capita.cont = (Log.GDP.per.capita - min(specific_WHR_summary_1$Log.GDP.per.capita, na.rm = TRUE)) * coef(Specific_regression_1)["Log.GDP.per.capita"],
         Social.support.cont = (Social.support - min(specific_WHR_summary_1$Social.support, na.rm = TRUE)) * coef(Specific_regression_1)["Social.support"],
         Healthy.life.expectancy.at.birth.cont = (Healthy.life.expectancy.at.birth - min(specific_WHR_summary_1$Healthy.life.expectancy.at.birth, na.rm = TRUE)) * coef(Specific_regression_1)["Healthy.life.expectancy.at.birth"],
         Freedom.to.make.life.choices.cont = (Freedom.to.make.life.choices - min(specific_WHR_summary_1$Freedom.to.make.life.choices, na.rm = TRUE)) * coef(WHR_regression)["Freedom.to.make.life.choices"],
         Generosity.cont = (Generosity - min(specific_WHR_summary_1$Generosity, na.rm = TRUE)) * coef(Specific_regression_1)["Generosity"],
         Perceptions.of.corruption.cont = (Perceptions.of.corruption - max(specific_WHR_summary_1$Perceptions.of.corruption, na.rm = TRUE)) * coef(Specific_regression_1)["Perceptions.of.corruption"])
```

Group 2: 30-44
```{r}
# Creating WHR_data_across_years equivalent for age group 2 for regression
age_specific_scores_2  <- gallup_main %>% 
  filter(age_group == "30-44") %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_specific_scores_2) <- c("COUNTRY_ISO3", "year", "AS.LS")

# Merge with WHR_data_across_years, remove missing values for regression 
Specific_regression_data_2 <- merge(WHR_data_across_years, age_specific_scores_2, by=c("year","COUNTRY_ISO3")) 

# Perform regression
Specific_regression_2 <- feols(
  # The dependent variable is 'AS.LS'.
  AS.LS ~ 
  # The independent variables are six determinants of well-being.
  Log.GDP.per.capita +
  Social.support +
  Healthy.life.expectancy.at.birth +
  Freedom.to.make.life.choices +
  Generosity +
  Perceptions.of.corruption |
  # Introduce fixed effects for 'year'.
  year, 
  data = Specific_regression_data_2)

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_specific_ranking_2  <- gallup_main %>% 
  filter(age_group == "30-44",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, COUNTRYNEW) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_specific_ranking_2) <- c("COUNTRY_ISO3", "Country.name", "AS.LS")

specific_WHR_summary_2 <- merge(WHR_data_fig, age_specific_ranking_2, by="COUNTRY_ISO3") %>% 
  mutate(AS_rank = rank(-AS.LS)) 

specific_contributions_2 <- specific_WHR_summary_2 %>% 
  mutate(Log.GDP.per.capita.cont = (Log.GDP.per.capita - min(specific_WHR_summary_2$Log.GDP.per.capita, na.rm = TRUE)) * coef(Specific_regression_2)["Log.GDP.per.capita"],
         Social.support.cont = (Social.support - min(specific_WHR_summary_2$Social.support, na.rm = TRUE)) * coef(Specific_regression_2)["Social.support"],
         Healthy.life.expectancy.at.birth.cont = (Healthy.life.expectancy.at.birth - min(specific_WHR_summary_2$Healthy.life.expectancy.at.birth, na.rm = TRUE)) * coef(Specific_regression_2)["Healthy.life.expectancy.at.birth"],
         Freedom.to.make.life.choices.cont = (Freedom.to.make.life.choices - min(specific_WHR_summary_2$Freedom.to.make.life.choices, na.rm = TRUE)) * coef(WHR_regression)["Freedom.to.make.life.choices"],
         Generosity.cont = (Generosity - min(specific_WHR_summary_2$Generosity, na.rm = TRUE)) * coef(Specific_regression_2)["Generosity"],
         Perceptions.of.corruption.cont = (Perceptions.of.corruption - max(specific_WHR_summary_2$Perceptions.of.corruption, na.rm = TRUE)) * coef(Specific_regression_2)["Perceptions.of.corruption"])
```

Group 3: 45-59
```{r}
# Creating WHR_data_across_years equivalent for age group 3 for regression
age_specific_scores_3  <- gallup_main %>% 
  filter(age_group == "45-59") %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_specific_scores_3) <- c("COUNTRY_ISO3", "year", "AS.LS")

# Merge with WHR_data_across_years, remove missing values for regression 
Specific_regression_data_3 <- merge(WHR_data_across_years, age_specific_scores_3, by=c("year","COUNTRY_ISO3")) 

# Perform regression
Specific_regression_3 <- feols(
  # The dependent variable is 'AS.LS'.
  AS.LS ~ 
  # The independent variables are six determinants of well-being.
  Log.GDP.per.capita +
  Social.support +
  Healthy.life.expectancy.at.birth +
  Freedom.to.make.life.choices +
  Generosity +
  Perceptions.of.corruption |
  # Introduce fixed effects for 'year'.
  year, 
  data = Specific_regression_data_3)

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_specific_ranking_3  <- gallup_main %>% 
  filter(age_group == "45-59",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, COUNTRYNEW) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_specific_ranking_3) <- c("COUNTRY_ISO3", "Country.name", "AS.LS")

specific_WHR_summary_3 <- merge(WHR_data_fig, age_specific_ranking_3, by="COUNTRY_ISO3") %>% 
  mutate(AS_rank = rank(-AS.LS)) 

specific_contributions_3 <- specific_WHR_summary_3 %>% 
  mutate(Log.GDP.per.capita.cont = (Log.GDP.per.capita - min(specific_WHR_summary_3$Log.GDP.per.capita, na.rm = TRUE)) * coef(Specific_regression_3)["Log.GDP.per.capita"],
         Social.support.cont = (Social.support - min(specific_WHR_summary_3$Social.support, na.rm = TRUE)) * coef(Specific_regression_3)["Social.support"],
         Healthy.life.expectancy.at.birth.cont = (Healthy.life.expectancy.at.birth - min(specific_WHR_summary_3$Healthy.life.expectancy.at.birth, na.rm = TRUE)) * coef(Specific_regression_3)["Healthy.life.expectancy.at.birth"],
         Freedom.to.make.life.choices.cont = (Freedom.to.make.life.choices - min(specific_WHR_summary_3$Freedom.to.make.life.choices, na.rm = TRUE)) * coef(WHR_regression)["Freedom.to.make.life.choices"],
         Generosity.cont = (Generosity - min(specific_WHR_summary_3$Generosity, na.rm = TRUE)) * coef(Specific_regression_3)["Generosity"],
         Perceptions.of.corruption.cont = (Perceptions.of.corruption - max(specific_WHR_summary_3$Perceptions.of.corruption, na.rm = TRUE)) * coef(Specific_regression_3)["Perceptions.of.corruption"])
```

Group 4: 60-74
```{r}
# Creating WHR_data_across_years equivalent for age group 4 for regression
age_specific_scores_4  <- gallup_main %>% 
  filter(age_group == "60-74") %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_specific_scores_4) <- c("COUNTRY_ISO3", "year", "AS.LS")

# Merge with WHR_data_across_years, remove missing values for regression 
Specific_regression_data_4 <- merge(WHR_data_across_years, age_specific_scores_4, by=c("year","COUNTRY_ISO3")) 

# Perform regression
Specific_regression_4 <- feols(
  # The dependent variable is 'AS.LS'.
  AS.LS ~ 
  # The independent variables are six determinants of well-being.
  Log.GDP.per.capita +
  Social.support +
  Healthy.life.expectancy.at.birth +
  Freedom.to.make.life.choices +
  Generosity +
  Perceptions.of.corruption |
  # Introduce fixed effects for 'year'.
  year, 
  data = Specific_regression_data_4)

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_specific_ranking_4  <- gallup_main %>% 
  filter(age_group == "60-74",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, COUNTRYNEW) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_specific_ranking_4) <- c("COUNTRY_ISO3", "Country.name", "AS.LS")

specific_WHR_summary_4 <- merge(WHR_data_fig, age_specific_ranking_4, by="COUNTRY_ISO3") %>% 
  mutate(AS_rank = rank(-AS.LS)) 

specific_contributions_4 <- specific_WHR_summary_4 %>% 
  mutate(Log.GDP.per.capita.cont = (Log.GDP.per.capita - min(specific_WHR_summary_4$Log.GDP.per.capita, na.rm = TRUE)) * coef(Specific_regression_4)["Log.GDP.per.capita"],
         Social.support.cont = (Social.support - min(specific_WHR_summary_4$Social.support, na.rm = TRUE)) * coef(Specific_regression_4)["Social.support"],
         Healthy.life.expectancy.at.birth.cont = (Healthy.life.expectancy.at.birth - min(specific_WHR_summary_4$Healthy.life.expectancy.at.birth, na.rm = TRUE)) * coef(Specific_regression_4)["Healthy.life.expectancy.at.birth"],
         Freedom.to.make.life.choices.cont = (Freedom.to.make.life.choices - min(specific_WHR_summary_4$Freedom.to.make.life.choices, na.rm = TRUE)) * coef(WHR_regression)["Freedom.to.make.life.choices"],
         Generosity.cont = (Generosity - min(specific_WHR_summary_4$Generosity, na.rm = TRUE)) * coef(Specific_regression_4)["Generosity"],
         Perceptions.of.corruption.cont = (Perceptions.of.corruption - max(specific_WHR_summary_4$Perceptions.of.corruption, na.rm = TRUE)) * coef(Specific_regression_4)["Perceptions.of.corruption"])
```

Group 5: Over 74
```{r}
# Creating WHR_data_across_years equivalent for age group 5 for regression
age_specific_scores_5  <- gallup_main %>% 
  filter(age_group == "Over 74") %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_specific_scores_5) <- c("COUNTRY_ISO3", "year", "AS.LS")

# Merge with WHR_data_across_years, remove missing values for regression 
Specific_regression_data_5 <- merge(WHR_data_across_years, age_specific_scores_5, by=c("year","COUNTRY_ISO3")) 

# Perform regression
Specific_regression_5 <- feols(
  # The dependent variable is 'AS.LS'.
  AS.LS ~ 
  # The independent variables are six determinants of well-being.
  Log.GDP.per.capita +
  Social.support +
  Healthy.life.expectancy.at.birth +
  Freedom.to.make.life.choices +
  Generosity +
  Perceptions.of.corruption |
  # Introduce fixed effects for 'year'.
  year, 
  data = Specific_regression_data_5)

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_specific_ranking_5  <- gallup_main %>% 
  filter(age_group == "Over 74",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, COUNTRYNEW) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_specific_ranking_5) <- c("COUNTRY_ISO3", "Country.name", "AS.LS")

specific_WHR_summary_5 <- merge(WHR_data_fig, age_specific_ranking_5, by="COUNTRY_ISO3") %>% 
  mutate(AS_rank = rank(-AS.LS)) 

specific_contributions_5 <- specific_WHR_summary_5 %>% 
  mutate(Log.GDP.per.capita.cont = (Log.GDP.per.capita - min(specific_WHR_summary_5$Log.GDP.per.capita, na.rm = TRUE)) * coef(Specific_regression_5)["Log.GDP.per.capita"],
         Social.support.cont = (Social.support - min(specific_WHR_summary_5$Social.support, na.rm = TRUE)) * coef(Specific_regression_5)["Social.support"],
         Healthy.life.expectancy.at.birth.cont = (Healthy.life.expectancy.at.birth - min(specific_WHR_summary_5$Healthy.life.expectancy.at.birth, na.rm = TRUE)) * coef(Specific_regression_5)["Healthy.life.expectancy.at.birth"],
         Freedom.to.make.life.choices.cont = (Freedom.to.make.life.choices - min(specific_WHR_summary_5$Freedom.to.make.life.choices, na.rm = TRUE)) * coef(WHR_regression)["Freedom.to.make.life.choices"],
         Generosity.cont = (Generosity - min(specific_WHR_summary_5$Generosity, na.rm = TRUE)) * coef(Specific_regression_5)["Generosity"],
         Perceptions.of.corruption.cont = (Perceptions.of.corruption - max(specific_WHR_summary_5$Perceptions.of.corruption, na.rm = TRUE)) * coef(Specific_regression_5)["Perceptions.of.corruption"])
```

Distributional Plots
```{r}
hist(WHR_AS_comparison$Life.Ladder, col=rgb(1,0,0,0.5), xlim=c(0,10), breaks = 30, main="Overlapping Histogram (Blue: WHR Score, Red: AS Score)", xlab="Variable")
hist(WHR_AS_comparison$AS_score, col=rgb(0,0,1,0.5), breaks = 30, add=T)
box()
```