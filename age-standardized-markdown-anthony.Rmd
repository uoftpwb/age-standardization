---
title: "age-standardized-markdown"
output: html_document
date: "2023-10-27"
---

The following code will run the neccesary analysis code  for the Age Standardization of Wellbeing project by Makoto Takahara, Anthony McCanny and Felix Cheung. 

Running this file straight thorugh from beginning to end should succesfully complete all analysis. 

The required file structure for running this code is a parent folder which includes three folders "Data", "Output" and "age-standardization", the latter of which will hold the code including the file you are currently reading. "Data" requires the files that are listed in the Data folder on the Sharepoint for internal users of this code, and the files in the Data file of the replication package for external users.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load required packages
library(dplyr)
library(tidyr)
library(fixest)
library(countrycode)
library(ggalluvial)
library(reshape2)
library(data.table)
library(GGally)
library(maps)
library(viridis)
library(multcomp)

# Set working directory to the parent directory of the current directory this file is in
setwd(dirname(dirname(dirname(rstudioapi::getActiveDocumentContext()$path))))
```

**Replicating World Happiness Report 2023, Chapter 2**
Our final intention is to replicate the aggregation and visualization methods in Chapter 2 of the World Happiness Report 2023 but with age standardized averages instead of global averages.

In order to accomplish this we need to backwards engineer the exact code required to replicate their process. We do this first to verify the method, and then replicate with age-standardized averages in the next section.


### Reading WHR Data
```{r}

# Load the World Happiness Report data from the CSV file
WHR_data_across_years <- read.csv("Data/WHR2023Table.csv")

# Create a summary of life ladder and raw data for predictors, using weighted mean
# Filter the data for the years 2020 to 2022, group the data by country name, and calculate the weighted mean for each predictor, removing NA values
WHR_summary <- WHR_data_across_years %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(Life.Ladder = weighted.mean(Life.Ladder, n),
            Log.GDP.per.capita = weighted.mean(Log.GDP.per.capita, n, na.rm = TRUE),
            Social.support = weighted.mean(Social.support, n, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = weighted.mean(Healthy.life.expectancy.at.birth, n, na.rm = TRUE),
            Freedom.to.make.life.choices = weighted.mean(Freedom.to.make.life.choices, n, na.rm = TRUE),
            Generosity = weighted.mean(Generosity, n, na.rm = TRUE),
            Perceptions.of.corruption = weighted.mean(Perceptions.of.corruption, n, na.rm = TRUE))
```


### Regression of Life Ladder to 6 predictors

Following the approach of the World Happiness Report 2023 we run a regression of life satisfaction on the six determinants of well-being suggested in the report, introducing fixed effects for year and clustering standard errors by country.

```{r}
# Run a fixed effects regression model using the 'feols' function from the 'fixest' package.
WHR_regression <- feols(
  # The dependent variable is 'Life.Ladder'.
  Life.Ladder ~ 
  # The independent variables are six determinants of well-being.
  Log.GDP.per.capita +
  Social.support +
  Healthy.life.expectancy.at.birth +
  Freedom.to.make.life.choices +
  Generosity +
  Perceptions.of.corruption |
  # Introduce fixed effects for 'year'.
  year, 
  # The data source is 'WHR_data_across_years'.
  data = WHR_data_across_years
)

# Display the summary of the regression model, clustering standard errors by country
summary(WHR_regression, cluster = "Country.name")
```


### Creating Dystopia

In the presentation of the WHR2023 data, the contribution to wellbeing from each factor is calculated as the difference from the contribution for the country with the lowest level of that factor (or the highest if the effect is negative). We calculate that value here.

```{r}
# Reading the cleaned Gallup World Poll data "DataForFigure2.1WHR2023.xls" from the "Data" directory
WHR_data_fig <- readxl::read_excel("Data/DataForFigure2.1WHR2023.xls")%>%
  # Renaming the columns to more convenient names
  rename(
    Country.name = `Country name`,
    Life.Ladder = `Ladder score`,
    Log.GDP.per.capita = `Logged GDP per capita`,
    Social.support = `Social support`,
    Healthy.life.expectancy.at.birth = `Healthy life expectancy`,
    Freedom.to.make.life.choices = `Freedom to make life choices`,
    Generosity = Generosity,
    Perceptions.of.corruption = `Perceptions of corruption`,
    Log.GDP.per.capita.cont = `Explained by: Log GDP per capita`,
    Social.support.cont = `Explained by: Social support`,
    Healthy.life.expectancy.at.birth.cont = `Explained by: Healthy life expectancy`,
    Freedom.to.make.life.choices.cont = `Explained by: Freedom to make life choices`,
    Generosity.cont = `Explained by: Generosity`,
    Perceptions.of.corruption.cont = `Explained by: Perceptions of corruption`
  ) %>%
# Adding a new row named "Dystopia" with minimum values for each column (except for Perceptions.of.corruption, where we take the maximum because the coefficient is negative)
  add_row(
    Country.name = "Dystopia",
    Log.GDP.per.capita = min(.$Log.GDP.per.capita, na.rm = TRUE),
    Social.support = min(.$Social.support, na.rm = TRUE),
    Healthy.life.expectancy.at.birth = min(.$Healthy.life.expectancy.at.birth, na.rm = TRUE),
    Freedom.to.make.life.choices = min(.$Freedom.to.make.life.choices, na.rm = TRUE),
    Generosity = min(.$Generosity, na.rm = TRUE),
    Perceptions.of.corruption = max(.$Perceptions.of.corruption, na.rm = TRUE)
  )
```

### Check that our calculations for means and contributions match those reported in the summary table by WHR2023

```{r}
# We calculate the contribution to wellbeing from each factor as the difference from the contribution for the country with the lowest level of that factor (or the highest if the effect is negative)
# We then merge this data with the WHR_data_fig data frame
merged_data <- WHR_summary %>%
  mutate(Log.GDP.per.capita.cont = (Log.GDP.per.capita - min(WHR_data_fig$Log.GDP.per.capita, na.rm = TRUE)) * coef(WHR_regression)["Log.GDP.per.capita"],
         Social.support.cont = (Social.support - min(WHR_data_fig$Social.support, na.rm = TRUE)) * coef(WHR_regression)["Social.support"],
         Healthy.life.expectancy.at.birth.cont = (Healthy.life.expectancy.at.birth - min(WHR_data_fig$Healthy.life.expectancy.at.birth, na.rm = TRUE)) * coef(WHR_regression)["Healthy.life.expectancy.at.birth"],
         Freedom.to.make.life.choices.cont = (Freedom.to.make.life.choices - min(WHR_data_fig$Freedom.to.make.life.choices, na.rm = TRUE)) * coef(WHR_regression)["Freedom.to.make.life.choices"],
         Generosity.cont = (Generosity - min(WHR_data_fig$Generosity, na.rm = TRUE)) * coef(WHR_regression)["Generosity"],
         Perceptions.of.corruption.cont = (Perceptions.of.corruption - max(WHR_data_fig$Perceptions.of.corruption, na.rm = TRUE)) * coef(WHR_regression)["Perceptions.of.corruption"]) %>%
  merge(WHR_data_fig, by.x = "Country.name", by.y = "Country.name", all = TRUE)

# We calculate the difference between the WHR reported and the calculated values for each determinant of wellbeing
# We then summarize these differences, calculating the mean and max difference, and the country with the max difference for each determinant
comparison <- merged_data %>% 
  drop_na() %>%
  mutate(Difference.Life.Ladder = Life.Ladder.x - Life.Ladder.y,
         Difference.Log.GDP.per.capita = Log.GDP.per.capita.x - Log.GDP.per.capita.y,
         Difference.Social.support = Social.support.x - Social.support.y,
         Difference.Healthy.life.expectancy.at.birth = Healthy.life.expectancy.at.birth.x - Healthy.life.expectancy.at.birth.y,
         Difference.Freedom.to.make.life.choices = Freedom.to.make.life.choices.x - Freedom.to.make.life.choices.y,
         Difference.Generosity = Generosity.x - Generosity.y,
         Difference.Perceptions.of.corruption = Perceptions.of.corruption.x - Perceptions.of.corruption.y,
         Difference.Log.GDP.per.capita.cont = Log.GDP.per.capita.cont.x - Log.GDP.per.capita.cont.y,
         Difference.Social.support.cont = Social.support.cont.x - Social.support.cont.y,
         Difference.Healthy.life.expectancy.at.birth.cont = Healthy.life.expectancy.at.birth.cont.x - Healthy.life.expectancy.at.birth.cont.y,
         Difference.Freedom.to.make.life.choices.cont = Freedom.to.make.life.choices.cont.x - Freedom.to.make.life.choices.cont.y,
         Difference.Generosity.cont = Generosity.cont.x - Generosity.cont.y,
         Difference.Perceptions.of.corruption.cont = Perceptions.of.corruption.cont.x - Perceptions.of.corruption.cont.y) %>%
  summarise(across(starts_with("Difference."), list(mean = ~mean(abs(.x)), max = ~max(abs(.x)), country_with_max_diff = ~Country.name[which.max(abs(.x))])))

# We then format this data for presentation, pivoting the data to a long format, separating the variable names into separate columns, and then pivoting back to a wide format
# We then create a table with the data, adding styling for better readability
library(kableExtra)
comparison %>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Values") %>%
  separate(Variable, into = c("Variable", "Statistic"), sep = "_", extra = "merge") %>%
  mutate(Variable = case_when(
    Variable == "Difference.Life.Ladder" ~ "Life Satisfaction",
    Variable == "Difference.Log.GDP.per.capita" ~ "Log GDP per Capita",
    Variable == "Difference.Social.support" ~ "Social Support",
    Variable == "Difference.Healthy.life.expectancy.at.birth" ~ "Healthy Life Expectancy at Birth",
    Variable == "Difference.Freedom.to.make.life.choices" ~ "Freedom to Make Life Choices",
    Variable == "Difference.Generosity" ~ "Generosity",
    Variable == "Difference.Perceptions.of.corruption" ~ "Perceptions of Corruption",
    Variable == "Difference.Log.GDP.per.capita.cont" ~ "Log GDP per Capita Contribution",
    Variable == "Difference.Social.support.cont" ~ "Social Support Contribution",
    Variable == "Difference.Healthy.life.expectancy.at.birth.cont" ~ "Healthy Life Expectancy at Birth Contribution",
    Variable == "Difference.Freedom.to.make.life.choices.cont" ~ "Freedom to Make Life Choices Contribution",
    Variable == "Difference.Generosity.cont" ~ "Generosity Contribution",
    Variable == "Difference.Perceptions.of.corruption.cont" ~ "Perceptions of Corruption Contribution",
    TRUE ~ Variable
  )) %>%
  pivot_wider(names_from = Statistic, values_from = Values) %>%
  kable(caption = "Comparison of Differences") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

We note that most absolute differences between our calculated mean values across life satisfaction and the six determinants of well-being and the values posted by the WHR are less than 0.001 which can be accounted for by rounding errors from published statistics rounded to the third decimal place. There are some countries where we see differences up to 0.025, which is too large to be accounted for by rounding errors. It is still not a large change, but indicates some difference between methods. We expect that these changes originate from restricting the sample to individuals with no missing values across all variables of interest, including life satisfaction and the questions concerning social support, generosity and freedom of choice. This assertion is supported by the fact that it is in these values where we see the largest discrepancies. 

# Age-standardized Life-satisfaction Ranking


### Reading Gallup data and establishing age groups
```{r}
# Load the cleaned Gallup World Poll data
gallup_main <- readRDS("Data/(231101)GWP_cleaned_ageStandardizedWellbeing.rds")

# Create a new column 'Weighted.LS' by multiplying 'WGT' and 'WP16' columns, converting the result to numeric
gallup_main$Weighted.LS <- as.numeric(gallup_main$WGT*gallup_main$WP16)

# Add a new column 'age_group' to the data, categorizing the 'WP1220' column into age groups
gallup_main <- gallup_main %>% 
  mutate(
    age_group = case_when(
      WP1220 > 14 & WP1220 <= 29 ~ "15-29", # Age group 15-29
      WP1220 > 29 & WP1220 <= 44 ~ "30-44", # Age group 30-44
      WP1220 > 44 & WP1220 <= 59 ~ "45-59", # Age group 45-59
      WP1220 > 59 & WP1220 <= 74 ~ "60-74", # Age group 60-74
      WP1220 > 74 ~ "Over 75")) # Age group Over 75
```

Creating Age-Standardized Life-Satisfaction Ranking
```{r}

# Define the standard population weights for each age group. These weights are used to adjust the data for age standardization.
# Standard population by WHO includes from age 0. Thus, these weights are reweighted to be only from Age 15 or above. Some rounding error means that these add up to 1.000474. This isn't a concern as weighted means will reweight all weights to equal 1 automatically.
standard_population <- c(0.3333784699, 0.2890995261, 0.2161137441, 0.1203791469, 0.04150304671)

# Calculate the weighted mean life satisfaction (WP16) for each country, year, and age group in the Gallup data from 2020 to 2022.
gallup_means <- gallup_main %>%
  filter(YEAR_WAVE %in% 2020:2022) %>%
  group_by(COUNTRY_ISO3, YEAR_WAVE, age_group) %>%
  summarise(WeightedMeanLS = weighted.mean(WP16,WGT, na.rm=TRUE), n=n(), .groups = "drop") %>%
  filter(!(age_group=="NA")) %>%
  # Assign the standard population weights to the corresponding age groups.
  mutate(
    standard_population = case_when(
      age_group == "15-29" ~ standard_population[1], 
      age_group == "30-44" ~ standard_population[2],
      age_group == "45-59" ~ standard_population[3], 
      age_group == "60-74" ~ standard_population[4], 
      age_group == "Over 75" ~ standard_population[5])) 

# Calculate the weighted mean life satisfaction for each country and year, considering all age groups together.
gallup_means <- gallup_means %>% 
  bind_rows(
    gallup_means %>%
      group_by(COUNTRY_ISO3, YEAR_WAVE) %>%
      summarise(WeightedMeanLS = weighted.mean(WeightedMeanLS, standard_population, na.rm=TRUE),
             n = sum(n),
             age_group = "allPopulation",
             standard_population = 1)
  )

# Calculate the weighted mean life satisfaction for each country and age group, considering all years together.
gallup_across_years <- gallup_means %>%
  group_by(COUNTRY_ISO3, age_group) %>%
  summarise(WeightedMeanLS = weighted.mean(WeightedMeanLS, n, na.rm=T), .groups = "drop")

```

Comparing with WHR ranking
```{r}
# Compare AS scores and ranks with WHR scores and ranks
age_standardized_ranking$AS_score <- as.numeric(
  age_standardized_ranking$AS_score)
age_standardized_ranking$AS_rank <- rank(-age_standardized_ranking$AS_score)

WHR_AS_comparison <- merge(WHR_ranking_summary, age_standardized_ranking, by="COUNTRY_ISO3", all=FALSE)
# Number of Countries in WHR is 137, AS is 143, so fixing AS ranking to the 137 countries for the sake of comparison
WHR_AS_comparison$AS_rank <- rank(-WHR_AS_comparison$AS_score)

WHR_AS_comparison$rank_difference <- (WHR_AS_comparison$WHR_rank -
                                        WHR_AS_comparison$AS_rank)
WHR_AS_comparison$score_difference <- (WHR_AS_comparison$AS_score -
                                         WHR_AS_comparison$WHR_score)
```

Merging Data for Regression Analysis
```{r}
# age_matrix contains life satisfaction for each age group in each country-year
#age_matrix <- gallup_main %>%
#  filter(!is.na(age_group)) %>% 
#  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
#  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
#  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
#  arrange(YEAR_CALENDAR, age_group) 

#Old version of age_matrix
age_matrix <- gallup_main %>%
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = weighted.mean(WP16, WGT, na.rm=T)) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group)

# "compressed" age_matrix so that each cell is age-standardized life satisfaction for every country-year
age_standardized_scores_wide <- age_matrix  %>%
  group_by(YEAR_CALENDAR) %>%
  summarise(across(AFG:ZWE, ~ weighted.mean(.x, standard_population)))
age_standardized_scores <- gather(age_standardized_scores_wide, COUNTRY_ISO3, AS.LS, AFG:ZWE)
colnames(age_standardized_scores) <- c("year", "COUNTRY_ISO3", "AS.LS", "Country.name")

# Standardized_WHR_data is age standardized version of WHR data, containing age-standardized life satisfaction and raw data for 6 predictors for each country-year
WHR_data$COUNTRY_ISO3 <- countrycode(WHR_data$Country.name, 'country.name', 'iso3c')
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Kosovo"] <- "XKX"
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Turkiye"] <- "TUR" 
Standardized_WHR_data <- merge(WHR_data, age_standardized_scores, by=c("year","COUNTRY_ISO3"))
```

Age Standardized Regression Analysis
```{r}
# Remove missing values for regression
Standardized_regression_data <- Standardized_WHR_data %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
              Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
              Generosity+Perceptions.of.corruption, data = Standardized_regression_data,
            index = c("year","Country.name"), model="within")
```

Creating Dystopia in Standardized Context
```{r}
# Summary of age-standardized life satisfaction + raw data for predictors for years of interest (2020-2022)
Standardized_WHR_summary <- merge(WHR_summary, age_standardized_ranking, by="Country.name")

# Create Dystopia for the age-standardized summary data. This should be the same as non-age-standardized summary
Standardized_WHR_summary[, 2] <- Standardized_WHR_summary[, 10]
Standardized_WHR_summary <- Standardized_WHR_summary[, -c(9:11)]
Standardized_WHR_summary  <- rbind(Standardized_WHR_summary, WHR_summary[138,])
```

Calculate Contributions
```{r}
# Same as WHR. For each predictor, find the distance of the country's value from Dystopia's value. This is necessary to determine how much it contributes to the LS score. This is done by multiplying the distance from Dystopia by the coefficient corresponding to that predictor. 

standardized_distance_from_dystopia <- cbind(WHR_summary %>% 
                                  dplyr::select(Country.name) %>% 
                                  filter(Country.name != "Dystopia"),
                                (Standardized_WHR_summary[1:137, 3:8] - Standardized_WHR_summary[rep(138, 137), 3:8]))

standardized_contributions <- standardized_distance_from_dystopia$Country.name
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[2] * coef(summary(Standardized_regression))[1,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[3] * coef(summary(Standardized_regression))[2,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[4] * coef(summary(Standardized_regression))[3,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[5] * coef(summary(Standardized_regression))[4,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[6] * coef(summary(Standardized_regression))[5,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[7] * coef(summary(Standardized_regression))[6,1])

standardized_contributions$sum <- apply(standardized_contributions[,-1], 1, sum) 
ASLS <- Standardized_WHR_summary[1:2]
standardized_contributions <- merge(standardized_contributions, ASLS, 
                                    by.x="standardized_contributions",
                                    by.y="Country.name")

standardized_contributions[standardized_contributions$standardized_contributions=="Saudi Arabia", "AS.LS"] <-
  6.463708


standardized_contributions$residual <- standardized_contributions$AS.LS - standardized_contributions$sum
standardized_contributions <- standardized_contributions[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions)[names(standardized_contributions) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions$Rank <- rank(-standardized_contributions$AS.LS)
```

**Age-specific Life-satisfaction**
Group 1: 15 to 29
```{r}
# Creating WHR_data equivalent for age group 1 for regression
age_standardized_scores_1  <- gallup_main %>% 
  filter(age_group == "15-29") %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_scores_1) <- c("COUNTRY_ISO3", "year", "AS.LS")

# Merge with WHR data, remove missing values for regression 
Standardized_regression_data_1 <- merge(WHR_data, age_standardized_scores_1, by=c("year","COUNTRY_ISO3")) %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_1 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                    Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                    Generosity+Perceptions.of.corruption, data = Standardized_regression_data_1,
                  index = c("year","Country.name"), model="within")

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_standardized_ranking_1  <- gallup_main %>% 
  filter(age_group == "15-29",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_ranking_1) <- c("COUNTRY_ISO3", "AS.LS")

# Rename for merging later on
age_standardized_ranking_1$Country.name <- countrycode(age_standardized_ranking_1$COUNTRY_ISO3, 'iso3c', 'country.name')
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$COUNTRY_ISO3=="XKX"] <- "Kosovo"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$COUNTRY_ISO3=="XNC"] <- "North Cyprus"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$Country.name=="Bosnia & Herzegovina"] <- "Bosnia and Herzegovina"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$Country.name=="Congo - Kinshasa"] <- "Congo (Kinshasa)"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$Country.name=="Congo - Brazzaville"] <- "Congo (Brazzaville)"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$Country.name=="Hong Kong SAR China"] <- "Hong Kong S.A.R. of China"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$Country.name== "Côte d’Ivoire"] <- "Ivory Coast"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$Country.name=="Myanmar (Burma)"] <- "Myanmar"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$Country.name=="Taiwan"] <- "Taiwan Province of China"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$Country.name=="Turkey"] <- "Turkiye"
age_standardized_ranking_1$Country.name[age_standardized_ranking_1$Country.name=="Palestinian Territories"] <- "State of Palestine"

standardized_WHR_summary_1  <- merge(WHR_summary, age_standardized_ranking_1, by="Country.name")

# Create Dystopia for the age-standardized summary data. This should be the same as non-age-standardized summary
standardized_WHR_summary_1 [, 2] <- standardized_WHR_summary_1[, 10]
standardized_WHR_summary_1  <- standardized_WHR_summary_1 [, -c(9:11)]
standardized_WHR_summary_1   <- rbind(standardized_WHR_summary_1 , WHR_summary[138,])

#Finding contributions
distance_from_dystopia_1 <- cbind(WHR_summary %>% 
                                                 dplyr::select(Country.name) %>% 
                                                 filter(Country.name != "Dystopia"),
                                               (standardized_WHR_summary_1[1:137, 3:8] - standardized_WHR_summary_1[rep(138, 137), 3:8]))

standardized_contributions_1 <- distance_from_dystopia_1$Country.name
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[2] * coef(summary(Standardized_regression_1))[1,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[3] * coef(summary(Standardized_regression_1))[2,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[4] * coef(summary(Standardized_regression_1))[3,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[5] * coef(summary(Standardized_regression_1))[4,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[6] * coef(summary(Standardized_regression_1))[5,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[7] * coef(summary(Standardized_regression_1))[6,1])

standardized_contributions_1$sum <- apply(standardized_contributions_1[,-1], 1, sum) 
ASLS_1 <- standardized_WHR_summary_1[1:2]
standardized_contributions_1 <- merge(standardized_contributions_1, ASLS_1, 
                                          by.x="standardized_contributions_1",
                                          by.y="Country.name")

standardized_contributions_1$residual <- standardized_contributions_1$Life.Ladder - standardized_contributions_1$sum
standardized_contributions_1 <- standardized_contributions_1[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_1)[names(standardized_contributions_1) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_1$Rank <- rank(-standardized_contributions_1$Life.Ladder)

gallup_main_1 <- gallup_main %>% 
  filter(age_group == "15-29",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRYNEW) %>%
  summarize(n = n())

gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Bosnia Herzegovina"] <- "Bosnia and Herzegovina"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Congo Brazzaville"] <- "Congo (Brazzaville)"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Congo Kinshasa"] <- "Congo (Kinshasa)"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Czech Republic"] <- "Czechia"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Hong Kong"] <- "Hong Kong S.A.R. of China"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Kuwait"] <- "Kuwait"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Lesotho"] <- "Lesotho"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Libya"] <- "Libya"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Northern Cyprus"] <- "North Cyprus"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Palestine"] <- "State of Palestine"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Puerto Rico"] <- "Puerto Rico"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Taiwan"] <- "Taiwan Province of China"
gallup_main_1$COUNTRYNEW[gallup_main_1$COUNTRYNEW == "Turkey"] <- "Turkiye"

standardized_contributions_1 <- merge(standardized_contributions_1, gallup_main_1, by.x="standardized_contributions_1", by.y="COUNTRYNEW")
```

Group 2: 30-44
```{r}
# Creating WHR_data equivalent for age group 1 for regression
age_standardized_scores_2  <- gallup_main %>% 
  filter(age_group == "30-44") %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_scores_2) <- c("COUNTRY_ISO3", "year", "AS.LS")

# Merge with WHR data, remove missing values for regression 
Standardized_regression_data_2 <- merge(WHR_data, age_standardized_scores_2, by=c("year","COUNTRY_ISO3")) %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_2 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                    Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                    Generosity+Perceptions.of.corruption, data = Standardized_regression_data_2,
                  index = c("year","Country.name"), model="within")

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_standardized_ranking_2  <- gallup_main %>% 
  filter(age_group == "30-44",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_ranking_2) <- c("COUNTRY_ISO3", "AS.LS")

# Rename for merging later on
age_standardized_ranking_2$Country.name <- countrycode(age_standardized_ranking_2$COUNTRY_ISO3, 'iso3c', 'country.name')
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$COUNTRY_ISO3=="XKX"] <- "Kosovo"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$COUNTRY_ISO3=="XNC"] <- "North Cyprus"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$Country.name=="Bosnia & Herzegovina"] <- "Bosnia and Herzegovina"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$Country.name=="Congo - Kinshasa"] <- "Congo (Kinshasa)"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$Country.name=="Congo - Brazzaville"] <- "Congo (Brazzaville)"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$Country.name=="Hong Kong SAR China"] <- "Hong Kong S.A.R. of China"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$Country.name== "Côte d’Ivoire"] <- "Ivory Coast"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$Country.name=="Myanmar (Burma)"] <- "Myanmar"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$Country.name=="Taiwan"] <- "Taiwan Province of China"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$Country.name=="Turkey"] <- "Turkiye"
age_standardized_ranking_2$Country.name[age_standardized_ranking_2$Country.name=="Palestinian Territories"] <- "State of Palestine"

standardized_WHR_summary_2  <- merge(WHR_summary, age_standardized_ranking_2, by="Country.name")

# Create Dystopia for the age-standardized summary data. This should be the same as non-age-standardized summary
standardized_WHR_summary_2 [, 2] <- standardized_WHR_summary_2[, 10]
standardized_WHR_summary_2  <- standardized_WHR_summary_2 [, -c(9:11)]
standardized_WHR_summary_2   <- rbind(standardized_WHR_summary_2 , WHR_summary[138,])

#Finding contributions
distance_from_dystopia_2 <- cbind(WHR_summary %>% 
                                                 dplyr::select(Country.name) %>% 
                                                 filter(Country.name != "Dystopia"),
                                               (standardized_WHR_summary_2[1:137, 3:8] - standardized_WHR_summary_2[rep(138, 137), 3:8]))

standardized_contributions_2 <- distance_from_dystopia_2$Country.name
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[2] * coef(summary(Standardized_regression_2))[1,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[3] * coef(summary(Standardized_regression_2))[2,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[4] * coef(summary(Standardized_regression_2))[3,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[5] * coef(summary(Standardized_regression_2))[4,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[6] * coef(summary(Standardized_regression_2))[5,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[7] * coef(summary(Standardized_regression_2))[6,1])

standardized_contributions_2$sum <- apply(standardized_contributions_2[,-1], 1, sum) 
ASLS_2 <- standardized_WHR_summary_2[1:2]
standardized_contributions_2 <- merge(standardized_contributions_2, ASLS_2, 
                                          by.x="standardized_contributions_2",
                                          by.y="Country.name")

standardized_contributions_2$residual <- standardized_contributions_2$Life.Ladder - standardized_contributions_2$sum
standardized_contributions_2 <- standardized_contributions_2[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_2)[names(standardized_contributions_2) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_2$Rank <- rank(-standardized_contributions_2$Life.Ladder)

gallup_main_2 <- gallup_main %>% 
  filter(age_group == "30-44",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRYNEW) %>%
  summarize(n = n())

gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Bosnia Herzegovina"] <- "Bosnia and Herzegovina"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Congo Brazzaville"] <- "Congo (Brazzaville)"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Congo Kinshasa"] <- "Congo (Kinshasa)"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Czech Republic"] <- "Czechia"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Hong Kong"] <- "Hong Kong S.A.R. of China"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Kuwait"] <- "Kuwait"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Lesotho"] <- "Lesotho"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Libya"] <- "Libya"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Northern Cyprus"] <- "North Cyprus"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Palestine"] <- "State of Palestine"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Puerto Rico"] <- "Puerto Rico"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Taiwan"] <- "Taiwan Province of China"
gallup_main_2$COUNTRYNEW[gallup_main_2$COUNTRYNEW == "Turkey"] <- "Turkiye"

standardized_contributions_2 <- merge(standardized_contributions_2, gallup_main_2, by.x="standardized_contributions_2", by.y="COUNTRYNEW")
```

Group 3: 45-59
```{r}
# Creating WHR_data equivalent for age group 1 for regression
age_standardized_scores_3  <- gallup_main %>% 
  filter(age_group == "45-59") %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_scores_3) <- c("COUNTRY_ISO3", "year", "AS.LS")

# Merge with WHR data, remove missing values for regression 
Standardized_regression_data_3 <- merge(WHR_data, age_standardized_scores_3, by=c("year","COUNTRY_ISO3")) %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_3 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                    Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                    Generosity+Perceptions.of.corruption, data = Standardized_regression_data_3,
                  index = c("year","Country.name"), model="within")

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_standardized_ranking_3  <- gallup_main %>% 
  filter(age_group == "45-59",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_ranking_3) <- c("COUNTRY_ISO3", "AS.LS")

# Rename for merging later on
age_standardized_ranking_3$Country.name <- countrycode(age_standardized_ranking_3$COUNTRY_ISO3, 'iso3c', 'country.name')
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$COUNTRY_ISO3=="XKX"] <- "Kosovo"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$COUNTRY_ISO3=="XNC"] <- "North Cyprus"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$Country.name=="Bosnia & Herzegovina"] <- "Bosnia and Herzegovina"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$Country.name=="Congo - Kinshasa"] <- "Congo (Kinshasa)"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$Country.name=="Congo - Brazzaville"] <- "Congo (Brazzaville)"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$Country.name=="Hong Kong SAR China"] <- "Hong Kong S.A.R. of China"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$Country.name== "Côte d’Ivoire"] <- "Ivory Coast"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$Country.name=="Myanmar (Burma)"] <- "Myanmar"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$Country.name=="Taiwan"] <- "Taiwan Province of China"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$Country.name=="Turkey"] <- "Turkiye"
age_standardized_ranking_3$Country.name[age_standardized_ranking_3$Country.name=="Palestinian Territories"] <- "State of Palestine"

standardized_WHR_summary_3  <- merge(WHR_summary, age_standardized_ranking_3, by="Country.name")

# Create Dystopia for the age-standardized summary data. This should be the same as non-age-standardized summary
standardized_WHR_summary_3 [, 2] <- standardized_WHR_summary_3[, 10]
standardized_WHR_summary_3  <- standardized_WHR_summary_3 [, -c(9:11)]
standardized_WHR_summary_3   <- rbind(standardized_WHR_summary_3 , WHR_summary[138,])

#Finding contributions
distance_from_dystopia_3 <- cbind(WHR_summary %>% 
                                                 dplyr::select(Country.name) %>% 
                                                 filter(Country.name != "Dystopia"),
                                               (standardized_WHR_summary_3[1:137, 3:8] - standardized_WHR_summary_3[rep(138, 137), 3:8]))

standardized_contributions_3 <- distance_from_dystopia_3$Country.name
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[2] * coef(summary(Standardized_regression_3))[1,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[3] * coef(summary(Standardized_regression_3))[2,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[4] * coef(summary(Standardized_regression_3))[3,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[5] * coef(summary(Standardized_regression_3))[4,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[6] * coef(summary(Standardized_regression_3))[5,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[7] * coef(summary(Standardized_regression_3))[6,1])

standardized_contributions_3$sum <- apply(standardized_contributions_3[,-1], 1, sum) 
ASLS_3 <- standardized_WHR_summary_3[1:2]
standardized_contributions_3 <- merge(standardized_contributions_3, ASLS_3, 
                                          by.x="standardized_contributions_3",
                                          by.y="Country.name")

standardized_contributions_3$residual <- standardized_contributions_3$Life.Ladder - standardized_contributions_3$sum
standardized_contributions_3 <- standardized_contributions_3[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_3)[names(standardized_contributions_3) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_3$Rank <- rank(-standardized_contributions_3$Life.Ladder)

gallup_main_3 <- gallup_main %>% 
  filter(age_group == "45-59",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRYNEW) %>%
  summarize(n = n())

# Manual mappings for gallup_main_3
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Bosnia Herzegovina"] <- "Bosnia and Herzegovina"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Congo Brazzaville"] <- "Congo (Brazzaville)"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Congo Kinshasa"] <- "Congo (Kinshasa)"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Czech Republic"] <- "Czechia"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Hong Kong"] <- "Hong Kong S.A.R. of China"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Kuwait"] <- "Kuwait"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Lesotho"] <- "Lesotho"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Libya"] <- "Libya"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Northern Cyprus"] <- "North Cyprus"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Palestine"] <- "State of Palestine"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Puerto Rico"] <- "Puerto Rico"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Taiwan"] <- "Taiwan Province of China"
gallup_main_3$COUNTRYNEW[gallup_main_3$COUNTRYNEW == "Turkey"] <- "Turkiye"

# Merge with standardized_contributions_3
standardized_contributions_3 <- merge(standardized_contributions_3, gallup_main_3, by.x="standardized_contributions_3", by.y="COUNTRYNEW")
```

Group 4: 60-74
```{r}
# Creating WHR_data equivalent for age group 1 for regression
age_standardized_scores_4  <- gallup_main %>% 
  filter(age_group == "60-74") %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_scores_4) <- c("COUNTRY_ISO3", "year", "AS.LS")

# Merge with WHR data, remove missing values for regression 
Standardized_regression_data_4 <- merge(WHR_data, age_standardized_scores_4, by=c("year","COUNTRY_ISO3")) %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_4 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                    Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                    Generosity+Perceptions.of.corruption, data = Standardized_regression_data_4,
                  index = c("year","Country.name"), model="within")

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_standardized_ranking_4  <- gallup_main %>% 
  filter(age_group == "60-74",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_ranking_4) <- c("COUNTRY_ISO3", "AS.LS")

# Rename for merging later on
age_standardized_ranking_4$Country.name <- countrycode(age_standardized_ranking_4$COUNTRY_ISO3, 'iso3c', 'country.name')
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$COUNTRY_ISO3=="XKX"] <- "Kosovo"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$COUNTRY_ISO3=="XNC"] <- "North Cyprus"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$Country.name=="Bosnia & Herzegovina"] <- "Bosnia and Herzegovina"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$Country.name=="Congo - Kinshasa"] <- "Congo (Kinshasa)"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$Country.name=="Congo - Brazzaville"] <- "Congo (Brazzaville)"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$Country.name=="Hong Kong SAR China"] <- "Hong Kong S.A.R. of China"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$Country.name== "Côte d’Ivoire"] <- "Ivory Coast"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$Country.name=="Myanmar (Burma)"] <- "Myanmar"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$Country.name=="Taiwan"] <- "Taiwan Province of China"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$Country.name=="Turkey"] <- "Turkiye"
age_standardized_ranking_4$Country.name[age_standardized_ranking_4$Country.name=="Palestinian Territories"] <- "State of Palestine"

standardized_WHR_summary_4  <- merge(WHR_summary, age_standardized_ranking_4, by="Country.name")

# Create Dystopia for the age-standardized summary data. This should be the same as non-age-standardized summary
standardized_WHR_summary_4 [, 2] <- standardized_WHR_summary_4[, 10]
standardized_WHR_summary_4  <- standardized_WHR_summary_4 [, -c(9:11)]
standardized_WHR_summary_4   <- rbind(standardized_WHR_summary_4 , WHR_summary[138,])

#Finding contributions
distance_from_dystopia_4 <- cbind(WHR_summary %>% 
                                                 dplyr::select(Country.name) %>% 
                                                 filter(Country.name != "Dystopia"),
                                               (standardized_WHR_summary_4[1:137, 3:8] - standardized_WHR_summary_4[rep(138, 137), 3:8]))

standardized_contributions_4 <- distance_from_dystopia_4$Country.name
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[2] * coef(summary(Standardized_regression_4))[1,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[3] * coef(summary(Standardized_regression_4))[2,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[4] * coef(summary(Standardized_regression_4))[3,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[5] * coef(summary(Standardized_regression_4))[4,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[6] * coef(summary(Standardized_regression_4))[5,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[7] * coef(summary(Standardized_regression_4))[6,1])

standardized_contributions_4$sum <- apply(standardized_contributions_4[,-1], 1, sum) 
ASLS_4 <- standardized_WHR_summary_4[1:2]
standardized_contributions_4 <- merge(standardized_contributions_4, ASLS_4, 
                                          by.x="standardized_contributions_4",
                                          by.y="Country.name")

standardized_contributions_4$residual <- standardized_contributions_4$Life.Ladder - standardized_contributions_4$sum
standardized_contributions_4 <- standardized_contributions_4[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_4)[names(standardized_contributions_4) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_4$Rank <- rank(-standardized_contributions_4$Life.Ladder)

# Filter and summarize for gallup_main_4
gallup_main_4 <- gallup_main %>% 
  filter(age_group == "60-74",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRYNEW) %>%
  summarize(n = n())

# Manual mappings for gallup_main_4
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Bosnia Herzegovina"] <- "Bosnia and Herzegovina"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Congo Brazzaville"] <- "Congo (Brazzaville)"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Congo Kinshasa"] <- "Congo (Kinshasa)"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Czech Republic"] <- "Czechia"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Hong Kong"] <- "Hong Kong S.A.R. of China"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Kuwait"] <- "Kuwait"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Lesotho"] <- "Lesotho"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Libya"] <- "Libya"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Northern Cyprus"] <- "North Cyprus"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Palestine"] <- "State of Palestine"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Puerto Rico"] <- "Puerto Rico"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Taiwan"] <- "Taiwan Province of China"
gallup_main_4$COUNTRYNEW[gallup_main_4$COUNTRYNEW == "Turkey"] <- "Turkiye"

# Merge with standardized_contributions_4
standardized_contributions_4 <- merge(standardized_contributions_4, gallup_main_4, by.x="standardized_contributions_4", by.y="COUNTRYNEW")

```

Group 5: Over 74
```{r}
# Creating WHR_data equivalent for age group 1 for regression
age_standardized_scores_5  <- gallup_main %>% 
  filter(age_group == "Over 75") %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_scores_5) <- c("COUNTRY_ISO3", "year", "AS.LS")

# Merge with WHR data, remove missing values for regression 
Standardized_regression_data_5 <- merge(WHR_data, age_standardized_scores_5, by=c("year","COUNTRY_ISO3")) %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_5 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                    Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                    Generosity+Perceptions.of.corruption, data = Standardized_regression_data_5,
                  index = c("year","Country.name"), model="within")

# Find age-standardized score for each age-group. No process of weighting by year because we are starting from Gallup individual data, meaning we end up with the same values through a simple average. 
age_standardized_ranking_5  <- gallup_main %>% 
  filter(age_group == "Over 75",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRY_ISO3) %>%
  summarize(AS.LS = sum(Weighted.LS)/sum(WGT))
colnames(age_standardized_ranking_5) <- c("COUNTRY_ISO3", "AS.LS")

# Rename for merging later on
age_standardized_ranking_5$Country.name <- countrycode(age_standardized_ranking_5$COUNTRY_ISO3, 'iso3c', 'country.name')
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$COUNTRY_ISO3=="XKX"] <- "Kosovo"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$COUNTRY_ISO3=="XNC"] <- "North Cyprus"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$Country.name=="Bosnia & Herzegovina"] <- "Bosnia and Herzegovina"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$Country.name=="Congo - Kinshasa"] <- "Congo (Kinshasa)"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$Country.name=="Congo - Brazzaville"] <- "Congo (Brazzaville)"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$Country.name=="Hong Kong SAR China"] <- "Hong Kong S.A.R. of China"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$Country.name== "Côte d’Ivoire"] <- "Ivory Coast"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$Country.name=="Myanmar (Burma)"] <- "Myanmar"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$Country.name=="Taiwan"] <- "Taiwan Province of China"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$Country.name=="Turkey"] <- "Turkiye"
age_standardized_ranking_5$Country.name[age_standardized_ranking_5$Country.name=="Palestinian Territories"] <- "State of Palestine"

standardized_WHR_summary_5  <- merge(WHR_summary, age_standardized_ranking_5, by="Country.name")

# Create Dystopia for the age-standardized summary data. This should be the same as non-age-standardized summary
standardized_WHR_summary_5 [, 2] <- standardized_WHR_summary_5[, 10]
standardized_WHR_summary_5  <- standardized_WHR_summary_5 [, -c(9:11)]
standardized_WHR_summary_5   <- rbind(standardized_WHR_summary_5 , WHR_summary[138,])

#Finding contributions
distance_from_dystopia_5 <- cbind(WHR_summary %>% 
                                                 dplyr::select(Country.name) %>% 
                                                 filter(Country.name != "Dystopia"),
                                               (standardized_WHR_summary_5[1:137, 3:8] - standardized_WHR_summary_5[rep(138, 137), 3:8]))

standardized_contributions_5 <- distance_from_dystopia_5$Country.name
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[2] * coef(summary(Standardized_regression_5))[1,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[3] * coef(summary(Standardized_regression_5))[2,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[4] * coef(summary(Standardized_regression_5))[3,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[5] * coef(summary(Standardized_regression_5))[4,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[6] * coef(summary(Standardized_regression_5))[5,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[7] * coef(summary(Standardized_regression_5))[6,1])

standardized_contributions_5$sum <- apply(standardized_contributions_5[,-1], 1, sum) 
ASLS_5 <- standardized_WHR_summary_5[1:2]
standardized_contributions_5 <- merge(standardized_contributions_5, ASLS_5, 
                                          by.x="standardized_contributions_5",
                                          by.y="Country.name")

standardized_contributions_5$Life.Ladder <- as.numeric(standardized_contributions_5$Life.Ladder)
standardized_contributions_5$residual <- standardized_contributions_5$Life.Ladder - standardized_contributions_5$sum
standardized_contributions_5 <- standardized_contributions_5[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_5)[names(standardized_contributions_5) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_5$Rank <- rank(-standardized_contributions_5$Life.Ladder)

# Filter and summarize for gallup_main_5
gallup_main_5 <- gallup_main %>% 
  filter(age_group == "Over 75",
         YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>% 
  drop_na(Weighted.LS) %>% 
  group_by(COUNTRYNEW) %>%
  summarize(n = n())

# Manual mappings for gallup_main_5
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Bosnia Herzegovina"] <- "Bosnia and Herzegovina"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Congo Brazzaville"] <- "Congo (Brazzaville)"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Congo Kinshasa"] <- "Congo (Kinshasa)"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Czech Republic"] <- "Czechia"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Hong Kong"] <- "Hong Kong S.A.R. of China"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Kuwait"] <- "Kuwait"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Lesotho"] <- "Lesotho"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Libya"] <- "Libya"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Northern Cyprus"] <- "North Cyprus"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Palestine"] <- "State of Palestine"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Puerto Rico"] <- "Puerto Rico"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Taiwan"] <- "Taiwan Province of China"
gallup_main_5$COUNTRYNEW[gallup_main_5$COUNTRYNEW == "Turkey"] <- "Turkiye"

# Merge with standardized_contributions_5
standardized_contributions_5 <- merge(standardized_contributions_5, gallup_main_5, by.x="standardized_contributions_5", by.y="COUNTRYNEW")

```

**Further Analysis**
Finding countries with significant changes
```{r}
significant_difference <- WHR_AS_comparison %>% 
  filter(score_difference >= 0.25 | score_difference <= -0.25)

significant_difference_countries <- significant_difference$COUNTRY_ISO3

sd(WHR_AS_comparison$WHR_score)
sd(WHR_AS_comparison$AS_score)
```

In these countries, younger people are happier and there are a lot of them. 
This means that as age-standardization decreases weight of younger people, scores decrease.

Serbia and Lebanon are outliers because they increase.
For Serbia, this is because there are more older people who are unhappy, so a decrease in their weights improves their score.
For Lebanon a trend is less clear - I think it is because happier younger people are weighted more in age-standardized score.

In terms of demographics, there are a few outliers to the pattern: UAE and Saudi Arabia, in addition to Serbia and Lebanon.
Both have more men around the ages of 30 to 70. 
Strictly in terms of population, there is a high proportion of middle age people, with these people being relatively happy. 
Thus, this middle age is weighted less in the age-standardized scores, leading to a lower score. 


Plotting coefficients for contributions
```{r}
data1 <- Standardized_regression_data_1[, -13:-15]
data1$age_group <- 1
data2 <- Standardized_regression_data_2[, -13:-15]
data2$age_group <- 2
data3 <- Standardized_regression_data_3[, -13:-15]
data3$age_group <- 3
data4 <- Standardized_regression_data_4[, -13:-15]
data4$age_group <- 4
data5 <- Standardized_regression_data_5[, -13:-15]
data5$age_group <- 5

big_regression_data <- bind_rows(data1, data2, data3, data4, data5)
big_regression_data$age_group <- as.factor(big_regression_data$age_group)

stanardized_big_regression_data <-data.frame(scale(big_regression_data[, 5:10]))
colnames(stanardized_big_regression_data) <- paste("Standard", colnames(stanardized_big_regression_data), sep = ".")
big_regression_data <- cbind(big_regression_data, stanardized_big_regression_data)

big_model <- plm(AS.LS ~ age_group*Standard.Log.GDP.per.capita + age_group*Standard.Social.support + 
               age_group*Standard.Healthy.life.expectancy.at.birth + 
               age_group*Standard.Freedom.to.make.life.choices + age_group*Standard.Generosity +
               age_group*Standard.Perceptions.of.corruption, data=big_regression_data, 
               index = c("year","Country.name"), model="within")

big_model_summary <- data.frame(summary(big_model)$coefficients)
big_model_summary <- big_model_summary[-1:-4,] 
big_model_summary$group <- c(1, 1, 1, 1, 1, 1, 2, 3, 4, 5, 2, 3, 4, 5,
                             2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5)
big_model_summary$group <- as.factor(big_model_summary$group)
big_model_summary$group <- c(1, 1, 1, 1, 1, 1, 2, 3, 4, 5, 2, 3, 4, 5,
                             2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5)
big_model_summary$variables <- c("Log.GDP.per.capita", "Social.support", 
                                 "Healthy.life.expectancy.at.birth", 
                                 "Freedom.to.make.life.choices",
                                 "Generosity", "Perceptions.of.corruption",
                                 "Log.GDP.per.capita", "Log.GDP.per.capita", 
                                 "Log.GDP.per.capita", "Log.GDP.per.capita",
                                 "Social.support", "Social.support", 
                                 "Social.support", "Social.support",
                                 "Healthy.life.expectancy.at.birth", 
                                 "Healthy.life.expectancy.at.birth", 
                                 "Healthy.life.expectancy.at.birth", 
                                 "Healthy.life.expectancy.at.birth", 
                                 "Freedom.to.make.life.choices",
                                 "Freedom.to.make.life.choices",
                                 "Freedom.to.make.life.choices",
                                 "Freedom.to.make.life.choices",
                                 "Generosity", "Generosity",
                                 "Generosity", "Generosity",
                                 "Perceptions.of.corruption",
                                 "Perceptions.of.corruption",
                                 "Perceptions.of.corruption",
                                 "Perceptions.of.corruption")
a <- big_model_summary$Estimate[1:6]
b <- as.numeric(a[1]) + as.numeric(big_model_summary$Estimate[7:10])
c <- as.numeric(a[2]) + as.numeric(big_model_summary$Estimate[11:14])
d <- as.numeric(a[3]) + as.numeric(big_model_summary$Estimate[15:18])
e <- as.numeric(a[4]) + as.numeric(big_model_summary$Estimate[19:22])
f <- as.numeric(a[5]) + as.numeric(big_model_summary$Estimate[23:26])
g <- as.numeric(a[6]) + as.numeric(big_model_summary$Estimate[27:30])
values <- c(a, b, c, d, e, f, g)
big_model_summary$values <- values

AS_coefficients_plot <- ggplot(big_model_summary, 
                               aes(fill=variables, y=values, x=group)) + 
  geom_bar(position="stack", stat="identity")
AS_coefficients_plot
```
Hypothesis Tests
```{r}
joint_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Log.GDP.per.capita +
                                              age_group2:Standard.Social.support +
                                              age_group2:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group2:Standard.Freedom.to.make.life.choices +                                                                      age_group2:Standard.Generosity -
                                              age_group2:Standard.Perceptions.of.corruption = 0"))

joint_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Log.GDP.per.capita + 
                                              age_group3:Standard.Social.support +
                                              age_group3:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group3:Standard.Freedom.to.make.life.choices + 
                                              age_group3:Standard.Generosity -
                                              age_group3:Standard.Perceptions.of.corruption -
                                              age_group2:Standard.Log.GDP.per.capita - 
                                              age_group2:Standard.Social.support -
                                              age_group2:Standard.Healthy.life.expectancy.at.birth - 
                                              age_group2:Standard.Freedom.to.make.life.choices - 
                                              age_group2:Standard.Generosity +
                                              age_group2:Standard.Perceptions.of.corruption = 0"))

joint_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Log.GDP.per.capita + 
                                              age_group4:Standard.Social.support +
                                              age_group4:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group4:Standard.Freedom.to.make.life.choices + 
                                              age_group4:Standard.Generosity -
                                              age_group4:Standard.Perceptions.of.corruption -
                                              age_group3:Standard.Log.GDP.per.capita - 
                                              age_group3:Standard.Social.support - 
                                              age_group3:Standard.Healthy.life.expectancy.at.birth - 
                                              age_group3:Standard.Freedom.to.make.life.choices - 
                                              age_group3:Standard.Generosity +
                                              age_group3:Standard.Perceptions.of.corruption = 0"))

joint_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita + 
                                              age_group5:Standard.Social.support +
                                              age_group5:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group5:Standard.Freedom.to.make.life.choices +
                                              age_group5:Standard.Generosity -
                                              age_group5:Standard.Perceptions.of.corruption -
                                              age_group4:Standard.Log.GDP.per.capita - 
                                              age_group4:Standard.Social.support -
                                              age_group4:Standard.Healthy.life.expectancy.at.birth - 
                                              age_group4:Standard.Freedom.to.make.life.choices - 
                                              age_group4:Standard.Generosity +
                                              age_group4:Standard.Perceptions.of.corruption = 0"))

joint_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita +
                                              age_group5:Standard.Social.support +
                                              age_group5:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group5:Standard.Freedom.to.make.life.choices +                                                                      age_group5:Standard.Generosity -
                                              age_group5:Standard.Perceptions.of.corruption = 0"))

gdp_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Log.GDP.per.capita -
                                          age_group2:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Log.GDP.per.capita -
                                          age_group3:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita -
                                          age_group4:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita = 0"))

ss_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Social.support = 0"))
ss_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Social.support - age_group2:Standard.Social.support = 0"))
ss_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Social.support - age_group3:Standard.Social.support = 0"))
ss_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Social.support - age_group4:Standard.Social.support = 0"))
ss_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Social.support = 0"))

le_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Healthy.life.expectancy.at.birth -
                                         age_group2:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Healthy.life.expectancy.at.birth -
                                         age_group3:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Healthy.life.expectancy.at.birth -
                                         age_group4:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Healthy.life.expectancy.at.birth = 0"))

fr_hypo_12<- glht(big_model, linfct = c("age_group2:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Freedom.to.make.life.choices -
                                         age_group2:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Freedom.to.make.life.choices -
                                         age_group3:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Freedom.to.make.life.choices -
                                         age_group4:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_15<- glht(big_model, linfct = c("age_group5:Standard.Freedom.to.make.life.choices = 0"))

ge_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Generosity = 0"))
ge_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Generosity - age_group2:Standard.Generosity = 0"))
ge_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Generosity - age_group3:Standard.Generosity = 0"))
ge_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Generosity - age_group4:Standard.Generosity = 0"))
ge_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Generosity = 0"))

co_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Perceptions.of.corruption = 0"))
co_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Perceptions.of.corruption - 
                                         age_group2:Standard.Perceptions.of.corruption = 0"))
co_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Perceptions.of.corruption - 
                                         age_group3:Standard.Perceptions.of.corruption = 0"))
co_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Perceptions.of.corruption - 
                                         age_group4:Standard.Perceptions.of.corruption = 0"))
co_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Perceptions.of.corruption = 0"))
```

Data frame of hypothesis tests
```{r}
# NEED TO FIX SPECIFIC VALUES 
joint_test_matrix <- data.frame(matrix(ncol = 5, nrow = 7))
x <- c("compare12", "compare23", "compare34", "compare45", "compare15")
y <- c("Log.GDP.per.capita", "Social.support", "Healthy,life.expectancy.at.birth", "Freedom.to.make.life.choices", "Generosity", "Perceptions.of.corruption", "All")
colnames(joint_test_matrix) <- x
rownames(joint_test_matrix) <- y

joint_test_matrix[1,1] <- "0.06398 (0.04634)"
joint_test_matrix[1,2] <- "-0.03490 (0.04634)"
joint_test_matrix[1,3] <- "-0.04198 (0.04634)"
joint_test_matrix[1,4] <- "-0.01108 (0.04653)"
joint_test_matrix[1,5] <- "-0.02398 (0.04653)"

joint_test_matrix[2,1] <- "0.05085 (0.03255)"
joint_test_matrix[2,2] <- "0.001623 (0.032548)"
joint_test_matrix[2,3] <- "0.01479 (0.03255)"
joint_test_matrix[2,4] <- "-0.02606 (0.03258)"
joint_test_matrix[2,5] <- "0.04121 (0.03258)"

joint_test_matrix[3,1] <- "-0.14787 (0.04075)***"
joint_test_matrix[3,2] <- "-0.03245 (0.04075)"
joint_test_matrix[3,3] <- "0.004017 (0.040750)"
joint_test_matrix[3,4] <- "0.01664 (0.04090)"
joint_test_matrix[3,5] <- "-0.1597 (0.0409)***"

joint_test_matrix[4,1] <- "-0.03964 (0.02830)"
joint_test_matrix[4,2] <- "-0.01331 (0.02830)"
joint_test_matrix[4,3] <- "0.01574 (0.02830)"
joint_test_matrix[4,4] <- "0.02386 (0.02839)"
joint_test_matrix[4,5] <- "-0.01335 (0.02839)"

joint_test_matrix[5,1] <- "0.03167 (0.02445)"
joint_test_matrix[5,2] <- "0.05276 (0.02445)*"
joint_test_matrix[5,3] <- "0.06704 (0.02445)**"
joint_test_matrix[5,4] <- "0.06202 (0.02452)*"
joint_test_matrix[5,5] <- "0.21350 (0.02452)***"

joint_test_matrix[6,1] <- "-0.13212 (0.02705)***"
joint_test_matrix[6,2] <- "-0.09076 (0.02705)***"
joint_test_matrix[6,3] <- "-0.07157 (0.02705)**"
joint_test_matrix[6,4] <- "0.21350 (0.02714)"
joint_test_matrix[6,5] <- "-0.25597 (0.02714)***"

joint_test_matrix[7,1] <- "0.09112 (0.03463)**"
joint_test_matrix[7,2] <- "0.06447 (0.03463)"
joint_test_matrix[7,3] <- "0.13118 (0.03463)***"
joint_test_matrix[7,4] <- "0.02690 (0.03469)"
joint_test_matrix[7,5] <- "0.31368 (0.03469)***"
```


Distributional Plots
```{r}
hist(WHR_AS_comparison$WHR_score, col=rgb(1,0,0,0.5), xlim=c(0,10), breaks = 30, main="Overlapping Histogram (Blue: WHR Score, Red: AS Score)", xlab="Variable")
hist(WHR_AS_comparison$AS_score, col=rgb(0,0,1,0.5), breaks = 30, add=T)
box()
```


World Map
```{r}
WHR_AS_comparison$COUNTRY_NAME <- countrycode(WHR_AS_comparison$COUNTRY_ISO3, 'iso3c', 'country.name') 
WHR_AS_comparison$COUNTRY_NAME[WHR_AS_comparison$COUNTRY_ISO3 == "XKX"] <- "Kosovo"
WHR_AS_comparison$COUNTRY_NAME[WHR_AS_comparison$COUNTRY_NAME == "United States"] <- "USA"
  
  
WHR_AS_comparison <- WHR_AS_comparison %>% 
  rename(region = COUNTRY_NAME)

WHR_AS_comparison <- WHR_AS_comparison %>% 
  mutate(bin = cut(score_difference, breaks = seq(-1, 1, by = 0.2), include.lowest = TRUE))

# Merge the data with the world map
world_map <- map_data("world") %>% filter(!(region%in%c("French Southern and Antarctic Lands","Antarctica"))) 
world_map <- left_join(world_map, WHR_AS_comparison, by = "region")

# Create a choropleth map with discrete bins
ggplot(world_map, aes(x = long, y = lat, group = group, fill = bin)) +
  geom_polygon(color = "black", size = 0.1) +
  scale_fill_manual(values = c("#67001F", "#B2182B", "#D6604D", "#F4A582", "#FDDBC7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"), drop = FALSE) + 
  theme_minimal() +
  ggtitle("World Map for Score Difference from WHR to AS") +
  labs(
    x = "Longitude",    # Change the x-axis label
    y = "Latitude",     # Change the y-axis label
    fill = "Score Difference"  # Change the legend title
  )

#"#8f0415",
#"#0653a1"
```

Variance and Gini
```{r}
library(DescTools)

var(WHR_AS_comparison$WHR_score)
var(WHR_AS_comparison$AS_score)

var.test(WHR_AS_comparison$WHR_score, WHR_AS_comparison$AS_score, alternative = "less")

Gini(WHR_AS_comparison$WHR_score, conf.level = 0.95)
Gini(WHR_AS_comparison$AS_score, conf.level = 0.95)
```
```{r}
values <- c(1, 2, NA, 0, 4)
weights <- c(0.1, 0.2, 0.3, 0.4, 0.0)

result_with_na_rm <- weighted.mean(values, weights, na.rm = TRUE)
result_without_na_rm <- weighted.mean(values, weights, na.rm = FALSE)

print(result_with_na_rm)
print(result_without_na_rm)
```

Ranking for 2013
```{r}
gallup_age_2010 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2010) %>%
  select(which(colSums(is.na(.)) < nrow(.)))
gallup_age_2010 <- gallup_age_2010[, 2:ncol(gallup_age_2010)]
countries_2010 <- colnames(gallup_age_2010)[2:ncol(gallup_age_2010)]
age_standardized_ranking_2010 <- gallup_age_2010 %>%
  summarise(across(all_of(countries_2010), 
                   list(ASLS = ~ weighted.mean(., standard_population, na.rm=T))))
age_standardized_ranking_2010 <- pivot_longer(age_standardized_ranking_2010, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2010")
age_standardized_ranking_2010$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2010$COUNTRY_ISO3)
n_2010 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>%  
  filter(YEAR_CALENDAR == 2010) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2010 = n()) 
age_standardized_ranking_2010 <- merge(age_standardized_ranking_2010, n_2010)

gallup_age_2011 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2011) %>%
  select(which(colSums(is.na(.)) < nrow(.)))
gallup_age_2011 <- gallup_age_2011[, 2:ncol(gallup_age_2011)]
countries_2011 <- colnames(gallup_age_2011)[2:ncol(gallup_age_2011)]
age_standardized_ranking_2011 <- gallup_age_2011 %>%
  summarise(across(all_of(countries_2011), 
                   list(ASLS = ~ weighted.mean(., standard_population, na.rm=T))))
age_standardized_ranking_2011 <- pivot_longer(age_standardized_ranking_2011, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2011")
age_standardized_ranking_2011$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2011$COUNTRY_ISO3)
n_2011 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  filter(YEAR_CALENDAR == 2011) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2011 = n()) 
age_standardized_ranking_2011 <- merge(age_standardized_ranking_2011, n_2011)

gallup_age_2012 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2012) %>%
  select(which(colSums(is.na(.)) < nrow(.)))
gallup_age_2012 <- gallup_age_2012[, 2:ncol(gallup_age_2012)]
countries_2012 <- colnames(gallup_age_2012)[2:ncol(gallup_age_2012)]
age_standardized_ranking_2012 <- gallup_age_2012 %>%
  summarise(across(all_of(countries_2012), 
                   list(ASLS = ~ weighted.mean(., standard_population, na.rm=T))))
age_standardized_ranking_2012 <- pivot_longer(age_standardized_ranking_2012, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2012")
age_standardized_ranking_2012$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2012$COUNTRY_ISO3)
n_2012 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  filter(YEAR_CALENDAR == 2012) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2012 = n()) 
age_standardized_ranking_2012 <- merge(age_standardized_ranking_2012, n_2012)

age_ranking_2010_2011 <- merge(x = age_standardized_ranking_2010, y = age_standardized_ranking_2011, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking_2013 <- merge(x = age_ranking_2010_2011, y = age_standardized_ranking_2012, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking_2013[is.na(age_standardized_ranking_2013)] <- 0

age_standardized_ranking_2013 <- age_standardized_ranking_2013 %>% 
  mutate(AS_score = (AS_score_2010*n_2010 + AS_score_2011*n_2011 + AS_score_2012*n_2012)/(n_2010+n_2011+n_2012))
age_standardized_ranking_2013 <- age_standardized_ranking_2013 %>% 
  dplyr::select(Country = COUNTRY_ISO3, AS_score)

WHR_data_2013 <- read.table(header=TRUE, text=
"Country Region Ladder Social_support Freedom Corruption Donation Generosity Positive_affect Negative_affect Happiness_yesterday GDP_per_capita Healthy_life_expectancy
Afghanistan 4 4.040 0.525 0.540 0.755 0.348 0.207 0.663 0.270 0.721 979 36.535
Albania 1 5.550 0.759 0.553 0.827 0.112 -0.192 0.627 0.276 0.568 7652 61.417
Algeria 8 5.422 0.831 0.551 0.681 0.106 -0.194 0.567 0.245 0.542 7547 61.722
Angola 9 5.589 0.723 0.584 0.912 0.322 0.046 0.659 0.361 0.708 5172 34.601
Argentina 6 6.562 0.906 0.764 0.810 0.199 -0.150 0.847 0.238 0.813 14379 65.543
Armenia 2 4.316 0.681 0.476 0.915 0.079 -0.194 0.501 0.450 0.488 4941 61.453
Australia 7 7.350 0.955 0.937 0.362 0.715 0.303 0.820 0.210 0.863 34571 72.948
Austria 0 7.369 0.929 0.913 0.642 0.532 0.119 0.810 0.153 0.890 35211 72.148
Azerbaijan 2 4.604 0.725 0.546 0.810 0.188 -0.127 0.539 0.265 0.455 8796 58.205
Bahrain 8 5.312 0.901 0.828 0.508 0.366 -0.012 0.591 0.459 0.577 21693 64.405
Bangladesh 4 4.804 0.580 0.707 0.767 0.161 -0.025 0.691 0.215 0.702 1523 54.965
Belarus 2 5.504 0.910 0.667 0.688 0.145 -0.194 0.538 0.213 0.437 12438 61.319
Belgium 0 6.967 0.932 0.848 0.724 0.384 -0.024 0.828 0.235 0.821 32789 71.550
Benin 9 3.528 0.500 0.771 0.829 0.066 -0.118 0.604 0.225 0.543 1425 45.280
Bolivia 6 5.857 0.802 0.784 0.813 0.218 -0.046 0.770 0.373 0.773 4365 55.439
Bosnia_and_Herzegovina 1 4.813 0.759 0.372 0.939 0.236 -0.067 0.554 0.358 0.592 7487 64.455
Botswana 9 3.970 0.854 0.813 0.815 0.115 -0.224 0.734 0.168 0.732 12426 36.168
Brazil 6 6.849 0.904 0.829 0.646 0.252 -0.070 0.794 0.288 0.853 9942 60.500
Bulgaria 1 3.981 0.846 0.599 0.945 0.154 -0.179 0.550 0.246 0.456 11567 66.051
Burkina_Faso 9 4.259 0.742 0.645 0.734 0.093 -0.075 0.571 0.240 0.497 1124 36.653
Burundi 9 3.706 0.422 0.490 0.677 0.048 -0.066 0.689 0.190 0.683 524 36.291
Cambodia 3 4.067 0.673 0.941 0.852 0.535 0.327 0.798 0.361 0.814 1977 48.873
Cameroon 9 4.420 0.747 0.792 0.881 0.185 -0.026 0.607 0.276 0.576 2050 42.807
Canada 7 7.477 0.942 0.932 0.437 0.653 0.247 0.872 0.236 0.911 35294 72.082
Central_African_Republic 9 3.623 0.435 0.735 0.839 0.110 -0.024 0.524 0.267 0.477 702 39.560
Chad 9 4.056 0.742 0.536 0.873 0.167 -0.010 0.554 0.297 0.515 1292 41.886
Chile 6 6.587 0.844 0.740 0.744 0.479 0.129 0.809 0.302 0.792 14527 67.878
China 5 4.978 0.782 0.812 0.808 0.115 -0.186 0.808 0.153 0.785 6993 64.726
Colombia 6 6.416 0.904 0.818 0.843 0.257 -0.055 0.836 0.281 0.831 8536 62.697
Comoros 9 3.851 0.721 0.518 0.720 0.146 -0.013 0.668 0.184 0.681 985 55.732
Congo_Brazzaville 9 4.297 0.634 0.771 0.822 0.100 -0.154 0.590 0.300 0.491 3831 47.308
Congo_Kinshasa 9 4.578 0.757 0.594 0.843 0.085 0.006 0.625 0.219 0.576 323 37.797
Costa_Rica 6 7.257 0.903 0.912 0.802 0.341 0.015 0.886 0.251 0.881 10440 67.385
Croatia 1 5.661 0.788 0.541 0.957 0.123 -0.234 0.608 0.267 0.614 15996 67.409
Cyprus 0 6.466 0.820 0.745 0.846 0.500 0.109 0.771 0.301 0.737 25909 68.041
Czech_Republic 1 6.290 0.924 0.771 0.942 0.287 -0.097 0.623 0.249 0.475 23492 69.322
Denmark 0 7.693 0.963 0.937 0.176 0.629 0.222 0.776 0.179 0.647 32333 71.228
Djibouti 9 4.690 0.633 0.755 0.557 0.130 -0.084 0.579 0.181 0.673 2087 44.038
Dominican_Republic 6 4.963 0.870 0.837 0.768 0.264 -0.046 0.798 0.293 0.835 8308 60.201
Ecuador 6 5.865 0.814 0.779 0.745 0.191 -0.110 0.845 0.275 0.837 7303 62.470
Egypt 8 4.273 0.750 0.527 0.878 0.155 -0.126 0.532 0.364 0.522 5513 59.792
El_Salvador 6 5.809 0.765 0.700 0.724 0.151 -0.136 0.840 0.335 0.839 5979 60.144
Estonia 1 5.426 0.899 0.716 0.751 0.181 -0.182 0.649 0.202 0.558 17434 66.911
Ethiopia 9 4.561 0.659 0.776 0.918 0.103 -0.054 0.668 0.137 0.732 979 43.343
Finland 0 7.389 0.934 0.924 0.356 0.459 0.055 0.801 0.203 0.857 31257 72.409
France 0 6.764 0.935 0.859 0.623 0.271 -0.137 0.770 0.262 0.768 29571 72.693
Gabon 9 4.114 0.694 0.670 0.835 0.111 -0.235 0.532 0.265 0.456 13804 52.727
Georgia 2 4.187 0.525 0.616 0.375 0.032 -0.235 0.525 0.246 0.527 4564 64.930
Germany 0 6.672 0.942 0.894 0.678 0.451 0.046 0.799 0.168 0.865 34056 73.065
Ghana 9 5.091 0.716 0.808 0.854 0.263 0.075 0.762 0.182 0.800 1511 50.926
Greece 0 5.435 0.844 0.462 0.954 0.059 -0.326 0.602 0.322 0.471 23864 72.060
Guatemala 6 5.965 0.810 0.774 0.835 0.330 0.067 0.852 0.291 0.851 4309 58.208
Guinea 9 3.847 0.570 0.721 0.770 0.190 0.032 0.689 0.272 0.648 986 46.641
Haiti 6 4.341 0.623 0.422 0.765 0.407 0.245 0.592 0.274 0.634 1030 44.413
Honduras 6 5.142 0.782 0.712 0.867 0.301 0.053 0.820 0.288 0.813 3528 59.360
Hong_Kong 5 5.523 0.842 0.888 0.278 0.661 0.235 0.721 0.188 0.798 42689 70.062
Hungary 1 4.775 0.898 0.572 0.953 0.227 -0.134 0.650 0.285 0.635 16987 66.325
Iceland 0 7.355 0.978 0.898 0.747 0.651 0.240 0.900 0.157 0.907 34636 73.587
India 4 4.772 0.554 0.710 0.855 0.259 0.022 0.649 0.270 0.667 3073 54.588
Indonesia 3 5.348 0.827 0.779 0.963 0.690 0.410 0.877 0.235 0.859 3968 59.300
Iran 8 4.643 0.596 0.601 0.873 0.510 0.184 0.602 0.488 0.609 10462 58.350
Iraq 8 4.817 0.763 0.360 0.828 0.200 -0.033 0.472 0.489 0.454 3290 57.881
Ireland 0 7.076 0.971 0.903 0.595 0.749 0.335 0.859 0.209 0.895 35902 71.406
Israel 8 7.301 0.893 0.657 0.888 0.524 0.133 0.694 0.355 0.713 25988 68.155
Italy 0 6.021 0.881 0.611 0.923 0.401 0.032 0.648 0.320 0.581 27000 73.643
Jamaica 6 5.374 0.855 0.796 0.914 0.219 -0.079 0.836 0.237 0.834 7001 65.934
Japan 5 6.064 0.908 0.780 0.727 0.284 -0.118 0.789 0.178 0.786 30478 75.134
Jordan 8 5.414 0.867 0.747 0.739 0.175 -0.103 0.599 0.311 0.610 5255 61.415
Kazakhstan 2 5.671 0.900 0.835 0.835 0.134 -0.195 0.710 0.163 0.654 10934 57.843
Kenya 9 4.403 0.828 0.658 0.918 0.245 0.057 0.762 0.182 0.771 1479 46.546
Kosovo 1 5.222 0.742 0.560 0.946 0.341 0.038 0.662 0.114 0.574 7487 58.926
Kuwait 8 6.515 0.886 0.776 0.522 0.381 -0.050 0.781 0.163 0.751 46086 67.360
Kyrgyzstan 2 5.042 0.878 0.724 0.921 0.123 -0.088 0.674 0.152 0.657 2069 56.342
Laos 3 4.787 0.692 0.882 0.582 0.586 0.365 0.908 0.305 0.909 2388 48.268
Latvia 1 5.046 0.844 0.564 0.924 0.326 -0.021 0.562 0.227 0.418 13900 65.267
Lebanon 8 4.931 0.723 0.652 0.899 0.355 0.016 0.536 0.332 0.557 12465 61.059
Lesotho 9 4.898 0.824 0.618 0.769 0.096 -0.089 0.793 0.170 0.796 1448 40.358
Liberia 9 4.196 0.812 0.846 0.829 0.113 0.007 0.582 0.225 0.613 473 37.184
Libya 8 5.340 0.836 0.643 0.787 0.399 0.232 0.645 0.301 0.631 15361 64.113
Lithuania 1 5.426 0.904 0.529 0.963 0.121 -0.236 0.540 0.275 0.462 16154 65.797
Luxembourg 0 7.054 0.934 0.929 0.384 0.542 0.082 0.820 0.215 0.860 68312 72.839
Macedonia 1 4.574 0.756 0.578 0.886 0.230 -0.088 0.598 0.366 0.664 9292 62.855
Madagascar 9 3.966 0.746 0.516 0.878 0.094 -0.055 0.599 0.214 0.448 861 49.479
Malawi 9 4.113 0.608 0.685 0.869 0.254 0.112 0.764 0.235 0.771 785 37.253
Malaysia 3 5.760 0.817 0.820 0.847 0.351 0.006 0.862 0.174 0.882 13626 64.213
Mali 9 4.247 0.790 0.759 0.773 0.100 -0.056 0.745 0.134 0.712 957 38.648
Malta 0 5.964 0.918 0.849 0.849 0.680 0.299 0.726 0.369 0.809 22697 73.487
Mauritania 9 4.758 0.780 0.592 0.735 0.272 0.057 0.771 0.161 0.804 2186 45.232
Mauritius 9 5.477 0.800 0.848 0.849 0.517 0.179 0.738 0.253 0.732 12283 61.622
Mexico 6 7.088 0.809 0.796 0.669 0.249 -0.094 0.800 0.250 0.819 12520 66.225
Moldova 2 5.791 0.848 0.610 0.950 0.204 -0.028 0.573 0.292 0.526 2791 60.361
Mongolia 5 4.834 0.924 0.673 0.937 0.393 0.140 0.698 0.161 0.753 3756 56.603
Montenegro 1 5.299 0.775 0.520 0.732 0.115 -0.210 0.590 0.389 0.691 10184 62.609
Morocco 8 4.885 0.730 0.675 0.866 0.074 -0.189 0.671 0.239 0.654 4264 60.865
Mozambique 9 4.971 0.818 0.639 0.719 0.102 -0.043 0.592 0.243 0.644 823 38.211
Myanmar 3 4.439 0.612 0.691 0.695 0.856 0.676 0.764 0.205 0.750 1325 54.795
Nepal 4 4.156 0.747 0.580 0.907 0.236 0.076 0.711 0.224 0.739 1087 52.790
Netherlands 0 7.512 0.945 0.908 0.378 0.728 0.312 0.859 0.205 0.844 36854 72.338
New_Zealand 7 7.221 0.951 0.918 0.273 0.658 0.271 0.860 0.216 0.910 24478 71.115
Nicaragua 6 5.507 0.853 0.807 0.738 0.239 -0.004 0.800 0.277 0.772 3270 62.470
Niger 9 4.152 0.724 0.777 0.614 0.077 -0.050 0.683 0.145 0.707 639 36.664
Nigeria 9 5.248 0.812 0.660 0.907 0.264 0.050 0.797 0.194 0.829 2160 42.953
North_Cyprus 0 5.463 0.871 0.693 0.871 0.436 0.045 0.709 0.405 0.790 25909 68.041
Norway 0 7.655 0.942 0.947 0.421 0.498 0.063 0.823 0.213 0.749 48071 72.492
Oman 8 6.853 0.852 0.916 0.451 0.394 0.007 NA 0.295 0.893 24559 61.685
Pakistan 4 5.292 0.542 0.368 0.854 0.385 0.163 0.655 0.345 0.682 2405 53.735
Palestine 8 4.700 0.778 0.523 0.747 0.103 -0.103 0.599 0.383 0.600 1924 61.203
Panama 6 7.143 0.900 0.789 0.842 0.345 0.005 0.880 0.177 0.898 12779 66.552
Paraguay 6 5.779 0.896 0.714 0.774 0.445 0.178 0.834 0.193 0.755 4535 62.655
Peru 6 5.776 0.777 0.744 0.861 0.202 -0.109 0.779 0.353 0.776 8514 61.715
Philippines 3 4.985 0.805 0.901 0.788 0.304 0.054 0.864 0.339 0.913 3550 60.298
Poland 1 5.822 0.937 0.818 0.904 0.327 -0.034 0.747 0.240 0.640 17178 66.591
Portugal 0 5.101 0.862 0.772 0.954 0.247 -0.131 0.734 0.295 0.779 21471 70.877
Qatar 8 6.666 0.845 0.918 0.140 0.560 0.096 0.763 0.324 0.833 72892 66.013
Romania 1 5.033 0.727 0.620 0.966 0.226 -0.103 0.565 0.327 0.470 10864 64.386
Russia 2 5.464 0.901 0.615 0.941 0.060 -0.288 0.599 0.171 0.484 14103 59.729
Rwanda 9 3.715 0.603 0.832 0.115 0.131 -0.035 0.684 0.143 0.708 1105 39.229
Saudi_Arabia 8 6.480 0.852 0.624 0.451 0.301 -0.074 0.702 0.251 0.689 20546 62.183
Senegal 9 3.959 0.691 0.695 0.857 0.102 -0.096 0.764 0.179 0.775 1730 48.976
Serbia 1 4.813 0.773 0.455 0.964 0.152 -0.169 0.531 0.399 0.614 9634 62.551
Sierra_Leone 9 4.318 0.797 0.748 0.884 0.156 0.000 0.480 0.295 0.518 949 29.616
Singapore 3 6.546 0.884 0.834 0.075 0.350 -0.086 0.542 0.138 0.572 49219 71.110
Slovakia 1 5.969 0.921 0.663 0.908 0.316 -0.057 0.653 0.289 0.589 20130 67.308
Slovenia 1 6.060 0.924 0.902 0.874 0.366 -0.022 0.660 0.288 0.733 24943 70.585
Somaliland 9 4.847 0.798 0.823 0.398 0.443 0.285 0.750 0.120 0.794 979 43.343
South_Africa 9 4.963 0.897 0.689 0.821 0.132 -0.188 0.770 0.178 0.741 9552 45.275
South_Korea 5 6.267 0.800 0.659 0.819 0.334 -0.057 0.661 0.178 0.608 26789 69.235
Spain 0 6.322 0.942 0.781 0.842 0.272 -0.110 0.740 0.353 0.804 26972 73.647
Sri_Lanka 4 4.151 0.826 0.790 0.793 0.474 0.199 0.844 0.183 0.848 4689 61.951
Sudan 9 4.401 0.818 0.570 0.727 0.173 -0.036 0.604 0.241 0.606 1999 49.413
Suriname 6 6.269 0.797 0.885 0.751 0.250 -0.051 0.764 0.250 0.656 7378 61.977
Swaziland 9 4.867 0.837 0.607 0.920 0.200 -0.079 0.821 0.251 0.815 5338 40.925
Sweden 0 7.480 0.940 0.930 0.226 0.544 0.134 0.834 0.183 0.791 33869 74.213
Switzerland 0 7.650 0.943 0.918 0.319 0.550 0.129 0.859 0.176 0.907 39476 73.561
Syria 8 3.892 0.655 0.550 0.731 0.364 0.051 0.545 0.501 0.510 4714 61.940
Taiwan 5 6.221 0.840 0.712 0.803 0.413 0.009 0.831 0.129 0.815 30463 66.579
Tajikistan 2 4.380 0.746 0.769 0.685 0.139 -0.067 0.686 0.185 0.751 1945 55.420
Tanzania 9 3.770 0.842 0.637 0.857 0.276 0.098 0.720 0.162 0.708 1291 48.695
Thailand 3 6.371 0.899 0.870 0.918 0.738 0.435 0.886 0.143 0.936 7526 60.477
Togo 9 2.936 0.303 0.584 0.840 0.069 -0.084 0.480 0.395 0.362 902 46.133
Trinidad_and_Tobago 6 6.519 0.863 0.775 0.904 0.438 0.055 0.906 0.134 0.907 23172 62.805
Tunisia 8 4.826 0.705 0.598 0.846 0.116 -0.194 0.590 0.280 0.571 8351 62.922
Turkey 8 5.345 0.741 0.475 0.710 0.126 -0.214 0.640 0.344 0.707 12789 62.912
Turkmenistan 2 5.628 0.955 0.786 0.597 0.235 -0.071 0.612 0.120 0.596 7831 54.837
Uganda 9 4.443 0.866 0.728 0.843 0.201 0.032 0.693 0.257 0.710 1152 44.821
Ukraine 2 5.057 0.880 0.542 0.934 0.087 -0.200 0.558 0.213 0.470 6052 61.601
United_Arab_Emirates 8 7.144 0.878 0.895 0.355 0.472 0.044 0.765 0.223 0.764 43295 64.545
United_Kingdom 0 6.883 0.947 0.887 0.448 0.744 0.339 0.845 0.180 0.873 32797 71.645
United_States 7 7.082 0.917 0.834 0.698 0.621 0.191 0.844 0.254 0.877 42068 69.689
Uruguay 6 6.355 0.883 0.852 0.537 0.273 -0.066 0.800 0.232 0.750 12538 66.434
Uzbekistan 2 5.623 0.920 0.924 0.597 0.226 -0.005 0.783 0.131 0.786 2756 60.176
Venezuela 6 7.039 0.931 0.780 0.755 0.136 -0.196 0.849 0.168 0.808 11182 65.104
Vietnam 3 5.533 0.809 0.841 0.766 0.211 -0.024 0.613 0.213 0.637 2905 62.188
Yemen 8 4.054 0.683 0.668 0.836 0.080 -0.142 0.518 0.281 0.551 2235 50.780
Zambia 9 5.006 0.822 0.726 0.846 0.211 0.027 0.780 0.227 0.792 1416 37.099
Zimbabwe 9 4.827 0.873 0.590 0.842 0.094 0.018 0.733 0.170 0.728 309 37.143")

WHR_data_2013 <- WHR_data_2013 %>% 
  dplyr::select(Country, Ladder)

WHR_data_2013$Country[WHR_data_2013$Country == "Bosnia_and_Herzegovina"] <- "Bosnia Herzegovina"
WHR_data_2013$Country[WHR_data_2013$Country == "Burkina_Faso"] <- "Burkina Faso"
WHR_data_2013$Country[WHR_data_2013$Country == "Central_African_Republic"] <- "Central African Republic"
WHR_data_2013$Country[WHR_data_2013$Country == "Congo_Brazzaville"] <- "Congo Brazzaville"
WHR_data_2013$Country[WHR_data_2013$Country == "Congo_Kinshasa"] <- "Congo Kinshasa"
WHR_data_2013$Country[WHR_data_2013$Country == "Costa_Rica"] <- "Costa Rica"
WHR_data_2013$Country[WHR_data_2013$Country == "Czech_Republic"] <- "Czech Republic"
WHR_data_2013$Country[WHR_data_2013$Country == "Dominican_Republic"] <- "Dominican Republic"
WHR_data_2013$Country[WHR_data_2013$Country == "El_Salvador"] <- "El Salvador"
WHR_data_2013$Country[WHR_data_2013$Country == "Hong_Kong"] <- "Hong Kong"
WHR_data_2013$Country[WHR_data_2013$Country == "Macedonia"] <- "North Macedonia"
WHR_data_2013$Country[WHR_data_2013$Country == "New_Zealand"] <- "New Zealand"
WHR_data_2013$Country[WHR_data_2013$Country == "North_Cyprus"] <- "Northern Cyprus"
WHR_data_2013$Country[WHR_data_2013$Country == "Saudi_Arabia"] <- "Saudi Arabia"
WHR_data_2013$Country[WHR_data_2013$Country == "Sierra_Leone"] <- "Sierra Leone"
WHR_data_2013$Country[WHR_data_2013$Country == "South_Africa"] <- "South Africa"
WHR_data_2013$Country[WHR_data_2013$Country == "South_Korea"] <- "South Korea"
WHR_data_2013$Country[WHR_data_2013$Country == "Sri_Lanka"] <- "Sri Lanka"
WHR_data_2013$Country[WHR_data_2013$Country == "Swaziland"] <- "Eswatini"
WHR_data_2013$Country[WHR_data_2013$Country == "Trinidad_and_Tobago"] <- "Trinidad and Tobago"
WHR_data_2013$Country[WHR_data_2013$Country == "United_Arab_Emirates"] <- "United Arab Emirates"
WHR_data_2013$Country[WHR_data_2013$Country == "United_Kingdom"] <- "United Kingdom"
WHR_data_2013$Country[WHR_data_2013$Country == "United_States"] <- "United States"

WHR_data_2013$COUNTRY_ISO3 <- countrycode(WHR_data_2013$Country, 'country.name', 'iso3c') 
WHR_data_2013$COUNTRY_ISO3[WHR_data_2013$Country == "Kosovo"] <- "XKX"
WHR_data_2013$COUNTRY_ISO3[WHR_data_2013$Country == "Somaliland"] <- "XS"
WHR_data_2013$COUNTRY_ISO3[WHR_data_2013$Country == "South_Korea"] <- "KOR"

WHR_AS_comparison_2013 <- merge(WHR_data_2013, age_standardized_ranking_2013, by.x="COUNTRY_ISO3", by.y="Country")

comparison_2013_2023 <- merge(WHR_AS_comparison, WHR_AS_comparison_2013, by.x="COUNTRY_ISO3", by.y="COUNTRY_ISO3")
notable_countries <- comparison_2013_2023 %>% 
  filter(WHR_score > Ladder & AS_score.x < AS_score.y |
         WHR_score < Ladder & AS_score.x > AS_score.y) %>% 
  dplyr::select(COUNTRY_ISO3 = COUNTRY_ISO3, Country = region, WHR_2023 = WHR_score, AS_2023 = AS_score.x, WHR_2013 = Ladder, AS_2013 = AS_score.y)

notable_countries <- notable_countries %>% 
  mutate(WHR_diff = WHR_2023 - WHR_2013,
         AS_diff = AS_2023 - AS_2013,
         diff_of_diff = WHR_diff - AS_diff) %>% 
  filter(COUNTRY_ISO3 != "CYP")
```

Summarizing Changing from WHR to AS
```{r}
mean(abs(WHR_AS_comparison$rank_difference))
mean(abs(WHR_AS_comparison$score_difference))

significant_changes_in_rank <- WHR_AS_comparison %>% 
  filter(abs(rank_difference) >= 10) %>% 
  dplyr::select(COUNTRY_ISO3, region, WHR_score, AS_score, rank_difference, score_difference)
```

Analysis of Age-Specific Rankings - Age Group 1
```{r}
standardized_contributions_1$COUNTRY_ISO3 <- countrycode(
  sourcevar = standardized_contributions_1$standardized_contributions_1,
  origin = "country.name",
  destination = "iso3c"
)
standardized_contributions_1$COUNTRY_ISO3[standardized_contributions_1$standardized_contributions_1 == "Kosovo"] <- "XKX"
standardized_contributions_1 <- merge(standardized_contributions_1, WHR_ranking_summary, by = "COUNTRY_ISO3")
standardized_contributions_1 <- standardized_contributions_1 %>%  
  mutate(rank_difference = Rank - WHR_rank,
         score_difference = Life.Ladder - WHR_score)
            
rd1 <- mean(abs(standardized_contributions_1$rank_difference))
sd1 <- mean(abs(standardized_contributions_1$score_difference))


significant_changes_in_rank_1 <- standardized_contributions_1 %>% 
  filter(abs(rank_difference) >= 10) %>% 
  dplyr::select(COUNTRY_ISO3, standardized_contributions_1, WHR_score, Life.Ladder, rank_difference, score_difference)
```

Analysis of Age-Specific Rankings - Age Group 2
```{r}
standardized_contributions_2$COUNTRY_ISO3 <- countrycode(
  sourcevar = standardized_contributions_2$standardized_contributions_2,
  origin = "country.name",
  destination = "iso3c"
)
standardized_contributions_2$COUNTRY_ISO3[standardized_contributions_2$standardized_contributions_2 == "Kosovo"] <- "XKX"
standardized_contributions_2 <- merge(standardized_contributions_2, WHR_ranking_summary, by = "COUNTRY_ISO3")
standardized_contributions_2 <- standardized_contributions_2 %>%  
  mutate(rank_difference = Rank - WHR_rank,
         score_difference = Life.Ladder - WHR_score)
            
rd2 <- mean(abs(standardized_contributions_2$rank_difference))
sd2 <- mean(abs(standardized_contributions_2$score_difference))


significant_changes_in_rank_2 <- standardized_contributions_2 %>% 
  filter(abs(rank_difference) >= 10) %>% 
  dplyr::select(COUNTRY_ISO3, standardized_contributions_2, WHR_score, Life.Ladder, rank_difference, score_difference)
```

Analysis of Age-Specific Rankings - Age Group 3
```{r}
standardized_contributions_3$COUNTRY_ISO3 <- countrycode(
  sourcevar = standardized_contributions_3$standardized_contributions_3,
  origin = "country.name",
  destination = "iso3c"
)
standardized_contributions_3$COUNTRY_ISO3[standardized_contributions_3$standardized_contributions_3 == "Kosovo"] <- "XKX"
standardized_contributions_3 <- merge(standardized_contributions_3, WHR_ranking_summary, by = "COUNTRY_ISO3")
standardized_contributions_3 <- standardized_contributions_3 %>%  
  mutate(rank_difference = Rank - WHR_rank,
         score_difference = Life.Ladder - WHR_score)
            
rd3 <- mean(abs(standardized_contributions_3$rank_difference))
sd3 <- mean(abs(standardized_contributions_3$score_difference))


significant_changes_in_rank_3 <- standardized_contributions_3 %>% 
  filter(abs(rank_difference) >= 10) %>% 
  dplyr::select(COUNTRY_ISO3, standardized_contributions_3, WHR_score, Life.Ladder, rank_difference, score_difference)
```

Analysis of Age-Specific Rankings - Age Group 4
```{r}
standardized_contributions_4$COUNTRY_ISO3 <- countrycode(
  sourcevar = standardized_contributions_4$standardized_contributions_4,
  origin = "country.name",
  destination = "iso3c"
)
standardized_contributions_4$COUNTRY_ISO3[standardized_contributions_4$standardized_contributions_4 == "Kosovo"] <- "XKX"
standardized_contributions_4 <- merge(standardized_contributions_4, WHR_ranking_summary, by = "COUNTRY_ISO3")
standardized_contributions_4 <- standardized_contributions_4 %>%  
  mutate(rank_difference = Rank - WHR_rank,
         score_difference = Life.Ladder - WHR_score)
            
rd4 <- mean(abs(standardized_contributions_4$rank_difference))
sd4 <- mean(abs(standardized_contributions_4$score_difference))


significant_changes_in_rank_4 <- standardized_contributions_4 %>% 
  filter(abs(rank_difference) >= 10) %>% 
  dplyr::select(COUNTRY_ISO3, standardized_contributions_4, WHR_score, Life.Ladder, rank_difference, score_difference)
```

Analysis of Age-Specific Rankings - Age Group 5
```{r}
standardized_contributions_5$COUNTRY_ISO3 <- countrycode(
  sourcevar = standardized_contributions_5$standardized_contributions_5,
  origin = "country.name",
  destination = "iso3c"
)
standardized_contributions_5$COUNTRY_ISO3[standardized_contributions_5$standardized_contributions_5 == "Kosovo"] <- "XKX"
standardized_contributions_5 <- merge(standardized_contributions_5, WHR_ranking_summary, by = "COUNTRY_ISO3")
standardized_contributions_5 <- standardized_contributions_5 %>%  
  mutate(rank_difference = Rank - WHR_rank,
         score_difference = Life.Ladder - WHR_score)
            
rd5 <- mean(abs(standardized_contributions_5$rank_difference))
sd5 <- mean(abs(standardized_contributions_5$score_difference))



significant_changes_in_rank_5 <- standardized_contributions_5 %>% 
  filter(abs(rank_difference) >= 10) %>% 
  dplyr::select(COUNTRY_ISO3, standardized_contributions_5, WHR_score, Life.Ladder, rank_difference, score_difference)


rank_diff <- c(rd1, rd2, rd3, rd4, rd5)
score_diff <- c(sd1, sd2, sd3, sd4, sd5)
age_specific_differences <- data.frame(rank_diff, score_diff)
```


Ranking Comparison Table:
```{r}
ranking_comparisons <- WHR_AS_comparison %>% 
  dplyr::select(COUNTRY_ISO3, region, WHR_score, WHR_rank, AS_score, AS_rank)

age_specific_ranking_comparisons <- standardized_contributions_1 %>% 
  dplyr::select(COUNTRY_ISO3, AG1_score = Life.Ladder, AG1_rank = Rank) %>%
  left_join(
    standardized_contributions_2 %>% dplyr::select(COUNTRY_ISO3, AG2_score = Life.Ladder, AG2_rank = Rank),
    by = "COUNTRY_ISO3"
  ) %>%
  left_join(
    standardized_contributions_3 %>% dplyr::select(COUNTRY_ISO3, AG3_score = Life.Ladder, AG3_rank = Rank),
    by = "COUNTRY_ISO3"
  ) %>%
  left_join(
    standardized_contributions_4 %>% dplyr::select(COUNTRY_ISO3, AG4_score = Life.Ladder, AG4_rank = Rank),
    by = "COUNTRY_ISO3"
  ) %>%
  left_join(
    standardized_contributions_5 %>% dplyr::select(COUNTRY_ISO3, AG5_score = Life.Ladder, AG5_rank = Rank),
    by = "COUNTRY_ISO3"
  ) 

ranking_comparisons <- left_join(ranking_comparisons, age_specific_ranking_comparisons, by = "COUNTRY_ISO3")

ranking_comparisons_summary <- ranking_comparisons %>% 
  filter(WHR_rank <= 10 | WHR_rank >= 128)
```

Visualizing Ranking Changes
```{r}
ranking_comparison_wide <- ranking_comparisons %>% 
  dplyr::select(COUNTRY_ISO3, COUNTRYNAME = region, WHR_rank, AS_rank, AG1_rank, AG4_rank)
ranking_comparison_wide <- ranking_comparison_wide[order(ranking_comparison_wide$WHR_rank), ]

WHR_and_AS <- ranking_comparison_wide %>% select('WHR_rank', 'AS_rank')
WHR_and_AG1 <- ranking_comparison_wide %>% select('WHR_rank', 'AG1_rank')
WHR_and_AG4 <- ranking_comparison_wide %>% select('WHR_rank', 'AG4_rank')

WHR_and_AS <- WHR_and_AS %>%
  arrange(`AS_rank`)
WHR_and_AS$AS_rank <- WHR_and_AS$WHR

WHR_and_AG1 <- WHR_and_AG1 %>%
  arrange(`AG1_rank`)
WHR_and_AG1$AG1_rank <- WHR_and_AG1$WHR

WHR_and_AG4 <- WHR_and_AG4 %>%
  arrange(`AG4_rank`)
WHR_and_AG4$AG4_rank <- WHR_and_AG4$WHR

# This is ordered by each ranking, but the value represents the WHR Rank of the country in that spot.
ranking_comparison_visualization_data  <- data.frame(ranking_comparison_wide %>% select(WHR_rank),
                                                      WHR_and_AS %>% select(AS_rank),
                                                      WHR_and_AG1 %>% select(AG1_rank),
                                                      WHR_and_AG4 %>% select(AG4_rank),
                                                     ranking_comparison_wide %>% select(WHR_rank)) %>% 
  select("WHR" = WHR_rank, "Age-Standardized" = AS_rank, "Age Group 1" = AG1_rank, 
         "Age Group 4" = AG4_rank, "WHR2" = WHR_rank.1)


df_long <- reshape2::melt(ranking_comparison_visualization_data, id.vars = "WHR2")

ggplot(df_long, aes(x = variable, y = WHR2, fill = factor(value))) +
  geom_tile() +
  scale_fill_manual(
    values = c(
      viridis(137, direction = -1)[1:42],
      "red",
      viridis(137, direction = -1)[44:49],
      "blue",
      viridis(137, direction = -1)[51:137]
    )
  ) +  # Adjust colors as needed
  labs(title = "Ranking Comparison Visualization", x = "Ranking Type", y = "Ranking") +
  theme_minimal() +
  scale_y_reverse() +
  guides(fill = guide_colourbar(reverse = TRUE, title = "Ranking"))
```

Researching Saudi Arabia and Iceland
```{r}
age_n_matrix <- gallup_main %>%
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = n) %>%
  arrange(YEAR_CALENDAR, age_group)

egypt_n <- age_n_matrix %>% select("YEAR_CALENDAR", "age_group", "EGY") %>% 
  filter((YEAR_CALENDAR <= 2012 & YEAR_CALENDAR >= 2010)|(YEAR_CALENDAR <= 2022 & YEAR_CALENDAR >= 2020))

egypt <- age_matrix %>% select("YEAR_CALENDAR", "age_group", "EGY") %>% 
  filter((YEAR_CALENDAR <= 2012 & YEAR_CALENDAR >= 2010)|(YEAR_CALENDAR <= 2022 & YEAR_CALENDAR >= 2020))

egypt = merge(egypt, egypt_n, by=c("YEAR_CALENDAR", "age_group"))

egypt <- egypt %>%
  mutate(Year_Group = case_when(
    between(YEAR_CALENDAR, 2010, 2012) ~ "2010-2012",
    between(YEAR_CALENDAR, 2020, 2022) ~ "2020-2022"
  ))

# Calculate the weighted average
egypt <- egypt %>%
  group_by(age_group, Year_Group) %>% 
  summarise(Avg_LS = sum((EGY.x)*(EGY.y), na.rm=T) / sum(EGY.y, na.rm=T)) %>%
  arrange(Year_Group, age_group)

ggplot(egypt, aes(x = age_group, y = Avg_LS, fill = Year_Group)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, color = "black") +
  labs(title = "Average LS by Age Group and Year Group in Egypt", x = "Age Group", y = "Average LS") +
  scale_fill_manual(values = c("2010-2012" = "lightblue", "2020-2022" = "salmon")) +  # Adjust colors as needed
  theme_minimal()
```


```{r}
iceland <- age_matrix %>% select("YEAR_CALENDAR", "age_group", "ISL") %>% 
  filter((YEAR_CALENDAR <= 2012 & YEAR_CALENDAR >= 2010)|(YEAR_CALENDAR <= 2022 & YEAR_CALENDAR >= 2020))

iceland_n <- age_n_matrix %>% select("YEAR_CALENDAR", "age_group", "ISL") %>% 
  filter((YEAR_CALENDAR <= 2012 & YEAR_CALENDAR >= 2010)|(YEAR_CALENDAR <= 2022 & YEAR_CALENDAR >= 2020))

iceland = merge(iceland, iceland_n, by=c("YEAR_CALENDAR", "age_group"))

iceland <- iceland %>%
  mutate(Year_Group = case_when(
    between(YEAR_CALENDAR, 2010, 2012) ~ "2010-2012",
    between(YEAR_CALENDAR, 2020, 2022) ~ "2020-2022"
  ))

# Calculate the weighted average
iceland <- iceland %>%
  group_by(age_group, Year_Group) %>%
  summarise(Avg_LS = sum((ISL.x)*(ISL.y), na.rm=T) / sum(ISL.y, na.rm=T)) %>%
  arrange(Year_Group, age_group)

ggplot(iceland, aes(x = age_group, y = Avg_LS, fill = Year_Group)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, color = "black") +
  labs(title = "Average LS by Age Group and Year Group in Iceland", x = "Age Group", y = "Average LS") +
  scale_fill_manual(values = c("2010-2012" = "lightblue", "2020-2022" = "salmon")) +  # Adjust colors as needed
  theme_minimal()
```

```{r}
gallup_main %>%
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = weighted.mean(WP16, WGT, na.rm=T)) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group)

test <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2020) %>%
  select(which(colSums(is.na(.)) < nrow(.)))
test <- test[, 2:ncol(test)]


#gallup_age_2020 <- gallup_main %>% 
  filter(!is.na(age_group)) %>% 
  filter(YEAR_CALENDAR == 2020) %>% 
  group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>% 
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
```




# APPENDIX - DELETED code

### Calculating Venezula's Log GDP per capita

In the presentation of the WHR2023 data, the contribution to wellbeing from each factor is calculated as the difference from the contribution for the country with the lowest level of that factor (or the highest if the effect is negative). There are some missing values in the data that the WHR authors have imputed. Instead of following their exact process for imputation the imputed values can be restored from the 
```{r}
# Venezuela's GDP is missing, so we use all other values to working backwards from WHR. Usually, we could work backwards without this complicated process using the results of the regression. However, this is not possible unless we have Venezuela's GDP as Venezuela's GDP is Dystopia's GDP. 

# Load the World Happiness Report data from an Excel file
WHR_data <- readxl::read_excel("Data/DataForFigure2.1WHR2023.xls")

# Extract the coefficient for Log GDP per capita from the regression model
gdp_estimate <- coef(WHR_regression)["Log.GDP.per.capita"]

# Calculate an estimate for Venezuela's GDP by subtracting the contribution of GDP to happiness from the total happiness score
venezuela_GDP_calc <- WHR_data %>%
  mutate(ven_GDP_est = `Logged GDP per capita` - `Explained by: Log GDP per capita`/gdp_estimate)

# Compute the mean of the estimated GDP values to get a single estimate for Venezuela's GDP
venezuela_GDP <- mean(venezuela_GDP_calc$ven_GDP_est)
```


Impute missing data
```{r}
# We impute the missing data by working backwards through the WHR. A limitation of this is that it might be slightly inaccurate, as the WHR imputes data before regression. 

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(WHR_regression)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

WHR_summary[WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])
```


Construct WHR Ranking
```{r}
# For each predictor, find the distance of the country's value from Dystopia's value. This is necessary to determine how much it contributes to the LS score. This is done by multiplying the distance from Dystopia by the coefficient corresponding to that predictor. 

distance_from_dystopia <- cbind(WHR_summary %>% 
                                  dplyr::select(Country.name) %>% 
                                  filter(Country.name != "Dystopia"),
                                (WHR_summary[1:137, 3:8] - WHR_summary[rep(138, 137), 3:8]))

WHR_ranking <- distance_from_dystopia$Country.name
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[2] * coef(summary(WHR_regression))[1,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[3] * coef(summary(WHR_regression))[2,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[4] * coef(summary(WHR_regression))[3,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[5] * coef(summary(WHR_regression))[4,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[6] * coef(summary(WHR_regression))[5,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[7] * coef(summary(WHR_regression))[6,1])
WHR_ranking$sum <- apply(WHR_ranking[,-1], 1, sum) 

WHR_ranking <- data.frame(cbind(WHR_ranking, WHR_score = WHR_summary[1:137,]$Life.Ladder))
WHR_ranking$residual <- WHR_ranking$WHR_score - WHR_ranking$sum
WHR_ranking$WHR_rank <- rank(-WHR_ranking$WHR_score)

WHR_ranking <- WHR_ranking %>% 
  dplyr::select(!sum)
WHR_ranking <- WHR_ranking[,c(1, 8, 10, 2, 3, 4, 5, 6, 7, 9)]
names(WHR_ranking)[names(WHR_ranking) == 'WHR_ranking'] <- 'COUNTRY_ISO3'

WHR_ranking_summary <- WHR_ranking %>% 
  dplyr::select(COUNTRY_ISO3, WHR_score, WHR_rank)

WHR_ranking_summary$COUNTRY_ISO3 <- countrycode(WHR_ranking_summary$COUNTRY_ISO3, 'country.name', 'iso3c') 

WHR_ranking_summary$COUNTRY_ISO3[WHR_ranking_summary$WHR_rank == 34] <- "XKX"
WHR_ranking_summary$COUNTRY_ISO3[WHR_ranking_summary$WHR_rank == 107] <- "TUR"
```

### OLD AGE STANDARDIZED CALCULATION SECTION

```{r}

gallup_age_2020 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2020) %>%
  dplyr::select(which(colSums(is.na(.)) < nrow(.)))
gallup_age_2020 <- gallup_age_2020[, 2:ncol(gallup_age_2020)]
countries_2020 <- colnames(gallup_age_2020)[2:108]
age_standardized_ranking_2020 <- gallup_age_2020 %>%
  summarise(across(all_of(countries_2020), 
                   list(ASLS = ~ weighted.mean(., standard_population, na.rm=T))))
age_standardized_ranking_2020 <- pivot_longer(age_standardized_ranking_2020, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2020")
age_standardized_ranking_2020$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2020$COUNTRY_ISO3)
n_2020 <- gallup_main %>% 
    filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>%  
  filter(YEAR_CALENDAR == 2020) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2020 = n()) 
age_standardized_ranking_2020 <- merge(age_standardized_ranking_2020, n_2020)

gallup_age_2021 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2021) %>%
  dplyr::select(which(colSums(is.na(.)) < nrow(.)))
gallup_age_2021 <- gallup_age_2021[, 2:ncol(gallup_age_2021)]
countries_2021 <- colnames(gallup_age_2021)[2:121]
age_standardized_ranking_2021 <- gallup_age_2021 %>%
  summarise(across(all_of(countries_2021), 
                   list(ASLS = ~ weighted.mean(., standard_population, na.rm=T))))
age_standardized_ranking_2021 <- pivot_longer(age_standardized_ranking_2021, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2021")
age_standardized_ranking_2021$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2021$COUNTRY_ISO3)
n_2021 <- gallup_main %>% 
    filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>%  
  filter(YEAR_CALENDAR == 2021) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2021 = n()) 
age_standardized_ranking_2021 <- merge(age_standardized_ranking_2021, n_2021)

gallup_age_2022 <- gallup_main %>% 
  filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>%
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>%
  arrange(YEAR_CALENDAR, age_group) %>% 
  filter(YEAR_CALENDAR == 2022) %>%
  dplyr::select(which(colSums(is.na(.)) < nrow(.)))
gallup_age_2022 <- gallup_age_2022[, 2:ncol(gallup_age_2022)]
countries_2022 <- colnames(gallup_age_2022)[2:140]
age_standardized_ranking_2022 <- gallup_age_2022 %>%
  summarise(across(all_of(countries_2022), 
                   list(ASLS = ~ weighted.mean(., standard_population, na.rm=T))))
age_standardized_ranking_2022 <- pivot_longer(age_standardized_ranking_2022, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2022")
age_standardized_ranking_2022$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2022$COUNTRY_ISO3)
n_2022 <- gallup_main %>% 
    filter(!is.na(age_group),
         !is.na(Weighted.LS)) %>% 
  filter(YEAR_CALENDAR == 2022) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2022 = n()) 
age_standardized_ranking_2022 <- merge(age_standardized_ranking_2022, n_2022)

age_ranking_2020_2021 <- merge(x = age_standardized_ranking_2020, y = age_standardized_ranking_2021, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking <- merge(x = age_ranking_2020_2021, y = age_standardized_ranking_2022, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking[is.na(age_standardized_ranking)] <- 0

age_standardized_ranking <- age_standardized_ranking %>% 
  mutate(AS_score = (AS_score_2020*n_2020 + AS_score_2021*n_2021 + AS_score_2022*n_2022)/(n_2020+n_2021+n_2022)) %>% 
  dplyr::select(COUNTRY_ISO3, AS_score)

# Rename for merging later on
age_standardized_ranking$Country.name <- countrycode(age_standardized_ranking$COUNTRY_ISO3, 'iso3c', 'country.name')
age_standardized_ranking$Country.name[age_standardized_ranking$COUNTRY_ISO3=="XKX"] <- "Kosovo"
age_standardized_ranking$Country.name[age_standardized_ranking$COUNTRY_ISO3=="XNC"] <- "North Cyprus"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Bosnia & Herzegovina"] <- "Bosnia and Herzegovina"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Congo - Kinshasa"] <- "Congo (Kinshasa)"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Congo - Brazzaville"] <- "Congo (Brazzaville)"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Hong Kong SAR China"] <- "Hong Kong S.A.R. of China"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name== "Côte d’Ivoire"] <- "Ivory Coast"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Myanmar (Burma)"] <- "Myanmar"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Taiwan"] <- "Taiwan Province of China"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Turkey"] <- "Turkiye"
age_standardized_ranking$Country.name[age_standardized_ranking$Country.name=="Palestinian Territories"] <- "State of Palestine"

# OLD APPROACH: No weighted average between years. 

# gallup_age <- gallup_main %>%
#   filter(YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>%
#   group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>%
#   drop_na(Weighted.LS) %>% 
#   summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
#   pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
# gallup_age[is.na(gallup_age)] = 0
# 
# standard_population <- c(0.3333784699, 0.2890995261, 0.2161137441,
#                               0.1203791469, 0.04150304671)
# 
# countries <- colnames(gallup_age)[2:144]
# age_standardized_ranking <- gallup_age %>%
#   summarise(across(all_of(countries),
#                    list(ASLS = ~ weighted.mean(., standard_population))))
# age_standardized_ranking <- pivot_longer(age_standardized_ranking,
#                                            cols = everything(),
#                                            names_to = "COUNTRY_ISO3",
#                                            values_to = "AS_score")
# age_standardized_ranking$COUNTRY_ISO3 <- gsub(
#   '_ASLS', '', age_standardized_ranking_test$COUNTRY_ISO3)
```