---
title: "age-standardized-markdown"
output: html_document
date: "2023-10-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plm)
library(countrycode)
library(ggalluvial)
library(reshape2)
library(data.table)
library(GGally)
library(maps)
library(viridis)
library(multcomp)
```

**Replicating World Happiness Report 2023, Chapter 2**
Reading WHR Data
```{r}
WHR_data <- read.csv("/Users/makototakahara/Downloads/WHR2023Table.csv")

WHR_summary <- WHR_data %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(Life.Ladder = weighted.mean(Life.Ladder, n),
            Log.GDP.per.capita = mean(Log.GDP.per.capita, na.rm = TRUE),
            Social.support = mean(Social.support, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = mean(Healthy.life.expectancy.at.birth, na.rm = TRUE),
            Freedom.to.make.life.choices = mean(Freedom.to.make.life.choices, na.rm = TRUE),
            Generosity = mean(Generosity, na.rm = TRUE),
            Perceptions.of.corruption = mean(Perceptions.of.corruption, na.rm = TRUE))
```

Regression of Life Ladder to 6 predictors
```{r}
regression_data <- WHR_data %>%
  filter(!is.na(Life.Ladder),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

WHR_regression <- plm(Life.Ladder ~ Log.GDP.per.capita+Social.support+
                        Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                        Generosity+Perceptions.of.corruption, data = regression_data,
                      index = c("year","Country.name"), model="within")
```

Calculating Venezula's Log GDP per capita
```{r}
gdp_contributions <- c(1.888380408, 1.949405551, 1.925507665, 1.833397985, 1.942273855, 1.920950174, 1.994439602, 2.021803141, 2.199664354, 1.841704249, 1.926718116, 1.898795009, 1.881438851, 2.152112246, 1.980279803, 1.919438958, 1.906878233, 1.823468804, 1.856903434, 1.807981849, 1.855644822, 1.815317154, 1.586957693, 1.725929260, 2.167941332, 2.015041590, 1.617422104, 1.731086135, 1.860922694, 1.798477411, 1.798105359, 1.831728816, 1.374470234, 1.645203710, 1.550388217, 1.841345787, 1.713736892, 1.766774416, 1.108565807, 1.737142801, 1.882560015, 1.287179708, 1.663887262, 1.551958442, 1.823535442, 1.825132132, 1.726533294, 1.454480886, 1.277642131, 1.754487276, 1.589547515, 1.114858866, 1.227176905, 1.664970160, 1.758063197, 1.852753997, 1.707674265, 1.588978410, 1.515194416, 1.379249096, 1.061276436, 1.424565315, 1.510386109, 1.348590732, 1.428491592, 1.537114263, 1.304714680, 1.240158796, 1.679553747, 1.466522813, 1.455285072, 1.536397338, 1.342591405, 1.389684558, 1.238053203, 1.635417581, 0.978851676, 1.466145873, 0.971865714, 1.353351712, 1.950940251, 1.449203372, 1.383815885, 1.416947603, 0.921178162, 1.497870803, 1.232199073, 1.477461338, 0.844172418, 1.358194232, 1.093752742, 1.438447475, 1.064864993, 0.964770198, 0.570097387, 1.280983448, 1.236021280, 1.464571595, 0.942726910, 1.098963261, 0.767502248, 1.288983583, 1.714365840, 1.100695729, 1.080818176, 0.561017454, 1.333035707, 1.051386952, 1.421779513, 0.785096049, 0.622039676, 1.025035024, 0.924076915, 1.031916738, 1.132664084, 0.760724187, 0.763360739, 1.377242088, 0.769851625, 1.292441964, 0.793330133, 0.627642870, 1.159242749, 0.632469475, 0.913520396, 0.835894883, 0.913785815, 0.636526823, 1.471394062, 0.530779243, 0.758278608, 0.669698656, 1.416998625, 0.644599795)

gdp_values <- WHR_summary %>% 
  arrange(desc(Life.Ladder)) %>% 
  dplyr::select(Log.GDP.per.capita) %>% 
  drop_na()
gdp_values <- pull(gdp_values, Log.GDP.per.capita)


venezuela_gdp_values_calculator <- function(vec1, vec2){
  n <- length(vec1)
  result <- c()
  for (i in 1:n){
    new <- vec2[i] - (vec1[i]/0.3586569)
    result <- c(result, new)
  }
  return(result)
}

venezuela_gdp_values <- venezuela_gdp_values_calculator(gdp_contributions, gdp_values)
venezuela_GDP <- mean(venezuela_gdp_values)
```

Creating Dystopia
```{r}
dystopia <- data.frame(Country.name="Dystopia", Life.Ladder=NA, Log.GDP.per.capita=NA, 
                                             Social.support=NA, Healthy.life.expectancy.at.birth=NA, 
                                             Freedom.to.make.life.choices=NA, Generosity=NA, 
                                             Perceptions.of.corruption=NA)

WHR_summary <- rbind(WHR_summary, dystopia)

WHR_summary[WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"] <-
  venezuela_GDP 
WHR_summary[WHR_summary$Country.name=="Dystopia", "Social.support"] <-
  min(WHR_summary$Social.support, na.rm = TRUE)
WHR_summary[WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"] <-
  min(WHR_summary$Healthy.life.expectancy.at.birth, na.rm = TRUE)
WHR_summary[WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"] <-
  min(WHR_summary$Freedom.to.make.life.choices, na.rm = TRUE)
WHR_summary[WHR_summary$Country.name=="Dystopia", "Generosity"] <-
  min(WHR_summary$Generosity, na.rm = TRUE)
WHR_summary[WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"] <-
  max(WHR_summary$Perceptions.of.corruption, na.rm = TRUE)
```

Impute missing data
```{r}
WHR_summary[WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(WHR_regression)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

WHR_summary[WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])
```

Construct WHR Ranking
```{r}
distance_from_dystopia <- cbind(WHR_summary %>% 
                                  dplyr::select(Country.name) %>% 
                                  filter(Country.name != "Dystopia"),
                                (WHR_summary[1:137, 3:8] - WHR_summary[rep(138, 137), 3:8]))

WHR_ranking <- distance_from_dystopia$Country.name
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[2] * coef(summary(WHR_regression))[1,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[3] * coef(summary(WHR_regression))[2,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[4] * coef(summary(WHR_regression))[3,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[5] * coef(summary(WHR_regression))[4,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[6] * coef(summary(WHR_regression))[5,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[7] * coef(summary(WHR_regression))[6,1])
WHR_ranking$sum <- apply(WHR_ranking[,-1], 1, sum) 

WHR_ranking <- data.frame(cbind(WHR_ranking, WHR_score = WHR_summary[1:137,]$Life.Ladder))
WHR_ranking$residual <- WHR_ranking$WHR_score - WHR_ranking$sum
WHR_ranking$WHR_rank <- rank(-WHR_ranking$WHR_score)

WHR_ranking <- WHR_ranking %>% 
  dplyr::select(!sum)
WHR_ranking <- WHR_ranking[,c(1, 8, 10, 2, 3, 4, 5, 6, 7, 9)]
names(WHR_ranking)[names(WHR_ranking) == 'WHR_ranking'] <- 'COUNTRY_ISO3'

WHR_ranking_summary <- WHR_ranking %>% 
  dplyr::select(COUNTRY_ISO3, WHR_score, WHR_rank)

WHR_ranking_summary$COUNTRY_ISO3 <- countrycode(WHR_ranking_summary$COUNTRY_ISO3, 'country.name', 'iso3c') 

WHR_ranking_summary$COUNTRY_ISO3[WHR_ranking_summary$WHR_rank == 34] <- "XKX"
WHR_ranking_summary$COUNTRY_ISO3[WHR_ranking_summary$WHR_rank == 107] <- "TUR"
#Check again
```


**Age-standardized Life-satisfaction Ranking**
Reading Gallup data, add age groups
```{r}
gallup_main <- readRDS(
  "/Users/makototakahara/Downloads/(231101)GWP_cleaned_ageStandardizedWellbeing.rds")
gallup_main$Weighted.LS <- as.numeric(gallup_main$WGT*gallup_main$WP16)

gallup_main <- gallup_main %>% 
  filter(!is.na(WP1220)) %>% 
  #group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>% 
  mutate(
    age_group = case_when(
      WP1220 > 14 & WP1220 <= 29 ~ "15-29",
      WP1220 > 29 & WP1220 <= 44 ~ "30-44",
      WP1220 > 44 & WP1220 <= 59 ~ "45-59",
      WP1220 > 59 & WP1220 <= 74 ~ "60-74",
      WP1220 > 74 ~ "Over 75"))
```

Creating Age-Standardized Life-Satisfaction Ranking
```{r}
# gallup_age <- gallup_main %>% 
#   group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>% 
#   summarise(WeightedMeanLS = sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T)) %>%
#   pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
# gallup_age[is.na(gallup_age)] = 0

# gallup_age <- gallup_main %>%
#   filter(YEAR_CALENDAR >= 2020, YEAR_CALENDAR <= 2022) %>%
#   group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>%
#   summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
#   pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
# gallup_age[is.na(gallup_age)] = 0
# 
# standard_population <- c(0.3333784699, 0.2890995261, 0.2161137441,
#                               0.1203791469, 0.04150304671)
# 
# countries <- colnames(gallup_age)[2:144]
# age_standardized_ranking <- gallup_age %>%
#   summarise(across(all_of(countries),
#                    list(ASLS = ~ weighted.mean(., standard_population))))
# age_standardized_ranking <- pivot_longer(age_standardized_ranking,
#                                            cols = everything(),
#                                            names_to = "COUNTRY_ISO3",
#                                            values_to = "AS_score")
# age_standardized_ranking$COUNTRY_ISO3 <- gsub(
#   '_ASLS', '', age_standardized_ranking$COUNTRY_ISO3)

standard_population <- c(0.3333784699, 0.2890995261, 0.2161137441,
                              0.1203791469, 0.04150304671)

gallup_age_2020 <- gallup_main %>% 
  filter(YEAR_CALENDAR == 2020) %>% 
  group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>% 
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
gallup_age_2020[is.na(gallup_age_2020)] = 0
countries_2020 <- colnames(gallup_age_2020)[2:108]
age_standardized_ranking_2020 <- gallup_age_2020 %>%
  summarise(across(all_of(countries_2020), 
                   list(ASLS = ~ weighted.mean(., standard_population))))
age_standardized_ranking_2020 <- pivot_longer(age_standardized_ranking_2020, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2020")
age_standardized_ranking_2020$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2020$COUNTRY_ISO3)
n_2020 <- gallup_main %>% 
  drop_na(Weighted.LS) %>% 
  filter(YEAR_CALENDAR == 2020) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2020 = n()) 
age_standardized_ranking_2020 <- merge(age_standardized_ranking_2020, n_2020)

gallup_age_2021 <- gallup_main %>% 
  filter(YEAR_CALENDAR == 2021) %>% 
  group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>% 
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
gallup_age_2021[is.na(gallup_age_2021)] = 0
countries_2021 <- colnames(gallup_age_2021)[2:121]
age_standardized_ranking_2021 <- gallup_age_2021 %>%
  summarise(across(all_of(countries_2021), 
                   list(ASLS = ~ weighted.mean(., standard_population))))
age_standardized_ranking_2021 <- pivot_longer(age_standardized_ranking_2021, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2021")
age_standardized_ranking_2021$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2021$COUNTRY_ISO3)
n_2021 <- gallup_main %>% 
  drop_na(Weighted.LS) %>% 
  filter(YEAR_CALENDAR == 2021) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2021 = n()) 
age_standardized_ranking_2021 <- merge(age_standardized_ranking_2021, n_2021)

gallup_age_2022 <- gallup_main %>% 
  filter(YEAR_CALENDAR == 2022) %>% 
  group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>% 
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
gallup_age_2022[is.na(gallup_age_2022)] = 0
countries_2022 <- colnames(gallup_age_2022)[2:140]
age_standardized_ranking_2022 <- gallup_age_2022 %>%
  summarise(across(all_of(countries_2022), 
                   list(ASLS = ~ weighted.mean(., standard_population))))
age_standardized_ranking_2022 <- pivot_longer(age_standardized_ranking_2022, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2022")
age_standardized_ranking_2022$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2022$COUNTRY_ISO3)
n_2022 <- gallup_main %>% 
  drop_na(Weighted.LS) %>% 
  filter(YEAR_CALENDAR == 2022) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2022 = n()) 
age_standardized_ranking_2022 <- merge(age_standardized_ranking_2022, n_2022)

age_ranking_2020_2021 <- merge(x = age_standardized_ranking_2020, y = age_standardized_ranking_2021, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking <- merge(x = age_ranking_2020_2021, y = age_standardized_ranking_2022, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking[is.na(age_standardized_ranking)] <- 0

age_standardized_ranking <- age_standardized_ranking %>% 
  mutate(AS_score = (AS_score_2020*n_2020 + AS_score_2021*n_2021 + AS_score_2022*n_2022)/(n_2020+n_2021+n_2022)) %>% 
  dplyr::select(COUNTRY_ISO3, AS_score)
```

Comparing with WHR ranking
```{r}
age_standardized_ranking$AS_score <- as.numeric(
  age_standardized_ranking$AS_score)
age_standardized_ranking$AS_rank <- rank(-age_standardized_ranking$AS_score)

WHR_AS_comparison <- merge(WHR_ranking_summary, age_standardized_ranking, by="COUNTRY_ISO3", all=FALSE)

WHR_AS_comparison$rank_difference <- (WHR_AS_comparison$WHR_rank -
                                        WHR_AS_comparison$AS_rank)
WHR_AS_comparison$score_difference <- (WHR_AS_comparison$AS_score -
                                         WHR_AS_comparison$WHR_score)
```

Merging Data for Regression Analysis
```{r}
age_matrix <- gallup_main %>% 
  group_by(COUNTRY_ISO3, YEAR_CALENDAR, age_group, .drop = FALSE) %>% 
  summarise(WeightedMeanLS = sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T)) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS) %>% 
  arrange(YEAR_CALENDAR, age_group)

age_standardized_scores_wide <- age_matrix  %>%
  group_by(YEAR_CALENDAR) %>%
  summarise(across(AFG:ZWE, ~ weighted.mean(.x, standard_population)))
age_standardized_scores <- gather(age_standardized_scores_wide, COUNTRY_ISO3, AS.LS, AFG:ZWE)
colnames(age_standardized_scores) <- c("year", "COUNTRY_ISO3", "AS.LS", "Country.name")

WHR_data$COUNTRY_ISO3 <- countrycode(WHR_data$Country.name, 'country.name', 'iso3c')
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Kosovo"] <- "XKX"
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Turkiye"] <- "TUR" #temp
Standardized_WHR_data <- merge(WHR_data, age_standardized_scores, by=c("year","COUNTRY_ISO3"))
```

Age Standardized Regression Analysis
```{r}
Standardized_regression_data <- Standardized_WHR_data %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
              Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
              Generosity+Perceptions.of.corruption, data = Standardized_regression_data,
            index = c("year","Country.name"), model="within")
```

Creating Dystopia in Standardized
```{r}
Standardized_WHR_summary <- Standardized_WHR_data %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(AS.LS = mean(AS.LS, na.rm = TRUE),
            Log.GDP.per.capita = mean(Log.GDP.per.capita, na.rm = TRUE),
            Social.support = mean(Social.support, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = mean(Healthy.life.expectancy.at.birth, na.rm = TRUE),
            Freedom.to.make.life.choices = mean(Freedom.to.make.life.choices, na.rm = TRUE),
            Generosity = mean(Generosity, na.rm = TRUE),
            Perceptions.of.corruption = mean(Perceptions.of.corruption, na.rm = TRUE))


standard_dystopia <- data.frame(Country.name="Dystopia", AS.LS=NA, Log.GDP.per.capita=NA, 
                 Social.support=NA, Healthy.life.expectancy.at.birth=NA, 
                 Freedom.to.make.life.choices=NA, Generosity=NA, 
                 Perceptions.of.corruption=NA)
Standardized_WHR_summary  <- rbind(Standardized_WHR_summary, standard_dystopia)

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"] <-
  min(Standardized_WHR_summary$Log.GDP.per.capita, na.rm = TRUE)
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Dystopia", "Social.support"] <- min(Standardized_WHR_summary$Social.support, na.rm = TRUE)
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"] <-
  min(Standardized_WHR_summary$Healthy.life.expectancy.at.birth, na.rm = TRUE)
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"] <-
  min(Standardized_WHR_summary$Freedom.to.make.life.choices, na.rm = TRUE)
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"] <-
  min(Standardized_WHR_summary$Generosity, na.rm = TRUE)
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"] <-
  max(Standardized_WHR_summary$Perceptions.of.corruption, na.rm = TRUE)
```

Inpute Missing Data
```{r}
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(Standardized_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(Standardized_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(Standardized_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(Standardized_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(Standardized_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(Standardized_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(Standardized_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(Standardized_regression)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(Standardized_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(Standardized_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(Standardized_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(Standardized_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(Standardized_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(Standardized_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(Standardized_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])
```

Calculate Contributions
```{r}
standardized_distance_from_dystopia <- cbind(WHR_summary %>% 
                                  dplyr::select(Country.name) %>% 
                                  filter(Country.name != "Dystopia"),
                                (Standardized_WHR_summary[1:137, 3:8] - Standardized_WHR_summary[rep(138, 137), 3:8]))

standardized_contributions <- standardized_distance_from_dystopia$Country.name
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[2] * coef(summary(Standardized_regression))[1,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[3] * coef(summary(Standardized_regression))[2,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[4] * coef(summary(Standardized_regression))[3,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[5] * coef(summary(Standardized_regression))[4,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[6] * coef(summary(Standardized_regression))[5,1])
standardized_contributions <- cbind(standardized_contributions, standardized_distance_from_dystopia[7] * coef(summary(Standardized_regression))[6,1])

standardized_contributions$sum <- apply(standardized_contributions[,-1], 1, sum) 
ASLS <- Standardized_WHR_summary[1:2]
standardized_contributions <- merge(standardized_contributions, ASLS, 
                                    by.x="standardized_contributions",
                                    by.y="Country.name")

standardized_contributions[standardized_contributions$standardized_contributions=="Saudi Arabia", "AS.LS"] <-
  6.463708


standardized_contributions$residual <- standardized_contributions$AS.LS - standardized_contributions$sum
standardized_contributions <- standardized_contributions[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions)[names(standardized_contributions) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions$Rank <- rank(-standardized_contributions$AS.LS)
```

**Age-specific Life-satisfaction**
Group 1: 15 to 29
```{r}
#Read Data
age_matrix_1 <- age_matrix %>% 
  filter(age_group == "15-29") %>% 
  dplyr::select(-c(age_group))
  
age_standardized_scores_1 <- gather(age_matrix_1, COUNTRY_ISO3, AS.LS, AFG:ZWE)

colnames(age_standardized_scores_1) <- c("year", "COUNTRY_ISO3", "AS.LS")

WHR_data$COUNTRY_ISO3 <- countrycode(WHR_data$Country.name, 'country.name', 'iso3c')
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Kosovo"] <- "XKX"
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Turkiye"] <- "TUR" 
Standardized_WHR_1 <- merge(WHR_data, age_standardized_scores_1, by=c("year","COUNTRY_ISO3"))

#Regression
Standardized_regression_data_1 <- Standardized_WHR_1 %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_1 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                    Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                    Generosity+Perceptions.of.corruption, data = Standardized_regression_data_1,
                  index = c("year","Country.name"), model="within")


#Create Dystopia
standardized_WHR_summary_1 <- Standardized_WHR_1 %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(AS.LS = mean(AS.LS, na.rm = TRUE),
            Log.GDP.per.capita = mean(Log.GDP.per.capita, na.rm = TRUE),
            Social.support = mean(Social.support, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = mean(Healthy.life.expectancy.at.birth, na.rm = TRUE),
            Freedom.to.make.life.choices = mean(Freedom.to.make.life.choices, na.rm = TRUE),
            Generosity = mean(Generosity, na.rm = TRUE),
            Perceptions.of.corruption = mean(Perceptions.of.corruption, na.rm = TRUE))

standardized_WHR_summary_1 <- rbind(standardized_WHR_summary_1, standard_dystopia)

standardized_WHR_summary_1[standardized_WHR_summary_1$Country.name=="Dystopia", "Log.GDP.per.capita"] <-
  min(standardized_WHR_summary_1$Log.GDP.per.capita, na.rm = TRUE)
standardized_WHR_summary_1[standardized_WHR_summary_1$Country.name=="Dystopia", "Social.support"] <-
  min(standardized_WHR_summary_1$Social.support, na.rm = TRUE)
standardized_WHR_summary_1[standardized_WHR_summary_1$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"] <-
  min(standardized_WHR_summary_1$Healthy.life.expectancy.at.birth, na.rm = TRUE)
standardized_WHR_summary_1[standardized_WHR_summary_1$Country.name=="Dystopia", "Freedom.to.make.life.choices"] <-
  min(standardized_WHR_summary_1$Freedom.to.make.life.choices, na.rm = TRUE)
standardized_WHR_summary_1[standardized_WHR_summary_1$Country.name=="Dystopia", "Generosity"] <- min(standardized_WHR_summary_1$Generosity, na.rm = TRUE)
standardized_WHR_summary_1[standardized_WHR_summary_1$Country.name=="Dystopia", "Perceptions.of.corruption"] <-
  max(standardized_WHR_summary_1$Perceptions.of.corruption, na.rm = TRUE)


#Impute missing data
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(Standardized_regression_1)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(Standardized_regression_1)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(Standardized_regression_1)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(Standardized_regression_1)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(Standardized_regression_1)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(Standardized_regression_1)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(Standardized_regression_1)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(Standardized_regression_1)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(Standardized_regression_1)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(Standardized_regression_1)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(Standardized_regression_1)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(Standardized_regression_1)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(Standardized_regression_1)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(Standardized_regression_1)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(Standardized_regression_1)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

#Finding contributions
distance_from_dystopia_1 <- cbind(WHR_summary %>% 
                                                 dplyr::select(Country.name) %>% 
                                                 filter(Country.name != "Dystopia"),
                                               (standardized_WHR_summary_1[1:137, 3:8] - standardized_WHR_summary_1[rep(138, 137), 3:8]))

standardized_contributions_1 <- distance_from_dystopia_1$Country.name
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[2] * coef(summary(Standardized_regression_1))[1,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[3] * coef(summary(Standardized_regression_1))[2,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[4] * coef(summary(Standardized_regression_1))[3,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[5] * coef(summary(Standardized_regression_1))[4,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[6] * coef(summary(Standardized_regression_1))[5,1])
standardized_contributions_1 <- cbind(standardized_contributions_1, distance_from_dystopia_1[7] * coef(summary(Standardized_regression_1))[6,1])

standardized_contributions_1$sum <- apply(standardized_contributions_1[,-1], 1, sum) 
ASLS_1 <- standardized_WHR_summary_1[1:2]
standardized_contributions_1 <- merge(standardized_contributions_1, ASLS_1, 
                                          by.x="standardized_contributions_1",
                                          by.y="Country.name")

standardized_contributions_1$residual <- standardized_contributions_1$AS.LS - standardized_contributions_1$sum
standardized_contributions_1 <- standardized_contributions_1[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_1)[names(standardized_contributions_1) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_1$Rank <- rank(-standardized_contributions_1$AS.LS)
```

Group 2: 30-44
```{r}
#Read Data
age_matrix_2 <- age_matrix %>% 
  filter(age_group == "30-44") %>% 
  dplyr::select(-c(age_group))

age_standardized_scores_2 <- gather(age_matrix_2, COUNTRY_ISO3, AS.LS, AFG:ZWE)

colnames(age_standardized_scores_2) <- c("year", "COUNTRY_ISO3", "AS.LS")

WHR_data$COUNTRY_ISO3 <- countrycode(WHR_data$Country.name, 'country.name', 'iso3c')
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Kosovo"] <- "XKX"
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Turkiye"] <- "TUR" 
Standardized_WHR_2 <- merge(WHR_data, age_standardized_scores_2, by=c("year","COUNTRY_ISO3"))

#Regression
Standardized_regression_data_2 <- Standardized_WHR_2 %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_2 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                                   Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                                   Generosity+Perceptions.of.corruption, data = Standardized_regression_data_2,
                                 index = c("year","Country.name"), model="within")


#Create Dystopia
standardized_WHR_summary_2 <- Standardized_WHR_2 %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(AS.LS = mean(AS.LS, na.rm = TRUE),
            Log.GDP.per.capita = mean(Log.GDP.per.capita, na.rm = TRUE),
            Social.support = mean(Social.support, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = mean(Healthy.life.expectancy.at.birth, na.rm = TRUE),
            Freedom.to.make.life.choices = mean(Freedom.to.make.life.choices, na.rm = TRUE),
            Generosity = mean(Generosity, na.rm = TRUE),
            Perceptions.of.corruption = mean(Perceptions.of.corruption, na.rm = TRUE))

standardized_WHR_summary_2 <- rbind(standardized_WHR_summary_2, standard_dystopia)

standardized_WHR_summary_2[standardized_WHR_summary_2$Country.name=="Dystopia", "Log.GDP.per.capita"] <-
  min(standardized_WHR_summary_2$Log.GDP.per.capita, na.rm = TRUE)
standardized_WHR_summary_2[standardized_WHR_summary_2$Country.name=="Dystopia", "Social.support"] <-
  min(standardized_WHR_summary_2$Social.support, na.rm = TRUE)
standardized_WHR_summary_2[standardized_WHR_summary_2$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"] <-
  min(standardized_WHR_summary_2$Healthy.life.expectancy.at.birth, na.rm = TRUE)
standardized_WHR_summary_2[standardized_WHR_summary_2$Country.name=="Dystopia", "Freedom.to.make.life.choices"] <-
  min(standardized_WHR_summary_2$Freedom.to.make.life.choices, na.rm = TRUE)
standardized_WHR_summary_2[standardized_WHR_summary_2$Country.name=="Dystopia", "Generosity"] <- min(standardized_WHR_summary_2$Generosity, na.rm = TRUE)
standardized_WHR_summary_2[standardized_WHR_summary_2$Country.name=="Dystopia", "Perceptions.of.corruption"] <-
  max(standardized_WHR_summary_2$Perceptions.of.corruption, na.rm = TRUE)


#Impute missing data
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(Standardized_regression_2)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(Standardized_regression_2)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(Standardized_regression_2)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(Standardized_regression_2)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(Standardized_regression_2)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(Standardized_regression_2)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(Standardized_regression_2)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(Standardized_regression_2)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(Standardized_regression_2)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(Standardized_regression_2)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(Standardized_regression_2)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(Standardized_regression_2)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(Standardized_regression_2)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(Standardized_regression_2)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(Standardized_regression_2)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

#Finding contributions
distance_from_dystopia_2 <- cbind(WHR_summary %>% 
                                                 dplyr::select(Country.name) %>% 
                                                 filter(Country.name != "Dystopia"),
                                               (standardized_WHR_summary_2[1:137, 3:8] - standardized_WHR_summary_2[rep(138, 137), 3:8]))

standardized_contributions_2 <- distance_from_dystopia_2$Country.name
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[2] * coef(summary(Standardized_regression_2))[1,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[3] * coef(summary(Standardized_regression_2))[2,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[4] * coef(summary(Standardized_regression_2))[3,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[5] * coef(summary(Standardized_regression_2))[4,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[6] * coef(summary(Standardized_regression_2))[5,1])
standardized_contributions_2 <- cbind(standardized_contributions_2, distance_from_dystopia_2[7] * coef(summary(Standardized_regression_2))[6,1])

standardized_contributions_2$sum <- apply(standardized_contributions_2[,-1], 1, sum) 
ASLS_2 <- standardized_WHR_summary_2[1:2]
standardized_contributions_2 <- merge(standardized_contributions_2, ASLS_2, 
                                          by.x="standardized_contributions_2",
                                          by.y="Country.name")

standardized_contributions_2$residual <- standardized_contributions_2$AS.LS - standardized_contributions_2$sum
standardized_contributions_2 <- standardized_contributions_2[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_2)[names(standardized_contributions_2) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_2$Rank <- rank(-standardized_contributions_2$AS.LS)
```

Group 3: 45-59
```{r}
#Read Data
age_matrix_3 <- age_matrix %>% 
  filter(age_group == "45-59") %>% 
  dplyr::select(-c(age_group))

age_standardized_scores_3 <- gather(age_matrix_3, COUNTRY_ISO3, AS.LS, AFG:ZWE)

colnames(age_standardized_scores_3) <- c("year", "COUNTRY_ISO3", "AS.LS")

WHR_data$COUNTRY_ISO3 <- countrycode(WHR_data$Country.name, 'country.name', 'iso3c')
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Kosovo"] <- "XKX"
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Turkiye"] <- "TUR" 
Standardized_WHR_3 <- merge(WHR_data, age_standardized_scores_3, by=c("year","COUNTRY_ISO3"))

#Regression
Standardized_regression_data_3 <- Standardized_WHR_3 %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_3 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                                   Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                                   Generosity+Perceptions.of.corruption, data = Standardized_regression_data_3,
                                 index = c("year","Country.name"), model="within")


#Create Dystopia
standardized_WHR_summary_3 <- Standardized_WHR_3 %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(AS.LS = mean(AS.LS, na.rm = TRUE),
            Log.GDP.per.capita = mean(Log.GDP.per.capita, na.rm = TRUE),
            Social.support = mean(Social.support, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = mean(Healthy.life.expectancy.at.birth, na.rm = TRUE),
            Freedom.to.make.life.choices = mean(Freedom.to.make.life.choices, na.rm = TRUE),
            Generosity = mean(Generosity, na.rm = TRUE),
            Perceptions.of.corruption = mean(Perceptions.of.corruption, na.rm = TRUE))

standardized_WHR_summary_3 <- rbind(standardized_WHR_summary_3, standard_dystopia)

standardized_WHR_summary_3[standardized_WHR_summary_3$Country.name=="Dystopia", "Log.GDP.per.capita"] <-
  min(standardized_WHR_summary_3$Log.GDP.per.capita, na.rm = TRUE)
standardized_WHR_summary_3[standardized_WHR_summary_3$Country.name=="Dystopia", "Social.support"] <-
  min(standardized_WHR_summary_3$Social.support, na.rm = TRUE)
standardized_WHR_summary_3[standardized_WHR_summary_3$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"] <-
  min(standardized_WHR_summary_3$Healthy.life.expectancy.at.birth, na.rm = TRUE)
standardized_WHR_summary_3[standardized_WHR_summary_3$Country.name=="Dystopia", "Freedom.to.make.life.choices"] <-
  min(standardized_WHR_summary_3$Freedom.to.make.life.choices, na.rm = TRUE)
standardized_WHR_summary_3[standardized_WHR_summary_3$Country.name=="Dystopia", "Generosity"] <- min(standardized_WHR_summary_3$Generosity, na.rm = TRUE)
standardized_WHR_summary_3[standardized_WHR_summary_3$Country.name=="Dystopia", "Perceptions.of.corruption"] <-
  max(standardized_WHR_summary_3$Perceptions.of.corruption, na.rm = TRUE)


#Impute missing data
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(Standardized_regression_3)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(Standardized_regression_3)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(Standardized_regression_3)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(Standardized_regression_3)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(Standardized_regression_3)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(Standardized_regression_3)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(Standardized_regression_3)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(Standardized_regression_3)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(Standardized_regression_3)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(Standardized_regression_3)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(Standardized_regression_3)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(Standardized_regression_3)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(Standardized_regression_3)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(Standardized_regression_3)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(Standardized_regression_3)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

#Finding contributions
distance_from_dystopia_3 <- cbind(WHR_summary %>% 
                                  dplyr::select(Country.name) %>% 
                                  filter(Country.name != "Dystopia"),
                                (standardized_WHR_summary_3[1:137, 3:8] - standardized_WHR_summary_3[rep(138, 137), 3:8]))

standardized_contributions_3 <- distance_from_dystopia_3$Country.name
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[2] * coef(summary(Standardized_regression_3))[1,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[3] * coef(summary(Standardized_regression_3))[2,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[4] * coef(summary(Standardized_regression_3))[3,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[5] * coef(summary(Standardized_regression_3))[4,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[6] * coef(summary(Standardized_regression_3))[5,1])
standardized_contributions_3 <- cbind(standardized_contributions_3, distance_from_dystopia_3[7] * coef(summary(Standardized_regression_3))[6,1])

standardized_contributions_3$sum <- apply(standardized_contributions_3[,-1], 1, sum) 
ASLS_3 <- standardized_WHR_summary_3[1:2]
standardized_contributions_3 <- merge(standardized_contributions_3, ASLS_3, 
                                      by.x="standardized_contributions_3",
                                      by.y="Country.name")

standardized_contributions_3$residual <- standardized_contributions_3$AS.LS - standardized_contributions_3$sum
standardized_contributions_3 <- standardized_contributions_3[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_3)[names(standardized_contributions_3) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_3$Rank <- rank(-standardized_contributions_3$AS.LS)
```

Group 4: 60-74
```{r}
#Read Data
age_matrix_4 <- age_matrix %>% 
  filter(age_group == "60-74") %>% 
  dplyr::select(-c(age_group))

age_standardized_scores_4 <- gather(age_matrix_4, COUNTRY_ISO3, AS.LS, AFG:ZWE)

colnames(age_standardized_scores_4) <- c("year", "COUNTRY_ISO3", "AS.LS")

WHR_data$COUNTRY_ISO3 <- countrycode(WHR_data$Country.name, 'country.name', 'iso3c')
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Kosovo"] <- "XKX"
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Turkiye"] <- "TUR" 
Standardized_WHR_4 <- merge(WHR_data, age_standardized_scores_4, by=c("year","COUNTRY_ISO3"))

#Regression
Standardized_regression_data_4 <- Standardized_WHR_4 %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_4 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                                   Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                                   Generosity+Perceptions.of.corruption, data = Standardized_regression_data_4,
                                 index = c("year","Country.name"), model="within")


#Create Dystopia
standardized_WHR_summary_4 <- Standardized_WHR_4 %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(AS.LS = mean(AS.LS, na.rm = TRUE),
            Log.GDP.per.capita = mean(Log.GDP.per.capita, na.rm = TRUE),
            Social.support = mean(Social.support, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = mean(Healthy.life.expectancy.at.birth, na.rm = TRUE),
            Freedom.to.make.life.choices = mean(Freedom.to.make.life.choices, na.rm = TRUE),
            Generosity = mean(Generosity, na.rm = TRUE),
            Perceptions.of.corruption = mean(Perceptions.of.corruption, na.rm = TRUE))

standardized_WHR_summary_4 <- rbind(standardized_WHR_summary_4, standard_dystopia)

standardized_WHR_summary_4[standardized_WHR_summary_4$Country.name=="Dystopia", "Log.GDP.per.capita"] <-
  min(standardized_WHR_summary_4$Log.GDP.per.capita, na.rm = TRUE)
standardized_WHR_summary_4[standardized_WHR_summary_4$Country.name=="Dystopia", "Social.support"] <-
  min(standardized_WHR_summary_4$Social.support, na.rm = TRUE)
standardized_WHR_summary_4[standardized_WHR_summary_4$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"] <-
  min(standardized_WHR_summary_4$Healthy.life.expectancy.at.birth, na.rm = TRUE)
standardized_WHR_summary_4[standardized_WHR_summary_4$Country.name=="Dystopia", "Freedom.to.make.life.choices"] <-
  min(standardized_WHR_summary_4$Freedom.to.make.life.choices, na.rm = TRUE)
standardized_WHR_summary_4[standardized_WHR_summary_4$Country.name=="Dystopia", "Generosity"] <- min(standardized_WHR_summary_4$Generosity, na.rm = TRUE)
standardized_WHR_summary_4[standardized_WHR_summary_4$Country.name=="Dystopia", "Perceptions.of.corruption"] <-
  max(standardized_WHR_summary_4$Perceptions.of.corruption, na.rm = TRUE)


#Impute missing data
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(Standardized_regression_4)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(Standardized_regression_4)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(Standardized_regression_4)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(Standardized_regression_4)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(Standardized_regression_4)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(Standardized_regression_4)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(Standardized_regression_4)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(Standardized_regression_4)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(Standardized_regression_4)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(Standardized_regression_4)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(Standardized_regression_4)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(Standardized_regression_4)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(Standardized_regression_4)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(Standardized_regression_4)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(Standardized_regression_4)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

#Finding contributions
distance_from_dystopia_4 <- cbind(WHR_summary %>% 
                                                 dplyr::select(Country.name) %>% 
                                                 filter(Country.name != "Dystopia"),
                                               (standardized_WHR_summary_4[1:137, 3:8] - standardized_WHR_summary_4[rep(138, 137), 3:8]))

standardized_contributions_4 <- distance_from_dystopia_4$Country.name
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[2] * coef(summary(Standardized_regression_4))[1,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[3] * coef(summary(Standardized_regression_4))[2,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[4] * coef(summary(Standardized_regression_4))[3,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[5] * coef(summary(Standardized_regression_4))[4,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[6] * coef(summary(Standardized_regression_4))[5,1])
standardized_contributions_4 <- cbind(standardized_contributions_4, distance_from_dystopia_4[7] * coef(summary(Standardized_regression_4))[6,1])

standardized_contributions_4$sum <- apply(standardized_contributions_4[,-1], 1, sum) 
ASLS_4 <- standardized_WHR_summary_4[1:2]
standardized_contributions_4 <- merge(standardized_contributions_4, ASLS_4, 
                                      by.x="standardized_contributions_4",
                                      by.y="Country.name")

standardized_contributions_4$residual <- standardized_contributions_4$AS.LS - standardized_contributions_4$sum
standardized_contributions_4 <- standardized_contributions_4[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_4)[names(standardized_contributions_4) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_4$Rank <- rank(-standardized_contributions_4$AS.LS)
```

Group 5: Over 74
```{r}
#Read Data
age_matrix_5 <- age_matrix %>% 
  filter(age_group == "Over 75") %>% 
  dplyr::select(-c(age_group))

age_standardized_scores_5 <- gather(age_matrix_5, COUNTRY_ISO3, AS.LS, AFG:ZWE)

colnames(age_standardized_scores_5) <- c("year", "COUNTRY_ISO3", "AS.LS")

WHR_data$COUNTRY_ISO3 <- countrycode(WHR_data$Country.name, 'country.name', 'iso3c')
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Kosovo"] <- "XKX"
WHR_data$COUNTRY_ISO3[WHR_data$Country.name=="Turkiye"] <- "TUR" 
Standardized_WHR_5 <- merge(WHR_data, age_standardized_scores_5, by=c("year","COUNTRY_ISO3"))

#Regression
Standardized_regression_data_5 <- Standardized_WHR_5 %>%
  filter(!is.na(AS.LS),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

Standardized_regression_5 <- plm(AS.LS~ Log.GDP.per.capita+Social.support+
                                   Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                                   Generosity+Perceptions.of.corruption, data = Standardized_regression_data_5,
                                 index = c("year","Country.name"), model="within")


#Create Dystopia
standardized_WHR_summary_5 <- Standardized_WHR_5 %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(AS.LS = mean(AS.LS, na.rm = TRUE),
            Log.GDP.per.capita = mean(Log.GDP.per.capita, na.rm = TRUE),
            Social.support = mean(Social.support, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = mean(Healthy.life.expectancy.at.birth, na.rm = TRUE),
            Freedom.to.make.life.choices = mean(Freedom.to.make.life.choices, na.rm = TRUE),
            Generosity = mean(Generosity, na.rm = TRUE),
            Perceptions.of.corruption = mean(Perceptions.of.corruption, na.rm = TRUE))

standardized_WHR_summary_5 <- rbind(standardized_WHR_summary_5, standard_dystopia)

standardized_WHR_summary_5[standardized_WHR_summary_5$Country.name=="Dystopia", "Log.GDP.per.capita"] <-
  min(standardized_WHR_summary_5$Log.GDP.per.capita, na.rm = TRUE)
standardized_WHR_summary_5[standardized_WHR_summary_5$Country.name=="Dystopia", "Social.support"] <-
  min(standardized_WHR_summary_5$Social.support, na.rm = TRUE)
standardized_WHR_summary_5[standardized_WHR_summary_5$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"] <-
  min(standardized_WHR_summary_5$Healthy.life.expectancy.at.birth, na.rm = TRUE)
standardized_WHR_summary_5[standardized_WHR_summary_5$Country.name=="Dystopia", "Freedom.to.make.life.choices"] <-
  min(standardized_WHR_summary_5$Freedom.to.make.life.choices, na.rm = TRUE)
standardized_WHR_summary_5[standardized_WHR_summary_5$Country.name=="Dystopia", "Generosity"] <- min(standardized_WHR_summary_5$Generosity, na.rm = TRUE)
standardized_WHR_summary_5[standardized_WHR_summary_5$Country.name=="Dystopia", "Perceptions.of.corruption"] <-
  max(standardized_WHR_summary_5$Perceptions.of.corruption, na.rm = TRUE)


#Impute missing data
Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(Standardized_regression_5)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(Standardized_regression_5)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(Standardized_regression_5)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(Standardized_regression_5)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(Standardized_regression_5)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(Standardized_regression_5)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(Standardized_regression_5)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(Standardized_regression_5)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(Standardized_regression_5)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(Standardized_regression_5)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(Standardized_regression_5)$coefficients["Generosity", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Generosity"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(Standardized_regression_5)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(Standardized_regression_5)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(Standardized_regression_5)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

Standardized_WHR_summary[Standardized_WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(Standardized_regression_5)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(Standardized_WHR_summary[
    Standardized_WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

#Finding contributions
distance_from_dystopia_5 <- cbind(WHR_summary %>% 
                                                 dplyr::select(Country.name) %>% 
                                                 filter(Country.name != "Dystopia"),
                                               (standardized_WHR_summary_5[1:137, 3:8] - standardized_WHR_summary_5[rep(138, 137), 3:8]))

standardized_contributions_5 <- distance_from_dystopia_5$Country.name
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[2] * coef(summary(Standardized_regression_5))[1,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[3] * coef(summary(Standardized_regression_5))[2,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[4] * coef(summary(Standardized_regression_5))[3,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[5] * coef(summary(Standardized_regression_5))[4,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[6] * coef(summary(Standardized_regression_5))[5,1])
standardized_contributions_5 <- cbind(standardized_contributions_5, distance_from_dystopia_5[7] * coef(summary(Standardized_regression_5))[6,1])

standardized_contributions_5$sum <- apply(standardized_contributions_5[,-1], 1, sum) 
ASLS_5 <- standardized_WHR_summary_5[1:2]
standardized_contributions_5 <- merge(standardized_contributions_5, ASLS_5, 
                                      by.x="standardized_contributions_5",
                                      by.y="Country.name")


standardized_contributions_5$residual <- standardized_contributions_5$AS.LS - standardized_contributions_5$sum
standardized_contributions_5 <- standardized_contributions_5[, c(1, 9, 2, 3, 4, 5, 6, 7, 10)]
names(standardized_contributions_5)[names(standardized_contributions_5) == 'standardized_contributions'] <- 
  'Country'
standardized_contributions_5$Rank <- rank(-standardized_contributions_5$AS.LS)
```

**Summarizing Findings Through Visualizations**
Comparing WHR LS and AS LS
```{r}
comparing_results_plot <- WHR_AS_comparison[, c("COUNTRY_ISO3", "WHR_rank", "AS_rank")]
GGally::ggparcoord(comparing_results_plot,
                   columns = 2:3, groupColumn = 1,  
                   scale="globalminmax", 
                   showPoints = TRUE, 
                   title = "Ranking Comparison"
) + scale_y_reverse()
```

Age specific rankings
```{r}
write.csv(standardized_contributions, "/Users/makototakahara/Downloads/standardized_contributions.csv")
write.csv(standardized_contributions_1, "/Users/makototakahara/Downloads/standardized_contributions_1.csv")
write.csv(standardized_contributions_2, "/Users/makototakahara/Downloads/standardized_contributions_2.csv")
write.csv(standardized_contributions_3, "/Users/makototakahara/Downloads/standardized_contributions_3.csv")
write.csv(standardized_contributions_4, "/Users/makototakahara/Downloads/standardized_contributions_4.csv")
write.csv(standardized_contributions_5, "/Users/makototakahara/Downloads/standardized_contributions_5.csv")
```


Finding countries with significant changes
```{r}
significant_difference <- WHR_AS_comparison %>% 
  filter(score_difference >= 0.25 | score_difference <= -0.25)

significant_difference_countries <- significant_difference$COUNTRY_ISO3

significant_difference_details <- gallup_age[, significant_difference_countries]

sd(WHR_AS_comparison$WHR_score)
sd(WHR_AS_comparison$AS_score)
```

In these countries, younger people are happier and there are a lot of them. 
This means that as age-standardization decreases weight of younger people, scores decrease.

Serbia and Lebanon are outliers because they increase.
For Serbia, this is because there are more older people who are unhappy, so a decrease in their weights improves their score.
For Lebanon a trend is less clear - I think it is because happier younger people are weighted more in age-standardized score.

In terms of demographics, there are a few outliers to the pattern: UAE and Saudi Arabia, in addition to Serbia and Lebanon.
Both have more men around the ages of 30 to 70. 
Strictly in terms of population, there is a high proportion of middle age people, with these people being relatively happy. 
Thus, this middle age is weighted less in the age-standardized scores, leading to a lower score. 


Plotting coefficients for contributions
```{r}
data1 <- Standardized_regression_data_1[, -13:-15]
data1$age_group <- 1
data2 <- Standardized_regression_data_2[, -13:-15]
data2$age_group <- 2
data3 <- Standardized_regression_data_3[, -13:-15]
data3$age_group <- 3
data4 <- Standardized_regression_data_4[, -13:-15]
data4$age_group <- 4
data5 <- Standardized_regression_data_5[, -13:-15]
data5$age_group <- 5

big_regression_data <- bind_rows(data1, data2, data3, data4, data5)
big_regression_data$age_group <- as.factor(big_regression_data$age_group)

stanardized_big_regression_data <-data.frame(scale(big_regression_data[, 5:10]))
colnames(stanardized_big_regression_data) <- paste("Standard", colnames(stanardized_big_regression_data), sep = ".")
big_regression_data <- cbind(big_regression_data, stanardized_big_regression_data)

big_model <- plm(AS.LS ~ age_group*Standard.Log.GDP.per.capita + age_group*Standard.Social.support + 
               age_group*Standard.Healthy.life.expectancy.at.birth + 
               age_group*Standard.Freedom.to.make.life.choices + age_group*Standard.Generosity +
               age_group*Standard.Perceptions.of.corruption, data=big_regression_data, 
               index = c("year","Country.name"), model="within")

big_model_summary <- data.frame(summary(big_model)$coefficients)
big_model_summary <- big_model_summary[-1:-4,] 
big_model_summary$group <- c(1, 1, 1, 1, 1, 1, 2, 3, 4, 5, 2, 3, 4, 5,
                             2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5)
big_model_summary$group <- as.factor(big_model_summary$group)
big_model_summary$group <- c(1, 1, 1, 1, 1, 1, 2, 3, 4, 5, 2, 3, 4, 5,
                             2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5, 2, 3, 4, 5)
big_model_summary$variables <- c("Log.GDP.per.capita", "Social.support", 
                                 "Healthy.life.expectancy.at.birth", 
                                 "Freedom.to.make.life.choices",
                                 "Generosity", "Perceptions.of.corruption",
                                 "Log.GDP.per.capita", "Log.GDP.per.capita", 
                                 "Log.GDP.per.capita", "Log.GDP.per.capita",
                                 "Social.support", "Social.support", 
                                 "Social.support", "Social.support",
                                 "Healthy.life.expectancy.at.birth", 
                                 "Healthy.life.expectancy.at.birth", 
                                 "Healthy.life.expectancy.at.birth", 
                                 "Healthy.life.expectancy.at.birth", 
                                 "Freedom.to.make.life.choices",
                                 "Freedom.to.make.life.choices",
                                 "Freedom.to.make.life.choices",
                                 "Freedom.to.make.life.choices",
                                 "Generosity", "Generosity",
                                 "Generosity", "Generosity",
                                 "Perceptions.of.corruption",
                                 "Perceptions.of.corruption",
                                 "Perceptions.of.corruption",
                                 "Perceptions.of.corruption")
a <- big_model_summary$Estimate[1:6]
b <- as.numeric(a[1]) + as.numeric(big_model_summary$Estimate[7:10])
c <- as.numeric(a[2]) + as.numeric(big_model_summary$Estimate[11:14])
d <- as.numeric(a[3]) + as.numeric(big_model_summary$Estimate[15:18])
e <- as.numeric(a[4]) + as.numeric(big_model_summary$Estimate[19:22])
f <- as.numeric(a[5]) + as.numeric(big_model_summary$Estimate[23:26])
g <- as.numeric(a[6]) + as.numeric(big_model_summary$Estimate[27:30])
values <- c(a, b, c, d, e, f, g)
big_model_summary$values <- values

AS_coefficients_plot <- ggplot(big_model_summary, 
                               aes(fill=variables, y=values, x=group)) + 
  geom_bar(position="stack", stat="identity")
AS_coefficients_plot
```
Hypothesis Tests
```{r}
joint_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Log.GDP.per.capita +
                                              age_group2:Standard.Social.support +
                                              age_group2:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group2:Standard.Freedom.to.make.life.choices +                                                                      age_group2:Standard.Generosity -
                                              age_group2:Standard.Perceptions.of.corruption = 0"))

joint_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Log.GDP.per.capita + 
                                              age_group3:Standard.Social.support +
                                              age_group3:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group3:Standard.Freedom.to.make.life.choices + 
                                              age_group3:Standard.Generosity -
                                              age_group3:Standard.Perceptions.of.corruption -
                                              age_group2:Standard.Log.GDP.per.capita - 
                                              age_group2:Standard.Social.support -
                                              age_group2:Standard.Healthy.life.expectancy.at.birth - 
                                              age_group2:Standard.Freedom.to.make.life.choices - 
                                              age_group2:Standard.Generosity +
                                              age_group2:Standard.Perceptions.of.corruption = 0"))

joint_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Log.GDP.per.capita + 
                                              age_group4:Standard.Social.support +
                                              age_group4:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group4:Standard.Freedom.to.make.life.choices + 
                                              age_group4:Standard.Generosity -
                                              age_group4:Standard.Perceptions.of.corruption -
                                              age_group3:Standard.Log.GDP.per.capita - 
                                              age_group3:Standard.Social.support - 
                                              age_group3:Standard.Healthy.life.expectancy.at.birth - 
                                              age_group3:Standard.Freedom.to.make.life.choices - 
                                              age_group3:Standard.Generosity +
                                              age_group3:Standard.Perceptions.of.corruption = 0"))

joint_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita + 
                                              age_group5:Standard.Social.support +
                                              age_group5:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group5:Standard.Freedom.to.make.life.choices +
                                              age_group5:Standard.Generosity -
                                              age_group5:Standard.Perceptions.of.corruption -
                                              age_group4:Standard.Log.GDP.per.capita - 
                                              age_group4:Standard.Social.support -
                                              age_group4:Standard.Healthy.life.expectancy.at.birth - 
                                              age_group4:Standard.Freedom.to.make.life.choices - 
                                              age_group4:Standard.Generosity +
                                              age_group4:Standard.Perceptions.of.corruption = 0"))

joint_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita +
                                              age_group5:Standard.Social.support +
                                              age_group5:Standard.Healthy.life.expectancy.at.birth + 
                                              age_group5:Standard.Freedom.to.make.life.choices +                                                                      age_group5:Standard.Generosity -
                                              age_group5:Standard.Perceptions.of.corruption = 0"))

gdp_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Log.GDP.per.capita -
                                          age_group2:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Log.GDP.per.capita -
                                          age_group3:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita -
                                          age_group4:Standard.Log.GDP.per.capita = 0"))
gdp_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Log.GDP.per.capita = 0"))

ss_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Social.support = 0"))
ss_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Social.support - age_group2:Standard.Social.support = 0"))
ss_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Social.support - age_group3:Standard.Social.support = 0"))
ss_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Social.support - age_group4:Standard.Social.support = 0"))
ss_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Social.support = 0"))

le_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Healthy.life.expectancy.at.birth -
                                         age_group2:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Healthy.life.expectancy.at.birth -
                                         age_group3:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Healthy.life.expectancy.at.birth -
                                         age_group4:Standard.Healthy.life.expectancy.at.birth = 0"))
le_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Healthy.life.expectancy.at.birth = 0"))

fr_hypo_12<- glht(big_model, linfct = c("age_group2:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Freedom.to.make.life.choices -
                                         age_group2:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Freedom.to.make.life.choices -
                                         age_group3:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Freedom.to.make.life.choices -
                                         age_group4:Standard.Freedom.to.make.life.choices = 0"))
fr_hypo_15<- glht(big_model, linfct = c("age_group5:Standard.Freedom.to.make.life.choices = 0"))

ge_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Generosity = 0"))
ge_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Generosity - age_group2:Standard.Generosity = 0"))
ge_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Generosity - age_group3:Standard.Generosity = 0"))
ge_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Generosity - age_group4:Standard.Generosity = 0"))
ge_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Generosity = 0"))

co_hypo_12 <- glht(big_model, linfct = c("age_group2:Standard.Perceptions.of.corruption = 0"))
co_hypo_23 <- glht(big_model, linfct = c("age_group3:Standard.Perceptions.of.corruption - 
                                         age_group2:Standard.Perceptions.of.corruption = 0"))
co_hypo_34 <- glht(big_model, linfct = c("age_group4:Standard.Perceptions.of.corruption - 
                                         age_group3:Standard.Perceptions.of.corruption = 0"))
co_hypo_45 <- glht(big_model, linfct = c("age_group5:Standard.Perceptions.of.corruption - 
                                         age_group4:Standard.Perceptions.of.corruption = 0"))
co_hypo_15 <- glht(big_model, linfct = c("age_group5:Standard.Perceptions.of.corruption = 0"))
```

Data frame of hypothesis tests
```{r}
joint_test_matrix <- data.frame(matrix(ncol = 5, nrow = 7))
x <- c("compare12", "compare23", "compare34", "compare45", "compare15")
y <- c("Log.GDP.per.capita", "Social.support", "Healthy,life.expectancy.at.birth", "Freedom.to.make.life.choices", "Generosity", "Perceptions.of.corruption", "All")
colnames(joint_test_matrix) <- x
rownames(joint_test_matrix) <- y

joint_test_matrix[1,1] <- "0.06398 (0.04634)"
joint_test_matrix[1,2] <- "-0.03490 (0.04634)"
joint_test_matrix[1,3] <- "-0.04198 (0.04634)"
joint_test_matrix[1,4] <- "-0.01108 (0.04653)"
joint_test_matrix[1,5] <- "-0.02398 (0.04653)"

joint_test_matrix[2,1] <- "0.05085 (0.03255)"
joint_test_matrix[2,2] <- "0.001623 (0.032548)"
joint_test_matrix[2,3] <- "0.01479 (0.03255)"
joint_test_matrix[2,4] <- "-0.02606 (0.03258)"
joint_test_matrix[2,5] <- "0.04121 (0.03258)"

joint_test_matrix[3,1] <- "-0.14787 (0.04075)***"
joint_test_matrix[3,2] <- "-0.03245 (0.04075)"
joint_test_matrix[3,3] <- "0.004017 (0.040750)"
joint_test_matrix[3,4] <- "0.01664 (0.04090)"
joint_test_matrix[3,5] <- "-0.1597 (0.0409)***"

joint_test_matrix[4,1] <- "-0.03964 (0.02830)"
joint_test_matrix[4,2] <- "-0.01331 (0.02830)"
joint_test_matrix[4,3] <- "0.01574 (0.02830)"
joint_test_matrix[4,4] <- "0.02386 (0.02839)"
joint_test_matrix[4,5] <- "-0.01335 (0.02839)"

joint_test_matrix[5,1] <- "0.03167 (0.02445)"
joint_test_matrix[5,2] <- "0.05276 (0.02445)*"
joint_test_matrix[5,3] <- "0.06704 (0.02445)**"
joint_test_matrix[5,4] <- "0.06202 (0.02452)*"
joint_test_matrix[5,5] <- "0.21350 (0.02452)***"

joint_test_matrix[6,1] <- "-0.13212 (0.02705)***"
joint_test_matrix[6,2] <- "-0.09076 (0.02705)***"
joint_test_matrix[6,3] <- "-0.07157 (0.02705)**"
joint_test_matrix[6,4] <- "0.21350 (0.02714)"
joint_test_matrix[6,5] <- "-0.25597 (0.02714)***"

joint_test_matrix[7,1] <- "0.09112 (0.03463)**"
joint_test_matrix[7,2] <- "0.06447 (0.03463)"
joint_test_matrix[7,3] <- "0.13118 (0.03463)***"
joint_test_matrix[7,4] <- "0.02690 (0.03469)"
joint_test_matrix[7,5] <- "0.31368 (0.03469)***"
```


Distributional Plots
```{r}
hist(WHR_AS_comparison$WHR_score, col=rgb(1,0,0,0.5), xlim=c(0,10), breaks = 30, main="Overlapping Histogram (Blue: WHR Score, Red: AS Score)", xlab="Variable")
hist(WHR_AS_comparison$AS_score, col=rgb(0,0,1,0.5), breaks = 30, add=T)
box()
```


World Map
```{r}
WHR_AS_comparison$COUNTRY_NAME <- countrycode(WHR_AS_comparison$COUNTRY_ISO3, 'iso3c', 'country.name') 
WHR_AS_comparison$COUNTRY_NAME[WHR_AS_comparison$COUNTRY_ISO3 == "XKX"] <- "Kosovo"
WHR_AS_comparison$COUNTRY_NAME[WHR_AS_comparison$COUNTRY_NAME == "United States"] <- "USA"
  
  
WHR_AS_comparison <- WHR_AS_comparison %>% 
  rename(region = COUNTRY_NAME)

WHR_AS_comparison <- WHR_AS_comparison %>% 
  mutate(bin = cut(score_difference, breaks = seq(-1, 0.5, length.out = 13), include.lowest = TRUE))

# Merge the data with the world map
world_map <- map_data("world") %>% filter(!(region%in%c("French Southern and Antarctic Lands","Antarctica"))) 
world_map <- left_join(world_map, WHR_AS_comparison, by = "region")

# Create a choropleth map with discrete bins
ggplot(world_map, aes(x = long, y = lat, group = group, fill = bin)) +
  geom_polygon(color = "black", size = 0.1) +
  scale_fill_manual(values = c("#67001F", "#B2182B", "#D6604D", "#F4A582", "#FDDBC7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")) + 
  theme_minimal() +
  ggtitle("World Map for Score Difference from WHR to AS")
```

Variance and Gini
```{r}
library(DescTools)

var(WHR_AS_comparison$WHR_score)
var(WHR_AS_comparison$AS_score)

var.test(WHR_AS_comparison$WHR_score, WHR_AS_comparison$AS_score, alternative = "less")

Gini(WHR_AS_comparison$WHR_score, conf.level = 0.95)
Gini(WHR_AS_comparison$AS_score, conf.level = 0.95)
```

Ranking for 2013
```{r}
# #NEED TO GET N FROM WHR
# WHR_summary_2013 <- WHR_data %>% filter(year >= 2010, year <= 2012) %>% 
#   group_by(Country.name) %>% 
#   summarize(Life.Ladder = weighted.mean(Life.Ladder, n),
#             Log.GDP.per.capita = mean(Log.GDP.per.capita, na.rm = TRUE),
#             Social.support = mean(Social.support, na.rm = TRUE),
#             Healthy.life.expectancy.at.birth = mean(Healthy.life.expectancy.at.birth, na.rm = TRUE),
#             Freedom.to.make.life.choices = mean(Freedom.to.make.life.choices, na.rm = TRUE),
#             Generosity = mean(Generosity, na.rm = TRUE),
#             Perceptions.of.corruption = mean(Perceptions.of.corruption, na.rm = TRUE))
# 
# hello <- gallup_main %>% filter(YEAR_CALENDAR >= 2010, YEAR_CALENDAR <= 2012) %>% 
#   drop_na(Weighted.LS) %>% 
#   group_by(COUNTRY_ISO3, YEAR_CALENDAR) %>% 
#   summarize(Life.Ladder = sum(Weighted.LS)/sum(WGT),
#             n = n())
  

gallup_age_2010 <- gallup_main %>% 
  filter(YEAR_CALENDAR == 2010) %>% 
  group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>% 
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
gallup_age_2010[is.na(gallup_age_2010)] = 0
countries_2010 <- colnames(gallup_age_2010)[2:125]
age_standardized_ranking_2010 <- gallup_age_2010 %>%
  summarise(across(all_of(countries_2010), 
                   list(ASLS = ~ weighted.mean(., standard_population))))
age_standardized_ranking_2010 <- pivot_longer(age_standardized_ranking_2010, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2010")
age_standardized_ranking_2010$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2010$COUNTRY_ISO3)
n_2010 <- gallup_main %>% 
  drop_na(Weighted.LS) %>% 
  filter(YEAR_CALENDAR == 2010) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2010 = n()) 
age_standardized_ranking_2010 <- merge(age_standardized_ranking_2010, n_2010)

gallup_age_2011 <- gallup_main %>% 
  filter(YEAR_CALENDAR == 2011) %>% 
  group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>% 
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
gallup_age_2011[is.na(gallup_age_2011)] = 0
countries_2011 <- colnames(gallup_age_2011)[2:149]
age_standardized_ranking_2011 <- gallup_age_2011 %>%
  summarise(across(all_of(countries_2011), 
                   list(ASLS = ~ weighted.mean(., standard_population))))
age_standardized_ranking_2011 <- pivot_longer(age_standardized_ranking_2011, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2011")
age_standardized_ranking_2011$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2011$COUNTRY_ISO3)
n_2011 <- gallup_main %>% 
  drop_na(Weighted.LS) %>% 
  filter(YEAR_CALENDAR == 2011) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2011 = n()) 
age_standardized_ranking_2011 <- merge(age_standardized_ranking_2011, n_2011)

gallup_age_2012 <- gallup_main %>% 
  filter(YEAR_CALENDAR == 2012) %>% 
  group_by(COUNTRY_ISO3, age_group, .drop = FALSE) %>% 
  summarise(WeightedMeanLS = (sum(Weighted.LS, na.rm=T)/sum(WGT, na.rm=T))) %>%
  pivot_wider(names_from = COUNTRY_ISO3, values_from = WeightedMeanLS)
gallup_age_2012[is.na(gallup_age_2012)] = 0
countries_2012 <- colnames(gallup_age_2012)[2:143]
age_standardized_ranking_2012 <- gallup_age_2012 %>%
  summarise(across(all_of(countries_2012), 
                   list(ASLS = ~ weighted.mean(., standard_population))))
age_standardized_ranking_2012 <- pivot_longer(age_standardized_ranking_2012, 
                                           cols = everything(),
                                           names_to = "COUNTRY_ISO3", 
                                           values_to = "AS_score_2012")
age_standardized_ranking_2012$COUNTRY_ISO3 <- gsub(
  '_ASLS', '', age_standardized_ranking_2012$COUNTRY_ISO3)
n_2012 <- gallup_main %>% 
  drop_na(Weighted.LS) %>% 
  filter(YEAR_CALENDAR == 2012) %>% 
  group_by(COUNTRY_ISO3) %>% 
  summarize(n_2012 = n()) 
age_standardized_ranking_2012 <- merge(age_standardized_ranking_2012, n_2012)

age_ranking_2010_2011 <- merge(x = age_standardized_ranking_2010, y = age_standardized_ranking_2011, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking_2013 <- merge(x = age_ranking_2010_2011, y = age_standardized_ranking_2012, by = "COUNTRY_ISO3", all = TRUE)
age_standardized_ranking_2013[is.na(age_standardized_ranking_2013)] <- 0

age_standardized_ranking_2013 <- age_standardized_ranking_2013 %>% 
  mutate(AS_score = (AS_score_2010*n_2010 + AS_score_2011*n_2011 + AS_score_2012*n_2012)/(n_2010+n_2011+n_2012))
age_standardized_ranking_2013 <- age_standardized_ranking_2013 %>% 
  dplyr::select(COUNTRY_ISO3, AS_score)

WHR_data_2013 <- read.table(header=TRUE, text=
"Country Region Ladder Social_support Freedom Corruption Donation Generosity Positive_affect Negative_affect Happiness_yesterday GDP_per_capita Healthy_life_expectancy
Afghanistan 4 4.040 0.525 0.540 0.755 0.348 0.207 0.663 0.270 0.721 979 36.535
Albania 1 5.550 0.759 0.553 0.827 0.112 -0.192 0.627 0.276 0.568 7652 61.417
Algeria 8 5.422 0.831 0.551 0.681 0.106 -0.194 0.567 0.245 0.542 7547 61.722
Angola 9 5.589 0.723 0.584 0.912 0.322 0.046 0.659 0.361 0.708 5172 34.601
Argentina 6 6.562 0.906 0.764 0.810 0.199 -0.150 0.847 0.238 0.813 14379 65.543
Armenia 2 4.316 0.681 0.476 0.915 0.079 -0.194 0.501 0.450 0.488 4941 61.453
Australia 7 7.350 0.955 0.937 0.362 0.715 0.303 0.820 0.210 0.863 34571 72.948
Austria 0 7.369 0.929 0.913 0.642 0.532 0.119 0.810 0.153 0.890 35211 72.148
Azerbaijan 2 4.604 0.725 0.546 0.810 0.188 -0.127 0.539 0.265 0.455 8796 58.205
Bahrain 8 5.312 0.901 0.828 0.508 0.366 -0.012 0.591 0.459 0.577 21693 64.405
Bangladesh 4 4.804 0.580 0.707 0.767 0.161 -0.025 0.691 0.215 0.702 1523 54.965
Belarus 2 5.504 0.910 0.667 0.688 0.145 -0.194 0.538 0.213 0.437 12438 61.319
Belgium 0 6.967 0.932 0.848 0.724 0.384 -0.024 0.828 0.235 0.821 32789 71.550
Benin 9 3.528 0.500 0.771 0.829 0.066 -0.118 0.604 0.225 0.543 1425 45.280
Bolivia 6 5.857 0.802 0.784 0.813 0.218 -0.046 0.770 0.373 0.773 4365 55.439
Bosnia_and_Herzegovina 1 4.813 0.759 0.372 0.939 0.236 -0.067 0.554 0.358 0.592 7487 64.455
Botswana 9 3.970 0.854 0.813 0.815 0.115 -0.224 0.734 0.168 0.732 12426 36.168
Brazil 6 6.849 0.904 0.829 0.646 0.252 -0.070 0.794 0.288 0.853 9942 60.500
Bulgaria 1 3.981 0.846 0.599 0.945 0.154 -0.179 0.550 0.246 0.456 11567 66.051
Burkina_Faso 9 4.259 0.742 0.645 0.734 0.093 -0.075 0.571 0.240 0.497 1124 36.653
Burundi 9 3.706 0.422 0.490 0.677 0.048 -0.066 0.689 0.190 0.683 524 36.291
Cambodia 3 4.067 0.673 0.941 0.852 0.535 0.327 0.798 0.361 0.814 1977 48.873
Cameroon 9 4.420 0.747 0.792 0.881 0.185 -0.026 0.607 0.276 0.576 2050 42.807
Canada 7 7.477 0.942 0.932 0.437 0.653 0.247 0.872 0.236 0.911 35294 72.082
Central_African_Republic 9 3.623 0.435 0.735 0.839 0.110 -0.024 0.524 0.267 0.477 702 39.560
Chad 9 4.056 0.742 0.536 0.873 0.167 -0.010 0.554 0.297 0.515 1292 41.886
Chile 6 6.587 0.844 0.740 0.744 0.479 0.129 0.809 0.302 0.792 14527 67.878
China 5 4.978 0.782 0.812 0.808 0.115 -0.186 0.808 0.153 0.785 6993 64.726
Colombia 6 6.416 0.904 0.818 0.843 0.257 -0.055 0.836 0.281 0.831 8536 62.697
Comoros 9 3.851 0.721 0.518 0.720 0.146 -0.013 0.668 0.184 0.681 985 55.732
Congo_Brazzaville 9 4.297 0.634 0.771 0.822 0.100 -0.154 0.590 0.300 0.491 3831 47.308
Congo_Kinshasa 9 4.578 0.757 0.594 0.843 0.085 0.006 0.625 0.219 0.576 323 37.797
Costa_Rica 6 7.257 0.903 0.912 0.802 0.341 0.015 0.886 0.251 0.881 10440 67.385
Croatia 1 5.661 0.788 0.541 0.957 0.123 -0.234 0.608 0.267 0.614 15996 67.409
Cyprus 0 6.466 0.820 0.745 0.846 0.500 0.109 0.771 0.301 0.737 25909 68.041
Czech_Republic 1 6.290 0.924 0.771 0.942 0.287 -0.097 0.623 0.249 0.475 23492 69.322
Denmark 0 7.693 0.963 0.937 0.176 0.629 0.222 0.776 0.179 0.647 32333 71.228
Djibouti 9 4.690 0.633 0.755 0.557 0.130 -0.084 0.579 0.181 0.673 2087 44.038
Dominican_Republic 6 4.963 0.870 0.837 0.768 0.264 -0.046 0.798 0.293 0.835 8308 60.201
Ecuador 6 5.865 0.814 0.779 0.745 0.191 -0.110 0.845 0.275 0.837 7303 62.470
Egypt 8 4.273 0.750 0.527 0.878 0.155 -0.126 0.532 0.364 0.522 5513 59.792
El_Salvador 6 5.809 0.765 0.700 0.724 0.151 -0.136 0.840 0.335 0.839 5979 60.144
Estonia 1 5.426 0.899 0.716 0.751 0.181 -0.182 0.649 0.202 0.558 17434 66.911
Ethiopia 9 4.561 0.659 0.776 0.918 0.103 -0.054 0.668 0.137 0.732 979 43.343
Finland 0 7.389 0.934 0.924 0.356 0.459 0.055 0.801 0.203 0.857 31257 72.409
France 0 6.764 0.935 0.859 0.623 0.271 -0.137 0.770 0.262 0.768 29571 72.693
Gabon 9 4.114 0.694 0.670 0.835 0.111 -0.235 0.532 0.265 0.456 13804 52.727
Georgia 2 4.187 0.525 0.616 0.375 0.032 -0.235 0.525 0.246 0.527 4564 64.930
Germany 0 6.672 0.942 0.894 0.678 0.451 0.046 0.799 0.168 0.865 34056 73.065
Ghana 9 5.091 0.716 0.808 0.854 0.263 0.075 0.762 0.182 0.800 1511 50.926
Greece 0 5.435 0.844 0.462 0.954 0.059 -0.326 0.602 0.322 0.471 23864 72.060
Guatemala 6 5.965 0.810 0.774 0.835 0.330 0.067 0.852 0.291 0.851 4309 58.208
Guinea 9 3.847 0.570 0.721 0.770 0.190 0.032 0.689 0.272 0.648 986 46.641
Haiti 6 4.341 0.623 0.422 0.765 0.407 0.245 0.592 0.274 0.634 1030 44.413
Honduras 6 5.142 0.782 0.712 0.867 0.301 0.053 0.820 0.288 0.813 3528 59.360
Hong_Kong 5 5.523 0.842 0.888 0.278 0.661 0.235 0.721 0.188 0.798 42689 70.062
Hungary 1 4.775 0.898 0.572 0.953 0.227 -0.134 0.650 0.285 0.635 16987 66.325
Iceland 0 7.355 0.978 0.898 0.747 0.651 0.240 0.900 0.157 0.907 34636 73.587
India 4 4.772 0.554 0.710 0.855 0.259 0.022 0.649 0.270 0.667 3073 54.588
Indonesia 3 5.348 0.827 0.779 0.963 0.690 0.410 0.877 0.235 0.859 3968 59.300
Iran 8 4.643 0.596 0.601 0.873 0.510 0.184 0.602 0.488 0.609 10462 58.350
Iraq 8 4.817 0.763 0.360 0.828 0.200 -0.033 0.472 0.489 0.454 3290 57.881
Ireland 0 7.076 0.971 0.903 0.595 0.749 0.335 0.859 0.209 0.895 35902 71.406
Israel 8 7.301 0.893 0.657 0.888 0.524 0.133 0.694 0.355 0.713 25988 68.155
Italy 0 6.021 0.881 0.611 0.923 0.401 0.032 0.648 0.320 0.581 27000 73.643
Jamaica 6 5.374 0.855 0.796 0.914 0.219 -0.079 0.836 0.237 0.834 7001 65.934
Japan 5 6.064 0.908 0.780 0.727 0.284 -0.118 0.789 0.178 0.786 30478 75.134
Jordan 8 5.414 0.867 0.747 0.739 0.175 -0.103 0.599 0.311 0.610 5255 61.415
Kazakhstan 2 5.671 0.900 0.835 0.835 0.134 -0.195 0.710 0.163 0.654 10934 57.843
Kenya 9 4.403 0.828 0.658 0.918 0.245 0.057 0.762 0.182 0.771 1479 46.546
Kosovo 1 5.222 0.742 0.560 0.946 0.341 0.038 0.662 0.114 0.574 7487 58.926
Kuwait 8 6.515 0.886 0.776 0.522 0.381 -0.050 0.781 0.163 0.751 46086 67.360
Kyrgyzstan 2 5.042 0.878 0.724 0.921 0.123 -0.088 0.674 0.152 0.657 2069 56.342
Laos 3 4.787 0.692 0.882 0.582 0.586 0.365 0.908 0.305 0.909 2388 48.268
Latvia 1 5.046 0.844 0.564 0.924 0.326 -0.021 0.562 0.227 0.418 13900 65.267
Lebanon 8 4.931 0.723 0.652 0.899 0.355 0.016 0.536 0.332 0.557 12465 61.059
Lesotho 9 4.898 0.824 0.618 0.769 0.096 -0.089 0.793 0.170 0.796 1448 40.358
Liberia 9 4.196 0.812 0.846 0.829 0.113 0.007 0.582 0.225 0.613 473 37.184
Libya 8 5.340 0.836 0.643 0.787 0.399 0.232 0.645 0.301 0.631 15361 64.113
Lithuania 1 5.426 0.904 0.529 0.963 0.121 -0.236 0.540 0.275 0.462 16154 65.797
Luxembourg 0 7.054 0.934 0.929 0.384 0.542 0.082 0.820 0.215 0.860 68312 72.839
Macedonia 1 4.574 0.756 0.578 0.886 0.230 -0.088 0.598 0.366 0.664 9292 62.855
Madagascar 9 3.966 0.746 0.516 0.878 0.094 -0.055 0.599 0.214 0.448 861 49.479
Malawi 9 4.113 0.608 0.685 0.869 0.254 0.112 0.764 0.235 0.771 785 37.253
Malaysia 3 5.760 0.817 0.820 0.847 0.351 0.006 0.862 0.174 0.882 13626 64.213
Mali 9 4.247 0.790 0.759 0.773 0.100 -0.056 0.745 0.134 0.712 957 38.648
Malta 0 5.964 0.918 0.849 0.849 0.680 0.299 0.726 0.369 0.809 22697 73.487
Mauritania 9 4.758 0.780 0.592 0.735 0.272 0.057 0.771 0.161 0.804 2186 45.232
Mauritius 9 5.477 0.800 0.848 0.849 0.517 0.179 0.738 0.253 0.732 12283 61.622
Mexico 6 7.088 0.809 0.796 0.669 0.249 -0.094 0.800 0.250 0.819 12520 66.225
Moldova 2 5.791 0.848 0.610 0.950 0.204 -0.028 0.573 0.292 0.526 2791 60.361
Mongolia 5 4.834 0.924 0.673 0.937 0.393 0.140 0.698 0.161 0.753 3756 56.603
Montenegro 1 5.299 0.775 0.520 0.732 0.115 -0.210 0.590 0.389 0.691 10184 62.609
Morocco 8 4.885 0.730 0.675 0.866 0.074 -0.189 0.671 0.239 0.654 4264 60.865
Mozambique 9 4.971 0.818 0.639 0.719 0.102 -0.043 0.592 0.243 0.644 823 38.211
Myanmar 3 4.439 0.612 0.691 0.695 0.856 0.676 0.764 0.205 0.750 1325 54.795
Nepal 4 4.156 0.747 0.580 0.907 0.236 0.076 0.711 0.224 0.739 1087 52.790
Netherlands 0 7.512 0.945 0.908 0.378 0.728 0.312 0.859 0.205 0.844 36854 72.338
New_Zealand 7 7.221 0.951 0.918 0.273 0.658 0.271 0.860 0.216 0.910 24478 71.115
Nicaragua 6 5.507 0.853 0.807 0.738 0.239 -0.004 0.800 0.277 0.772 3270 62.470
Niger 9 4.152 0.724 0.777 0.614 0.077 -0.050 0.683 0.145 0.707 639 36.664
Nigeria 9 5.248 0.812 0.660 0.907 0.264 0.050 0.797 0.194 0.829 2160 42.953
North_Cyprus 0 5.463 0.871 0.693 0.871 0.436 0.045 0.709 0.405 0.790 25909 68.041
Norway 0 7.655 0.942 0.947 0.421 0.498 0.063 0.823 0.213 0.749 48071 72.492
Oman 8 6.853 0.852 0.916 0.451 0.394 0.007 NA 0.295 0.893 24559 61.685
Pakistan 4 5.292 0.542 0.368 0.854 0.385 0.163 0.655 0.345 0.682 2405 53.735
Palestine 8 4.700 0.778 0.523 0.747 0.103 -0.103 0.599 0.383 0.600 1924 61.203
Panama 6 7.143 0.900 0.789 0.842 0.345 0.005 0.880 0.177 0.898 12779 66.552
Paraguay 6 5.779 0.896 0.714 0.774 0.445 0.178 0.834 0.193 0.755 4535 62.655
Peru 6 5.776 0.777 0.744 0.861 0.202 -0.109 0.779 0.353 0.776 8514 61.715
Philippines 3 4.985 0.805 0.901 0.788 0.304 0.054 0.864 0.339 0.913 3550 60.298
Poland 1 5.822 0.937 0.818 0.904 0.327 -0.034 0.747 0.240 0.640 17178 66.591
Portugal 0 5.101 0.862 0.772 0.954 0.247 -0.131 0.734 0.295 0.779 21471 70.877
Qatar 8 6.666 0.845 0.918 0.140 0.560 0.096 0.763 0.324 0.833 72892 66.013
Romania 1 5.033 0.727 0.620 0.966 0.226 -0.103 0.565 0.327 0.470 10864 64.386
Russia 2 5.464 0.901 0.615 0.941 0.060 -0.288 0.599 0.171 0.484 14103 59.729
Rwanda 9 3.715 0.603 0.832 0.115 0.131 -0.035 0.684 0.143 0.708 1105 39.229
Saudi_Arabia 8 6.480 0.852 0.624 0.451 0.301 -0.074 0.702 0.251 0.689 20546 62.183
Senegal 9 3.959 0.691 0.695 0.857 0.102 -0.096 0.764 0.179 0.775 1730 48.976
Serbia 1 4.813 0.773 0.455 0.964 0.152 -0.169 0.531 0.399 0.614 9634 62.551
Sierra_Leone 9 4.318 0.797 0.748 0.884 0.156 0.000 0.480 0.295 0.518 949 29.616
Singapore 3 6.546 0.884 0.834 0.075 0.350 -0.086 0.542 0.138 0.572 49219 71.110
Slovakia 1 5.969 0.921 0.663 0.908 0.316 -0.057 0.653 0.289 0.589 20130 67.308
Slovenia 1 6.060 0.924 0.902 0.874 0.366 -0.022 0.660 0.288 0.733 24943 70.585
Somaliland 9 4.847 0.798 0.823 0.398 0.443 0.285 0.750 0.120 0.794 979 43.343
South_Africa 9 4.963 0.897 0.689 0.821 0.132 -0.188 0.770 0.178 0.741 9552 45.275
South_Korea 5 6.267 0.800 0.659 0.819 0.334 -0.057 0.661 0.178 0.608 26789 69.235
Spain 0 6.322 0.942 0.781 0.842 0.272 -0.110 0.740 0.353 0.804 26972 73.647
Sri_Lanka 4 4.151 0.826 0.790 0.793 0.474 0.199 0.844 0.183 0.848 4689 61.951
Sudan 9 4.401 0.818 0.570 0.727 0.173 -0.036 0.604 0.241 0.606 1999 49.413
Suriname 6 6.269 0.797 0.885 0.751 0.250 -0.051 0.764 0.250 0.656 7378 61.977
Swaziland 9 4.867 0.837 0.607 0.920 0.200 -0.079 0.821 0.251 0.815 5338 40.925
Sweden 0 7.480 0.940 0.930 0.226 0.544 0.134 0.834 0.183 0.791 33869 74.213
Switzerland 0 7.650 0.943 0.918 0.319 0.550 0.129 0.859 0.176 0.907 39476 73.561
Syria 8 3.892 0.655 0.550 0.731 0.364 0.051 0.545 0.501 0.510 4714 61.940
Taiwan 5 6.221 0.840 0.712 0.803 0.413 0.009 0.831 0.129 0.815 30463 66.579
Tajikistan 2 4.380 0.746 0.769 0.685 0.139 -0.067 0.686 0.185 0.751 1945 55.420
Tanzania 9 3.770 0.842 0.637 0.857 0.276 0.098 0.720 0.162 0.708 1291 48.695
Thailand 3 6.371 0.899 0.870 0.918 0.738 0.435 0.886 0.143 0.936 7526 60.477
Togo 9 2.936 0.303 0.584 0.840 0.069 -0.084 0.480 0.395 0.362 902 46.133
Trinidad_and_Tobago 6 6.519 0.863 0.775 0.904 0.438 0.055 0.906 0.134 0.907 23172 62.805
Tunisia 8 4.826 0.705 0.598 0.846 0.116 -0.194 0.590 0.280 0.571 8351 62.922
Turkey 8 5.345 0.741 0.475 0.710 0.126 -0.214 0.640 0.344 0.707 12789 62.912
Turkmenistan 2 5.628 0.955 0.786 0.597 0.235 -0.071 0.612 0.120 0.596 7831 54.837
Uganda 9 4.443 0.866 0.728 0.843 0.201 0.032 0.693 0.257 0.710 1152 44.821
Ukraine 2 5.057 0.880 0.542 0.934 0.087 -0.200 0.558 0.213 0.470 6052 61.601
Ukraine 2 5.057 0.880 0.542 0.934 0.087 -0.200 0.558 0.213 0.470 6052 61.601
United_Arab_Emirates 8 7.144 0.878 0.895 0.355 0.472 0.044 0.765 0.223 0.764 43295 64.545
United_Kingdom 0 6.883 0.947 0.887 0.448 0.744 0.339 0.845 0.180 0.873 32797 71.645
United_States 7 7.082 0.917 0.834 0.698 0.621 0.191 0.844 0.254 0.877 42068 69.689
Uruguay 6 6.355 0.883 0.852 0.537 0.273 -0.066 0.800 0.232 0.750 12538 66.434
Uzbekistan 2 5.623 0.920 0.924 0.597 0.226 -0.005 0.783 0.131 0.786 2756 60.176
Venezuela 6 7.039 0.931 0.780 0.755 0.136 -0.196 0.849 0.168 0.808 11182 65.104
Vietnam 3 5.533 0.809 0.841 0.766 0.211 -0.024 0.613 0.213 0.637 2905 62.188
Yemen 8 4.054 0.683 0.668 0.836 0.080 -0.142 0.518 0.281 0.551 2235 50.780
Zambia 9 5.006 0.822 0.726 0.846 0.211 0.027 0.780 0.227 0.792 1416 37.099
Zimbabwe 9 4.827 0.873 0.590 0.842 0.094 0.018 0.733 0.170 0.728 309 37.143")

WHR_data_2013 <- WHR_data_2013 %>% 
  dplyr::select(Country, Ladder)

WHR_data_2013$COUNTRY_ISO3 <- countrycode(WHR_data_2013$Country, 'country.name', 'iso3c') 
WHR_data_2013$COUNTRY_ISO3[WHR_data_2013$Country == "Kosovo"] <- "XKX"
WHR_data_2013$COUNTRY_ISO3[WHR_data_2013$Country == "Somaliland"] <- "XS"
WHR_data_2013$COUNTRY_ISO3[WHR_data_2013$Country == "South_Korea"] <- "KOR"

WHR_AS_comparison_2013 <- merge(WHR_data_2013, age_standardized_ranking_2013)

comparison_2013_2023 <- merge(WHR_AS_comparison, WHR_AS_comparison_2013, by="COUNTRY_ISO3")
notable_countries <- comparison_2013_2023 %>% 
  filter(WHR_score > Ladder & AS_score.x < AS_score.y) %>% 
  dplyr::select(COUNTRY_ISO3, COUNTRY_NAME, WHR_score, AS_score.x, Ladder, AS_score.y)
colnames(notable_countries) <- c("COUNTRY_ISO3", "COUNTRY_NAME", "WHR_2023", "AS_2023", "WHR_2013", "AS_2013")

notable_countries <- notable_countries %>% 
  mutate(WHR_diff = WHR_2023 - WHR_2013,
         AS_diff = AS_2023 - AS_2013,
         diff_of_diff = WHR_diff - AS_diff)
```

Summarizing Changing from WHR to AS
```{r}
mean(abs(WHR_AS_comparison$rank_difference))
mean(abs(WHR_AS_comparison$score_difference))

significant_changes_in_rank <- WHR_AS_comparison %>% 
  filter(abs(rank_difference) >= 10) %>% 
  dplyr::select(COUNTRY_ISO3, COUNTRY_NAME, WHR_score, AS_score, rank_difference, score_difference)
```

