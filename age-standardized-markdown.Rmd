---
title: "age-standardized-markdown"
output: html_document
date: "2023-10-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plm)
library(countrycode)
library(ggalluvial)
```

**Replicating World Happiness Report 2023, Chapter 2**
Reading WHR Data
```{r}
WHR_data <- read.csv("/Users/makototakahara/Downloads/WHR2023Table.csv")

WHR_summary <- WHR_data %>% filter(year >= 2020, year <= 2022)%>% 
  group_by(Country.name) %>% 
  summarize(Life.Ladder = mean(Life.Ladder, na.rm = TRUE),
            Log.GDP.per.capita = mean(Log.GDP.per.capita, na.rm = TRUE),
            Social.support = mean(Social.support, na.rm = TRUE),
            Healthy.life.expectancy.at.birth = mean(Healthy.life.expectancy.at.birth, na.rm = TRUE),
            Freedom.to.make.life.choices = mean(Freedom.to.make.life.choices, na.rm = TRUE),
            Generosity = mean(Generosity, na.rm = TRUE),
            Perceptions.of.corruption = mean(Perceptions.of.corruption, na.rm = TRUE))
```

Regression of Life Ladder to 6 predictors
```{r}
regression_data <- WHR_data %>%
  filter(!is.na(Life.Ladder),
         !is.na(Log.GDP.per.capita),
         !is.na(Social.support),
         !is.na(Healthy.life.expectancy.at.birth),
         !is.na(Freedom.to.make.life.choices),
         !is.na(Generosity),
         !is.na(Perceptions.of.corruption))

WHR_regression <- plm(Life.Ladder ~ Log.GDP.per.capita+Social.support+
                        Healthy.life.expectancy.at.birth+Freedom.to.make.life.choices+
                        Generosity+Perceptions.of.corruption, data = regression_data,
                      index = c("year","Country.name"), model="within")
```

Calculating Venezula's Log GDP per capita
```{r}
gdp_contributions <- c(1.888380408, 1.949405551, 1.925507665, 1.833397985, 1.942273855, 1.920950174, 1.994439602, 2.021803141, 2.199664354, 1.841704249, 1.926718116, 1.898795009, 1.881438851, 2.152112246, 1.980279803, 1.919438958, 1.906878233, 1.823468804, 1.856903434, 1.807981849, 1.855644822, 1.815317154, 1.586957693, 1.725929260, 2.167941332, 2.015041590, 1.617422104, 1.731086135, 1.860922694, 1.798477411, 1.798105359, 1.831728816, 1.374470234, 1.645203710, 1.550388217, 1.841345787, 1.713736892, 1.766774416, 1.108565807, 1.737142801, 1.882560015, 1.287179708, 1.663887262, 1.551958442, 1.823535442, 1.825132132, 1.726533294, 1.454480886, 1.277642131, 1.754487276, 1.589547515, 1.114858866, 1.227176905, 1.664970160, 1.758063197, 1.852753997, 1.707674265, 1.588978410, 1.515194416, 1.379249096, 1.061276436, 1.424565315, 1.510386109, 1.348590732, 1.428491592, 1.537114263, 1.304714680, 1.240158796, 1.679553747, 1.466522813, 1.455285072, 1.536397338, 1.342591405, 1.389684558, 1.238053203, 1.635417581, 0.978851676, 1.466145873, 0.971865714, 1.353351712, 1.950940251, 1.449203372, 1.383815885, 1.416947603, 0.921178162, 1.497870803, 1.232199073, 1.477461338, 0.844172418, 1.358194232, 1.093752742, 1.438447475, 1.064864993, 0.964770198, 0.570097387, 1.280983448, 1.236021280, 1.464571595, 0.942726910, 1.098963261, 0.767502248, 1.288983583, 1.714365840, 1.100695729, 1.080818176, 0.561017454, 1.333035707, 1.051386952, 1.421779513, 0.785096049, 0.622039676, 1.025035024, 0.924076915, 1.031916738, 1.132664084, 0.760724187, 0.763360739, 1.377242088, 0.769851625, 1.292441964, 0.793330133, 0.627642870, 1.159242749, 0.632469475, 0.913520396, 0.835894883, 0.913785815, 0.636526823, 1.471394062, 0.530779243, 0.758278608, 0.669698656, 1.416998625, 0.644599795)

gdp_values <- WHR_summary %>% arrange(desc(Life.Ladder)) %>% 
  select(Log.GDP.per.capita) %>% 
  drop_na()
gdp_values <- pull(gdp_values, Log.GDP.per.capita)


venezuela_gdp_values_calculator <- function(vec1, vec2){
  n <- length(vec1)
  bruh <- c()
  for (i in 1:n){
    lol <- vec2[i] - (vec1[i]/0.3586569)
    bruh <- c(bruh, lol)
  }
  return(bruh)
}

venezuela_gdp_values <- venezuela_gdp_values_calculator(gdp_contributions, gdp_values)
Venezuela_GDP <- mean(venezuela_gdp_values)
```


Creating Dystopia
```{r}
WHR_summary <- rbind(WHR_summary, data.frame(Country.name="Dystopia", Life.Ladder=NA, Log.GDP.per.capita=NA, 
                                             Social.support=NA, Healthy.life.expectancy.at.birth=NA, 
                                             Freedom.to.make.life.choices=NA, Generosity=NA, 
                                             Perceptions.of.corruption=NA))

WHR_summary[WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"] <-
  Venezuela_GDP 
WHR_summary[WHR_summary$Country.name=="Dystopia", "Social.support"] <-
  min(WHR_summary$Social.support, na.rm = TRUE)
WHR_summary[WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"] <-
  min(WHR_summary$Healthy.life.expectancy.at.birth, na.rm = TRUE)
WHR_summary[WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"] <-
  min(WHR_summary$Freedom.to.make.life.choices, na.rm = TRUE)
WHR_summary[WHR_summary$Country.name=="Dystopia", "Generosity"] <-
  min(WHR_summary$Generosity, na.rm = TRUE)
WHR_summary[WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"] <-
  max(WHR_summary$Perceptions.of.corruption, na.rm = TRUE)
```

Impute missing data
```{r}
WHR_summary[WHR_summary$Country.name=="State of Palestine", "Log.GDP.per.capita"] <- 
  (1.144)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Log.GDP.per.capita"] <-
  (1.897)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Venezuela", "Log.GDP.per.capita"] <-
  (0)/(summary(WHR_regression)$coefficients["Log.GDP.per.capita", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Log.GDP.per.capita"])

WHR_summary[WHR_summary$Country.name=="Hong Kong S.A.R. of China", "Healthy.life.expectancy.at.birth"] <-
  (0.702)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Kosovo", "Healthy.life.expectancy.at.birth"] <-
  (0.372)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Healthy.life.expectancy.at.birth"] <-
  (0.292)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Healthy.life.expectancy.at.birth"] <-
  (0.492)/(summary(WHR_regression)$coefficients["Healthy.life.expectancy.at.birth", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Healthy.life.expectancy.at.birth"])

WHR_summary[WHR_summary$Country.name=="Tajikistan", "Freedom.to.make.life.choices"] <-
  (0.599)/(summary(WHR_regression)$coefficients["Freedom.to.make.life.choices", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Freedom.to.make.life.choices"])

WHR_summary[WHR_summary$Country.name=="Venezuela", "Generosity"] <-
  (0.205)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="State of Palestine", "Generosity"] <-
  (0.065)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="Taiwan Province of China", "Generosity"] <-
  (0.067)/(summary(WHR_regression)$coefficients["Generosity", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Generosity"])

WHR_summary[WHR_summary$Country.name=="Saudi Arabia", "Perceptions.of.corruption"] <-
  (0.170)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="Bahrain", "Perceptions.of.corruption"] <-
  (0.138)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="China", "Perceptions.of.corruption"] <-
  (0.145)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])

WHR_summary[WHR_summary$Country.name=="United Arab Emirates", "Perceptions.of.corruption"] <-
  (0.247)/(summary(WHR_regression)$coefficients["Perceptions.of.corruption", "Estimate"]) + as.numeric(WHR_summary[
    WHR_summary$Country.name=="Dystopia", "Perceptions.of.corruption"])
```

Construct WHR Ranking
```{r}
distance_from_dystopia <- cbind(WHR_summary %>% 
                                  select(Country.name) %>% 
                                  filter(Country.name != "Dystopia"),
                                (WHR_summary[1:137, 3:8] - WHR_summary[rep(138, 137), 3:8]))

WHR_ranking <- distance_from_dystopia$Country.name
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[2] * coef(summary(WHR_regression))[1,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[3] * coef(summary(WHR_regression))[2,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[4] * coef(summary(WHR_regression))[3,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[5] * coef(summary(WHR_regression))[4,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[6] * coef(summary(WHR_regression))[5,1])
WHR_ranking <- cbind(WHR_ranking, distance_from_dystopia[7] * coef(summary(WHR_regression))[6,1])
WHR_ranking$sum <- apply(WHR_ranking[,-1], 1, sum) 

WHR_ranking <- data.frame(cbind(WHR_ranking, WHR_score = WHR_summary[1:137,]$Life.Ladder))
WHR_ranking$residual <- WHR_ranking$WHR_score - WHR_ranking$sum
WHR_ranking <- WHR_ranking %>% 
  select(!sum)
WHR_ranking <- WHR_ranking[,c(1, 8, 2, 3, 4, 5, 6, 7, 9)]
```

**Age-standardized Well-being Rankings**
```{r}

```

